---
title: "è„†å¼±æ€§ã‹ã‚‰å­¦ã¶Railsã®ä»•çµ„ã¿(CVE-2022-23633ç·¨)"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ruby", "rails"]
published: false
---

# è„†å¼±æ€§ã‹ã‚‰å­¦ã¶Railsã®ä»•çµ„ã¿(CVE-2022-23633ç·¨)
å°‘ã—å‰ã«ã‚„ã£ãŸ[è„†å¼±æ€§ã‹ã‚‰Rubyã®ä»•çµ„ã¿ã‚’å­¦ã¶ã‚„ã¤](https://zenn.dev/0kate/articles/9872322bb93a58)ã‚’`Rails`ã§ã‚‚ã‚„ã£ã¦ã¿ã‚‹è¨˜äº‹ã€‚
å‰å›åŒæ§˜ã€Œè„†å¼±æ€§ã®åŸç†ã‚’æŠŠæ¡ã™ã‚‹ã€ã¨ã„ã†å´é¢ã‹ã‚‰ã€å®Ÿéš›ã«è„†å¼±æ€§ã‚’è©¦ã—ã¤ã¤ã€Œãã®æœ¬ä½“ã®ä»•çµ„ã¿ã€ã‚‚å­¦ã‚“ã§ã—ã¾ãŠã†ã¨ã„ã†è¶£æ—¨ã€‚
`Rails`ã‚‚æ¥­å‹™ã§ä½¿ã†ã‚ˆã†ã«ãªã£ãŸã®ã§ã€ã“ã‚Œã‚‚ã¡ã‚ƒã‚“ã¨å­¦ã‚“ã§ã¿ã‚ˆã†ã¨æ€ã†ã€‚

# å¯¾è±¡ã®èª­è€…
ã“ã®è¨˜äº‹ã®å¯¾è±¡ã¨ãªã‚‹äººã¯ã“ã‚“ãªæ„Ÿã˜ã§æƒ³å®šã€‚
- `Rails`ã‚’ä½¿ã„å§‹ã‚ãŸã°ã‹ã‚Šã§ä»•çµ„ã¿ã‹ã‚‰å­¦ã³ãŸã„äºº
- `Rails`ã¯ã‚ˆãä½¿ã£ã¦ã‚‹ã‘ã©ä»•çµ„ã¿ã¯ã‚ˆãã‚ã‹ã‚‰ãªã„ã‹ã‚‰çŸ¥ã‚ŠãŸã„ã¨ã„ã†äºº

è‡ªåˆ†ã®ã‚ˆã†ãª`Rails`å…¥é–€ã—ãŸã¦ãƒ›ãƒ¤ãƒ›ãƒ¤ã®æ–¹ã«ã‚‚å‹‰å¼·ã«ãªã‚Œã°å¬‰ã—ã„ã®ã§ã€è‡ªåˆ†ã®ç†è§£åº¦æ•´ç†ã‚‚å«ã‚ã¦ã€Œ`Action Pack`ã£ã¦ä½•ï¼Ÿã€ã¿ãŸã„ãªèª¬æ˜ã‚’è»½ãã™ã‚‹ç®‡æ‰€ã‚‚ã‚ã‚‹ãŸã‚ãã®è¾ºã¯ã”äº†æ‰¿ãã ã•ã„ã€‚

# Ruby on Rails
ã•ã£ãã‹ã‚‰ã€ŒRailsã€ã‚Œã„ã‚‹ãšã€ã¨è¨€ã£ã¦ã„ã‚‹ã‚‚ã®ã€‚
è¨€ã‚ãšã¨ã—ã‚ŒãŸRubyã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®1ã¤ã€‚
ã€Œ`Rails`ï¼Ÿã‚ãƒ¼ã€ãƒ”ã‚¶ã®ã“ã¨ã­ã€‚ã€ã¨ã„ã†æ–¹ã¯[Wikipedia](https://ja.wikipedia.org/wiki/Ruby_on_Rails)ã‚’å‚ç…§ã€‚

# è„†å¼±æ€§
ã“ã‚Œã¯Rubyã®è¨˜äº‹ã§è¨˜è¼‰ã—ãŸã®ã§å‰²æ„›ã€‚
æ°—ã«ãªã‚‹æ–¹ã¯ä»¥ä¸‹ã® **è„†å¼±æ€§ã‹ã‚‰Rubyã®ä»•çµ„ã¿ã‚’å­¦ã‚“ã è¨˜äº‹** ã‚’å‚ç…§ã€‚
https://zenn.dev/0kate/articles/9872322bb93a58

# CVE-2022-23633
ä»Šå›ã®èª¿æŸ»å¯¾è±¡ã¨ãªã‚‹è„†å¼±æ€§ã€‚
ã“ã®è„†å¼±æ€§ã‚’é¸ã‚“ã ã®ã¯ã€æ¯”è¼ƒçš„æ–°ã—ã‚ã®è„†å¼±æ€§ãªã®ã§èº«è¿‘ã«è¦‹ã‹ã‘ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§ã¯ã¨æ€ã£ãŸã®ã¨ã€å†…å®¹çš„ã«`Action Pack`ã‚ãŸã‚Šã‚’æ˜ã‚Šä¸‹ã’ã‚‹ã“ã¨ã«ãªã‚Šãã†ãªã®ã§ã€`Rails`ã®æ ¹æœ¬çš„ãªéƒ¨åˆ†ã‚’å­¦ã¹ãã†ãªæ°—ãŒã—ãŸã‹ã‚‰ã€‚

[NISTã®è„†å¼±æ€§ã®æ¦‚è¦](https://nvd.nist.gov/vuln/detail/CVE-2022-23633)ã¨ã—ã¦ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚
> Action Pack is a framework for handling and responding to web requests. Under certain circumstances response bodies will not be closed. In the event a response is *not* notified of a `close`, `ActionDispatch::Executor` will not know to reset thread local state for the next request. This can lead to data being leaked to subsequent requests.This has been fixed in Rails 7.0.2.1, 6.1.4.5, 6.0.4.5, and 5.2.6.1. Upgrading is highly recommended, but to work around this problem a middleware described in GHSA-wh98-p28r-vrc9 can be used.

é›‘ã«ç¿»è¨³ã™ã‚‹ã¨ã€ **ç‰¹å®šã®æ¡ä»¶ä¸‹ã§ã€`ActionDispatch::Executor`ã«ã‚ˆã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã®çµ‚äº†å‡¦ç†ãŒã†ã¾ãè¡Œã‚ã‚Œãšã€ä»¥é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚¹ãƒ¬ãƒƒãƒ‰ã®å†…éƒ¨çŠ¶æ…‹ãŒå¼•ãç¶™ãŒã‚Œã¦ã—ã¾ã†** ã‚‚ã®ã‚‰ã—ã„ã€‚

ã•ã‚‰ã«ã€[GitHubã«æ›¸ã„ã¦ã‚ã‚‹è„†å¼±æ€§ã®æ¦‚è¦](https://github.com/rails/rails/security/advisories/GHSA-wh98-p28r-vrc9)ã«ã¯è‹¥å¹²é•ã†è¨˜è¼‰ãŒã‚ã£ã¦ã€ã“ã£ã¡ã®ã»ã†ãŒã‚‚ã£ã¨å…·ä½“çš„ã«æ›¸ã„ã¦ã‚ã‚‹ã€‚
> Under certain circumstances response bodies will not be closed, for example a bug in a webserver or a bug in a Rack middleware. In the event a response is not notified of a close, ActionDispatch::Executor will not know to reset thread local state for the next request. This can lead to data being leaked to subsequent requests, especially when interacting with ActiveSupport::CurrentAttributes.

åŸºæœ¬çš„ãªå†…å®¹ã¯åŒã˜ã ãŒã€ã“ã¡ã‚‰ã«æ›´ã«è¿½åŠ ã§æ›¸ã„ã¦ã‚ã‚‹ã®ãŒ **Webã‚µãƒ¼ãƒãƒ¼ã‚„RackãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ãƒã‚°ã«èµ·å› ã™ã‚‹** ã¨ã„ã†ã®ã¨ **`ActiveSupport::CurrentAttributes`ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ãã¯ç‰¹ã«ãã†ãªã‚‹** ã¨ã„ã†ã“ã¨ã€‚

2ã¤ã‚’ã¾ã¨ã‚ã‚‹ã¨ã€ **Webã‚µãƒ¼ãƒãƒ¼ã‚„RackãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ãƒã‚°ã«ã‚ˆã£ã¦`ActionDispatch::Executor`ã®ã‚¹ãƒ¬ãƒƒãƒ‰çµ‚äº†å‡¦ç†ãŒã†ã¾ãè¡Œã‚ã‚Œãšã€ä»¥é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚¹ãƒ¬ãƒƒãƒ‰ã®å†…éƒ¨çŠ¶æ…‹ãŒå¼•ãç¶™ãŒã‚Œã¦ã—ã¾ã†** ã‚‰ã—ã„ã€‚

ã‚‚ã¡ã‚ã‚“æ—¢ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹æƒ…å ±ã®ãŸã‚ãƒ‘ãƒƒãƒã¯å½“ãŸã£ã¦ã„ã¦ã€`5.2.6.1`/`6.0.4.5`/`6.1.4.5`/`7.0.2.1`ä»¥é™ã®`Rails`ã‚’ä½¿ã£ã¦ã„ã‚Œã°å¤§ä¸ˆå¤«ã€‚

## ãƒ‘ãƒƒãƒã‚’è¦‹ã¦ã¿ã‚‹
ã¾ã å…¨ç„¶ç†è§£ã§ãã¦ã„ãªã„ãŒã€ã¨ã‚Šã‚ãˆãšå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒãƒã‚’è¦‹ã¦ã¿ã‚‹ã€‚
[NISTã®ãƒšãƒ¼ã‚¸ãªã©ã«è²¼ã‚‰ã‚Œã¦ã„ã‚‹ãƒªãƒ³ã‚¯](https://github.com/rails/rails/commit/f9a2ad03943d5c2ba54e1d45f155442b519c75da)ã‹ã‚‰é£›ã¹ã‚‹GitHubä¸Šã®ãƒ‘ãƒƒãƒã¯ã“ã‚Œã€‚
```diff ruby
$ git diff 761a2e25520566d932c41c740b8a5c513d839de8 f9a2ad03943d5c2ba54e1d45f155442b519c75da
diff --git a/activesupport/lib/active_support/reloader.rb b/activesupport/lib/active_support/reloader.rb
index 2f81cd4f80..e751866a27 100644
--- a/activesupport/lib/active_support/reloader.rb
+++ b/activesupport/lib/active_support/reloader.rb
@@ -58,7 +58,7 @@ def self.reload!
       prepare!
     end

-    def self.run! # :nodoc:
+    def self.run!(reset: false) # :nodoc:
       if check!
         super
       else
```
ã“ã®ãƒ‘ãƒƒãƒã¯`ActiveSupport::Reloader#run!`ã«å½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã€‚
ã€Œãˆã€ã“ã‚Œã ã‘ï¼Ÿã€ã¨æ€ã†ã‹ã‚‚ã—ã‚Œãªã„ãŒã€å®Ÿã¯ã“ã®ã‚³ãƒŸãƒƒãƒˆã¯å‰¯æ¬¡çš„ãªã‚‚ã®ã§ã€ã‚‚ã†å°‘ã—ã ã‘å‰ã®ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°ã‚’è¾¿ã‚‹ã¨ãã£ã¡ã«[æœ¬è³ªçš„ãªä¿®æ­£](https://github.com/rails/rails/commit/3c0420c431954d05fef2015a27281069e68cce0c)ãŒåŠ ãˆã‚‰ã‚Œã¦ã„ã‚‹ã€‚
å…¨éƒ¨ã“ã“ã«è¼‰ã›ã‚‹ã«ã¯å°‘ã—ã ã‘é•·ã„ã®ã§ã€é‡è¦ãã†ãªéƒ¨åˆ†ã ã‘æŠœãå‡ºã™ã€‚

```diff ruby
diff --git a/actionpack/lib/action_dispatch/middleware/executor.rb b/actionpack/lib/action_dispatch/middleware/executor.rb
index 85326e313b..1878d64715 100644
--- a/actionpack/lib/action_dispatch/middleware/executor.rb
+++ b/actionpack/lib/action_dispatch/middleware/executor.rb
@@ -9,7 +9,7 @@ def initialize(app, executor)
     end

     def call(env)
-      state = @executor.run!
+      state = @executor.run!(reset: true)
       begin
         response = @app.call(env)
         returned = response << ::Rack::BodyProxy.new(response.pop) { state.complete! }
```
â¬† ã¾ãšã¯æ¦‚è¦åˆ†ã«ã‚‚æ›¸ã‹ã‚Œã¦ã„ãŸ`ActionDispatch::Executor#call`ã®å¤‰æ›´ã€‚
`reset`å¼•æ•°ã«`true`ã‚’æ¸¡ã—ã¦ã„ã‚‹ã€‚å…ˆç¨‹ã®`ActiveSupport::Reloader#run!`ã«åŠ ãˆã‚‰ã‚Œã¦ã„ã‚‹`reset`å¼•æ•°ã¨é–¢ä¿‚ã‚ã‚Šãã†ã€‚

```diff ruby
diff --git a/activesupport/lib/active_support/execution_wrapper.rb b/activesupport/lib/active_support/execution_wrapper.rb
index 87d90839ca..5a4a9b2c60 100644
--- a/activesupport/lib/active_support/execution_wrapper.rb
+++ b/activesupport/lib/active_support/execution_wrapper.rb
@@ -64,18 +64,21 @@ def self.register_hook(hook, outer: false)
     # after the work has been performed.
     #
     # Where possible, prefer +wrap+.
-    def self.run!
-      if active?
-        Null
+    def self.run!(reset: false)
+      if reset
+        lost_instance = IsolatedExecutionState.delete(active_key)
+        lost_instance&.complete!
       else
-        new.tap do |instance|
-          success = nil
-          begin
-            instance.run!
-            success = true
-          ensure
-            instance.complete! unless success
-          end
+        return Null if active?
+      end
+
+      new.tap do |instance|
+        success = nil
+        begin
+          instance.run!
+          success = true
+        ensure
+          instance.complete! unless success
         end
       end
     end
@@ -105,27 +108,20 @@ def self.perform # :nodoc:
       end
     end

-    class << self # :nodoc:
-      attr_accessor :active
-    end
-
     def self.error_reporter
       @error_reporter ||= ActiveSupport::ErrorReporter.new
     end

-    def self.inherited(other) # :nodoc:
-      super
-      other.active = Concurrent::Hash.new
+    def self.active_key # :nodoc:
+      @active_key ||= :"active_execution_wrapper_#{object_id}"
     end

-    self.active = Concurrent::Hash.new
-
     def self.active? # :nodoc:
-      @active[IsolatedExecutionState.unique_id]
+      IsolatedExecutionState.key?(active_key)
     end

     def run! # :nodoc:
-      self.class.active[IsolatedExecutionState.unique_id] = true
+      IsolatedExecutionState[self.class.active_key] = self
       run
     end

@@ -140,7 +136,7 @@ def run # :nodoc:
     def complete!
       complete
     ensure
-      self.class.active.delete(IsolatedExecutionState.unique_id)
+      IsolatedExecutionState.delete(self.class.active_key)
     end

     def complete # :nodoc:
```
â¬† æ¬¡ã¯`ActiveSupport::ExecutionWrapper`ã«åŠ ãˆã‚‰ã‚Œã¦ã„ã‚‹å¤‰æ›´ã€‚
`ActiveSupport::IsolatedExecutionState`ãªã‚‹ã‚‚ã®ãŒå‡ºã¦ãã‚‹ã€‚
ã€Œ`IsolatedExecutionState`ã¨ã‹ã„ã†ã‚¯ãƒ©ã‚¹ã‚’ã€è‡ªåˆ†ã®ã‚¯ãƒ©ã‚¹å¤‰æ•°ã«ä¿å­˜ã€ã‹ã‚‰ã€Œ`IsolatedExecutionState`ã®ã‚¯ãƒ©ã‚¹å¤‰æ•°ã«ã€è‡ªåˆ†è‡ªèº«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜ã€ã«å¤‰ã‚ã£ã¦ã„ã‚‹ï¼Ÿã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚

## Workaround
ã•ã‚‰ã«ã€ã©ã†ã—ã¦ã‚‚ãƒ‘ãƒƒãƒé©ç”¨ç‰ˆã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ããªã„å ´åˆã®ä»£æ›¿ç­–ã‚‚ä¸€å¿œç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€æ¬¡ã®RackãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã§ä¸€å…ˆãšãªã‚“ã¨ã‹ãªã‚‹ã‚‰ã—ã„ã€‚
```ruby
class GuardedExecutor < ActionDispatch::Executor
  def call(env)
    ensure_completed!
    super
  end

  private

    def ensure_completed!
      @executor.new.complete! if @executor.active?
    end
end

# Ensure the guard is inserted before ActionDispatch::Executor
Rails.application.configure do
  config.middleware.swap ActionDispatch::Executor, GuardedExecutor, executor
end
```
`GuardedExecutor#call`ã®ä¸­ã§ã€`ActionDispatch::Executor#call`ã®ç›´å‰ã«`complete!`ã‚’å¿…ãšå‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚
ã©ã†ã‚„ã‚‰ã€ã“ã®`complete!`ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã‹å¦ã‹ãŒè‚ã‚‰ã—ã„ã€‚

# å‰æçŸ¥è­˜
è„†å¼±æ€§ã®æ¦‚è¦ã‚„ãƒ‘ãƒƒãƒãŒç¢ºèªã§ããŸæ‰€ã§å®Ÿéš›ã«ã‚‚ã†å°‘ã—æ·±ãèª¿ã¹ã¦ã„ããŸã„ãŒã€ã“ã“ã¾ã§ã§`ActionDispatch::Executor`ã‚„ã‚‰`ActiveSupport::ExecutionWrapper`ã‚„ã‚‰`ActiveSupport::IsolatedExecutionState`ã‚„ã‚‰`ActiveSupport::CurrentAttributes`ã‚„ã‚‰è‰²ã€…å‡ºã¦ãéãã¦ã„ã¦ã€`Rails`å…¥é–€ã—ãŸã¦äººé–“ã«ã¯è¾›ã„ã‚‚ã®ãŒã‚ã‚‹ãŸã‚ã€å°‘ã—ã ã‘ã“ã®è¾ºã®äº‹å‰çŸ¥è­˜ã«ã¤ã„ã¦èª¿ã¹ã¦ãŠãã€‚

## `Action Pack`
ã¾ãšã¯åŸºæœ¬ãŒå¤§äº‹ã¨ã„ã†ã“ã¨ã§`Action Pack`ã‹ã‚‰ã€‚`Action Dispatch`ã‚‚ã“ã“ã«é–¢ä¿‚ã—ã¦ã„ã‚‹ã€‚
ğŸ“¢ å…¬å¼ã®è¨˜è¼‰ã‚’å™›ã¿ç •ã„ãŸå†…å®¹ãªã®ã§ã€ã“ã‚“ãªã‚‚ã®å¸¸è­˜ã ã¨ã„ã†æ–¹ã¯ã‚¬ãƒ³ã‚¬ãƒ³ã‚¹ã‚­ãƒƒãƒ—æ¨å¥¨ã€‚

### [`Action Pack`](https://github.com/rails/rails/blob/main/actionpack/README.rdoc#action-pack--from-request-to-response-) is ä½•?
`Ruby on Rails`ã¯`MVC`ãƒ‘ã‚¿ãƒ¼ãƒ³ã«æº–æ‹ ã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãªã‚ã‘ã ãŒã€`Action Pack`ã¯ãã®[ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¬ã‚¤ãƒ¤ãƒ¼](https://github.com/rails/rails#controller-layer)ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ã§ã€HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«é–¢ã™ã‚‹è²¬å‹™ã‚’æ‹…ã£ã¦ã„ã‚‹éƒ¨åˆ†ã€‚
`Action Dispatch`/`Action Controller`ã¨ã„ã†2ã¤ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã€‚

#### `Action Dispatch`
> Action Dispatch, which parses information about the web request, handles routing as defined by the user, and does advanced processing related to HTTP such as MIME-type negotiation, decoding parameters in POST, PATCH, or PUT bodies, handling HTTP caching logic, cookies and sessions.

é›‘ã«ç¿»è¨³ã™ã‚‹ã¨ã€ **HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è§£é‡ˆ(ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„ã‚¯ãƒƒã‚­ãƒ¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‡¦ç†ãªã©ã‚‚å«ã‚€)ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®šç¾©ã—ãŸã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«é©åˆ‡ã«å—ã‘æ¸¡ã™** ã€‚
ã“ã†æ›¸ã„ã¦ã‚ã‚‹ãŒã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®å‡¦ç†çµæœã‚’å—ã‘ã¦æˆ»ã™ã®ã‚‚ã“ã“ã®å½¹å‰²ã€‚
RackãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ã—ã¦ã€`Rails`ã®å…¥å£ã‹ã‚‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¾ã§ã®é“ã®ã‚Šã‚’ç¹‹ã„ã§ã„ã‚‹ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ‘ã‚¿ãƒ¼ãƒ³ã¿ãŸã„ãªã‚‚ã®ã€‚

#### `Action Controller`
> Action Controller, which provides a base controller class that can be subclassed to implement filters and actions to handle requests. The result of an action is typically content generated from views.

ã“ã¡ã‚‰ã‚‚é›‘ã«ç¿»è¨³ã™ã‚‹ã¨ã€ **`Action Dispatch`ã‹ã‚‰å—ã‘æ¸¡ã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿéš›ã«å‡¦ç†ã™ã‚‹éƒ¨åˆ†(å‡¦ç†çµæœã¯ãƒ“ãƒ¥ãƒ¼ã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚ŒãŸã‚‚ã®ãŒä¸€èˆ¬çš„)** ã€‚
å®Ÿéš›ã«`Rails`ã‚’ä½¿ã£ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¦ã„ãéš›ã«ã€`app/controllers`ã«`ActionController::Base`ã‚’ç¶™æ‰¿ã—ã¦æ›¸ã„ã¦ã„ãã‚„ã¤ã€‚

## `Executor`
`Rails`ã«ã¯ã€`Executor`ã¨ã„ã† **`Rails`ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æ§‹æˆã™ã‚‹ã‚³ãƒ¼ãƒ‰** ã¨ **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰** ã‚’åˆ†é›¢ã™ã‚‹ã‚‰ã—ã„æ¦‚å¿µãŒå­˜åœ¨ã™ã‚‹ã€‚
`to_run`/`to_complete`ã¨ã„ã†2ç¨®é¡ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å—ã‘å–ã‚Šã€ã€Œ`to_run`ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ â†’ å®Œäº†ã—ãŸã‚‰`to_complete`ã€ã¨ã„ã†é †ç•ªã§å®Ÿè¡Œã™ã‚‹ã€‚

`Rails`å†…éƒ¨ã§ã„ãã¤ã‹å®Ÿéš›ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ã¨ã—ã¦ã¯ä»¥ä¸‹ã€‚
- è‡ªå‹•ãƒ­ãƒ¼ãƒ‰ã‚„ãƒªãƒ­ãƒ¼ãƒ‰ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒå®‰å…¨ãªä½ç½®ã§ç¨¼åƒã—ã¦ã„ã‚‹ã‹ã‚’è¿½è·¡ã™ã‚‹
- Active Recordã®ã‚¯ã‚¨ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹/ç„¡åŠ¹ã™ã‚‹
- Active Recordã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã«ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹
- å†…éƒ¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®åˆ¶é™

è©³ã—ã„èª¬æ˜ã¯ã€[`Rails Guide`](https://guides.rubyonrails.org/threading_and_code_execution.html#executor)ã«æ›¸ã„ã¦ã‚ã‚‹ã€‚

### `ActionDispatch::Executor` / `ActiveSupport::ExecutionWrapper`
è„†å¼±æ€§ã®æ¦‚è¦ã§ã€ã€Œ`ActionDispatch::Executor`ãŒã©ã†ã®ã“ã†ã®ã€ã¨è¨€ã‚ã‚Œã¦ã„ãŸã‚„ã¤ã€‚
å‰è¿°ã®`Executor`ã¨ã€å¾Œç¶šã®RackãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§
å®Ÿæ…‹ã¯[`rails/actionpack/lib/action_dispatch/middleware/executor.rb:7`](https://github.com/rails/rails/blob/8015c2c2cf5c8718449677570f372ceb01318a32/actionpack/lib/action_dispatch/middleware/executor.rb#L7)ã«ã‚ã‚‹ã€‚

`ActiveSupport::ExecutionWrapper`ã¯`ActionDispatch::Executor`ã‹ã‚‰å‘¼ã°ã‚Œã€å®Ÿéš›ã«`Executor`ã¨ã—ã¦æŒ¯ã‚‹èˆã†ã‚¯ãƒ©ã‚¹ã€‚
[`rails/activesuport/lib/active_support/execution_wrapper.rb`](https://github.com/rails/rails/blob/3c0420c431954d05fef2015a27281069e68cce0c/activesupport/lib/active_support/execution_wrapper.rb)ã«ã‚ã‚‹ã€‚
å‰è¿°ã®`Executor`

### `ActiveSupport::Reloader`
åå‰ã®é€šã‚Šã ãŒã€ãƒªãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚’è¡Œã†ã‚¯ãƒ©ã‚¹ã€‚
**ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹** ãªã©ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¹ãã‹ã®åˆ¤å®šå‡¦ç†ã¯ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å¤–éƒ¨ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ã€‚

### `ActiveSupport::IsolatedExecutionState`
[`rails/activesupport/lib/active_support/isolated_execution.rb`](https://github.com/rails/rails/blob/3c0420c431954d05fef2015a27281069e68cce0c/activesupport/lib/active_support/isolated_execution_state.rb)ã«ã‚ã‚‹ã€‚
ã“ã‚Œã‚‚åå‰é€šã‚Šã€ã€Œéš”é›¢ã•ã‚ŒãŸå®Ÿè¡ŒçŠ¶æ…‹ã€ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚
ç¾åœ¨ã®å®Ÿè¡Œå˜ä½(`Thread`ã‚‚ã—ãã¯`Fiber`)ã”ã¨ã«ã€ã‚­ãƒ¼/ãƒãƒªãƒ¥ãƒ¼ã§å€¤ã‚’ä¿å­˜ã•ã›ã‚‰ã‚Œã‚‹ã€‚

### `ActiveSupport::CurrentAttributes`
[`rails/activesupport/lib/active_support/current_attribute.rb`](https://github.com/rails/rails/blob/main/activesupport/lib/active_support/current_attributes.rb)ã«ã‚ã‚‹ã€‚
> Abstract super class that provides a thread-isolated attributes singleton, which resets automatically before and after each request. This allows you to keep all the per-request attributes easily available to the whole system.

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã«ã€çŠ¶æ…‹ã‚’ä¿å­˜ã—ã¦ãŠãç”¨ã®ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚
ä½¿ã„æ–¹ã¯ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ã‚ã‹ã‚Šã‚„ã™ã„ã‚µãƒ³ãƒ—ãƒ«ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’å‚ç…§ã€‚
ã¡ãªã¿ã«ã“ã®[`ActiveSupport::CurrentAttributes#current_instances`](https://github.com/rails/rails/blob/main/activesupport/lib/active_support/current_attributes.rb#L163)ã¯ã€å†…éƒ¨çš„ã«å‰è¿°ã®`IsolatedExecutionState`ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã€‚
```ruby
def current_instances
  IsolatedExecutionState[:current_attributes_instances] ||= {}
end
```

# ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦è©¦ã—ã¦ã¿ã‚‹
ä»Šå›ã‚‚ãƒ‘ãƒƒãƒé©ç”¨å¾Œã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã®ã§ã€ãã‚Œã‚’è¦‹ãªãŒã‚‰å¤‰ãªæŒ™å‹•ã‚’èµ·ã“ã—ãã†ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã‚‹ã€‚
`Rails`æœ¬ä½“ã‹ã‚‰åˆ‡ã‚Šé›¢ã—ã¦ã‚‚å‹•ãã‚ˆã†ã«åˆ†è§£ã—ã¦é›‘ã«æ›¸ãæ›ãˆã€‚
```ruby
require 'action_dispatch/middleware/executor'
require 'active_support/executor'
require 'active_support/isolated_execution_state'

executor = Class.new(ActiveSupport::Executor)

def middleware(inner_app)
  ActionDispatch::Executor.new(inner_app, executor)
end

total = 0
ran = 0
completed = 0

executor.to_run { total += 1; ran += 1 }
executor.to_complete { total += 1; completed += 1 }

stack = middleware(proc { [200, {}, "response"] })

requests_count = 5

requests_count.times do
  stack.call({})
end

puts "requests_count: #{requests_count}"
puts "total         : #{total}"
puts "ran           : #{ran}"
puts "completed     : #{completed}"
```
â¬‡ ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®é€šã‚Šãªã‚‰ã“ã‚“ãªå‡ºåŠ›ãŒæœŸå¾…ã•ã‚Œã‚‹ã€‚
```shell
$ bundle exec ruby ./sample.rb
requests_count: 5
total         : 9
ran           : 5
completed     : 4
```

â¬‡ ã¨ã“ã‚ãŒã€ãƒ‘ãƒƒãƒé©ç”¨å‰ã®`Rails`ã§å®Ÿè¡Œã—ãŸå‡ºåŠ›ã¯ã“ã†ã€‚
```shell
$ bundle exec ruby ./sample.rb
requests_count: 5
total         : 1
ran           : 1
completed     : 0
```
5å›ãƒ«ãƒ¼ãƒ—ã—ã¦ã„ã‚‹ã«ã‚‚é–¢ã‚ã‚‰ãš1å›ã—ã‹`to_run`å‘¼ã°ã‚Œã¦ãªã„ã—ã€`to_complete`ã«é–¢ã—ã¦ã¯1åº¦ã‚‚å‘¼ã°ã‚Œã¦ã‚„ãŒã‚‰ãªã„æ¨¡æ§˜ã€‚

## ãƒ‡ãƒãƒƒã‚¬ã§è¦‹ã¦ã¿ã‚‹
ãªã‚“ã§ã“ã†ãªã‚‹ã®ã‹ãƒ‡ãƒãƒƒã‚¬ã§è¦‹ã¦ã¿ã‚‹ã€‚

ãƒ‡ãƒãƒƒã‚°ã«å½“ãŸã£ã¦ã¯ã€`v7`ç³»ã®`Rails`ãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹[`debug gem`](https://github.com/ruby/debug)ã‚’ä½¿ã£ã¦ã„ãã€‚
èµ·å‹•æ–¹æ³•ã¯ç°¡å˜ã§ã€ãƒ‡ãƒãƒƒã‚°ã‚’é–‹å§‹ã—ãŸã„ä»»æ„ã®å ´æ‰€ã«`debugger`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’åŸ‹ã‚è¾¼ã‚€ã ã‘ã§ã€ãã“ã‚’é€šéã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ‡ãƒãƒƒã‚¬ãŒèµ·å‹•ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
ã‚ã¨ã¯å¥½ããªæ‰€ã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å…¥ã‚ŒãŸã‚Šã™ã‚Œã°ã‚ªãƒƒã‚±ãƒ¼ã€‚
```ruby
require 'action_dispatch/middleware/executor'
require 'active_support/executor'
require 'active_support/isolated_execution_state'
require 'debug'  # ã“ã‚Œã‚’è¿½åŠ 

# (å¤‰ã‚ã‚‰ãªã„ã®ã§çœç•¥)

requests_count.times do
  debugger  # ã¨ã‚Šã‚ãˆãšã“ã®è¾ºã«å…¥ã‚Œè¾¼ã‚“ã§ã¿ã‚‹
  stack.call({})
end

puts "requests_count: #{requests_count}"
puts "total         : #{total}"
puts "ran           : #{ran}"
puts "completed     : #{completed}"
```

ãƒ‡ãƒãƒƒã‚¬ãŒè‡ªä½“ã®ä½¿ã„æ–¹ã¯ä»Šå›ã¯å‰²æ„›ã™ã‚‹ã®ã§ã€æ°—ã«ãªã‚‹æ–¹ã¯ã“ã‚Œã‚‚[å…¬å¼ã®HOW TO USE](https://github.com/ruby/debug#how-to-use)ã‚’å‚ç…§ã€‚
ã‚³ãƒãƒ³ãƒ‰ã‚»ãƒƒãƒˆãªã©ã¯`gdb`ã®ãã‚Œã‚’è¸è¥²ã—ãŸæ„Ÿã˜ãªã®ã§ã€`gdb`ã‚’ä½¿ãˆã‚‹äººãªã‚‰æ„Ÿè¦šçš„ã«ã„ã‘ã‚‹ã¯ãšã€‚

### ãƒ«ãƒ¼ãƒ—1å‘¨ç›®
ã¾ãšã¯èµ·å‹•ä¸€ç™ºç›®ã®ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ã€‚
```shell
$ bundle exec ruby ./sample.rb
[34, 43] in ./sample.rb
    34| stack = middleware(proc { Current.request_id += 1; [200, {}, "response"] })
    35|
    36| requests_count = 5
    37|
    38| requests_count.times do
=>  39|   debugger
    40|   stack.call({})
    41| end
    42|
    43| puts "requests_count: #{requests_count}"
=>#0	block in <main> at ./sample.rb:39
  #1	[C] Integer#times at ./sample.rb:38
  # and 1 frames (use `bt' command for all frames)
(rdbg) n    # next command
    35|
    37|
    38| requests_count.times do
    39|   debugger
=>  40|   stack.call({})
    41| end
    42|
    43| puts "requests_count: #{requests_count}"
    44| puts "total         : #{total}"
=>#0	block in <main> at ./sample.rb:40
  #1	[C] Integer#times at ./sample.rb:38
  # and 1 frames (use `bt' command for all frames)
(rdbg) s    # step command
[7, 16] in path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.2/lib/action_dispatch/middleware/executor.rb
     7|     def initialize(app, executor)
     9|     end
    10|
    11|     def call(env)
=>  12|       state = @executor.run!
    13|       begin
    14|         response = @app.call(env)
    15|         returned = response << ::Rack::BodyProxy.new(response.pop) { state.complete! }
    16|       rescue => error
=>#0	ActionDispatch::Executor#call(env={}) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.2/lib/action_dispatch/middleware/executor.rb:12
  #1	block in <main> at ./sample.rb:40
  # and 2 frames (use `bt' command for all frames)
(rdbg) s    # step command
[63, 72] in path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/activesupport-7.0.2/lib/active_support/execution_wrapper.rb
    63|     # Returns an instance, whose +complete!+ method *must* be invoked
    65|     #
    66|     # Where possible, prefer +wrap+.
    67|     def self.run!
=>  68|       if active?
    69|         Null
    70|       else
    71|         new.tap do |instance|
    72|           success = nil
=>#0	#<Class:ActiveSupport::ExecutionWrapper>#run! at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/activesupport-7.0.2/lib/active_support/execution_wrapper.rb:68
  #1	ActionDispatch::Executor#call(env={}) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.2/lib/action_dispatch/middleware/executor.rb:12
  # and 3 frames (use `bt' command for all frames)
(ruby) active?
nil
(rdbg) n    # next command
    66|     # Where possible, prefer +wrap+.
    67|     def self.run!
    68|       if active?
    69|         Null
    70|       else
=>  71|         new.tap do |instance|
    72|           success = nil
    73|           begin
    74|             instance.run!
    75|             success = true
=>#0	#<Class:ActiveSupport::ExecutionWrapper>#run! at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/activesupport-7.0.2/lib/active_support/execution_wrapper.rb:71
  #1	ActionDispatch::Executor#call(env={}) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.2/lib/action_dispatch/middleware/executor.rb:12
  # and 3 frames (use `bt' command for all frames)

...

(rdbg)
```
ãƒ‡ãƒãƒƒã‚¬ã®å‡ºåŠ›ã‚’å…¨ã¦è²¼ã‚Šä»˜ã‘ã‚‹ã¨é•·ã„ã®ã§å¤šå°‘å‰Šã‚‹ãŒã€å®Ÿéš›ã«èµ·ã“ã£ã¦ã„ã‚‹ã“ã¨ã¨ã—ã¦ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚
- `ActionDispatch::Executor#call`ã‹ã‚‰ã€`@executor.run!`ãŒå‘¼ã°ã‚Œã‚‹
â¬‡
- `@executor.run!`å†…ã§ã€åˆå›ã¯`active?`ãŒ`false`ã«ãªã‚‹ãŸã‚`to_run`ã«è¨­å®šã—ãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹
â¬‡
- ãã®ã¾ã¾è¿”ã£ã¦ãã¦ç™»éŒ²ã—ãŸãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹
â¬‡
- æ­£å¸¸ã«ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å‡¦ç†ãŒå®Œäº†ã—ã€`to_complete`ãŒå‘¼ã°ã‚Œãªã„
(ã©ã†ã‚„ã‚‰`to_complete`ã¯æ˜ç¤ºçš„ã«å‘¼ã°ãªã„é™ã‚Šã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å‡¦ç†ãŒå¤±æ•—ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‘¼ã°ã‚Œã‚‹ã¿ãŸã„)

### ãƒ«ãƒ¼ãƒ—2å‘¨ç›®ä»¥é™
ç¶šã„ã¦2å‘¨ç›®ã‚‚è¦‹ã¦ã„ãã€‚
èµ·ã“ã£ã¦ã„ã‚‹äº‹è±¡ã¨ã—ã¦ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚(ãƒ‡ãƒãƒƒã‚¬ã®å‡ºåŠ›ã¯ç‰¹ã«ä»£ã‚ã‚Šæ˜ ãˆã—ãªã„ã®ã§å‰²æ„›)
- å‰å›ã®ãƒ«ãƒ¼ãƒ—ã§`to_complete`ãŒå‘¼ã°ã‚Œãªã‹ã£ãŸãŸã‚ã€`active?`ãŒ`true`ã®ã¾ã¾ã¨ãªã‚Š`to_run`ãŒå®Ÿè¡Œã•ã‚Œãªã„
â¬‡
- ã“ã‚Œä»¥é™ã¯1å‘¨ç›®ã¨åŒã˜æµã‚Œã§ã€`to_run`ã‚‚`to_complete`ã‚‚å‘¼ã°ã‚Œãš5å›ç©ºå›ã‚‹ã ã‘

### `to_complete`ãŒå‘¼ã°ã‚Œãªã„
ã“ã® **`to_complete`ãŒå‘¼ã°ã‚Œãªã„** ã¨ã„ã†ç¾è±¡ãŒå‰²ã¨ã¨ã‚“ã§ã‚‚ãªãã€å®Ÿéš›ã®`Rails`ã®ã‚³ãƒ¼ãƒ‰ã§ã¯`to_complete`ã§ã„ã‚ã„ã‚ã¨ã‚¹ãƒ¬ãƒƒãƒ‰ã®å†…éƒ¨çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã„ãŸã‚Šã™ã‚‹ã‚‚ã®ã§ã€ã“ã‚ŒãŒå‘¼ã°ã‚Œãªã‘ã‚Œã°æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã«ä½¿ã„å›ã•ã‚Œã¦ã—ã¾ã†ã€‚
ä¾‹ãˆã°ã€[`rails/activesuport/lib/active_support/railtie.rb:37`](https://github.com/rails/rails/blob/3c0420c431954d05fef2015a27281069e68cce0c/activesupport/lib/active_support/railtie.rb#L37)ã¨ã‹ã€‚
```ruby
module ActiveSupport
  class Railtie < Rails::Railtie # :nodoc:
    ...
    initializer "active_support.reset_execution_context" do |app|
      app.reloader.before_class_unload { ActiveSupport::ExecutionContext.clear }
      app.executor.to_run              { ActiveSupport::ExecutionContext.clear }
      # ã“ã®è¾ºã¨ã‹
      app.executor.to_complete         { ActiveSupport::ExecutionContext.clear }
    end

    initializer "active_support.reset_all_current_attributes_instances" do |app|
      executor_around_test_case = app.config.active_support.executor_around_test_case

      app.reloader.before_class_unload { ActiveSupport::CurrentAttributes.clear_all }
      app.executor.to_run              { ActiveSupport::CurrentAttributes.reset_all }
      # ã“ã®è¾ºã¨ã‹
      app.executor.to_complete         { ActiveSupport::CurrentAttributes.reset_all }
      ...
```

è©¦ã—ã«æ¦‚è¦ã§ã‚‚è§¦ã‚Œã‚‰ã‚Œã¦ã„ãŸ`ActiveSupport::CurrentAttributes`ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã‚‚ä½¿ã£ã¦ã¿ã‚‹ã¨ã€
```ruby
require 'action_dispatch/middleware/executor'
require 'active_support/code_generator'
require 'active_support/current_attributes'
require 'active_support/executor'
require 'active_support/isolated_execution_state'
require 'debug'

# ã“ã‚“ãªã‚¯ãƒ©ã‚¹ã‚’ä½œã£ã¦ã¿ã‚‹ (é©å½“ã«ä½œã£ã¦ã„ã‚‹ã®ã§å¿…è¦ãªã„è¨˜è¼‰ã‚‚ã‚ã‚Šã¾ã™)
class Current < ActiveSupport::CurrentAttributes
  attribute :account, :user
  attribute :request_id, :user_agent, :ip_address

  resets {}

  def user=(user)
    super
    self.account = user.account
    Time.zone    = user.time_zone
  end
end

...  # ã“ã®è¾ºã¯ä¸€ç·’

# Currentã§ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚’å‚ç…§ã—ã¦ã¿ã‚‹
$executor.to_run { Current.request_id = 1; total += 1; ran += 1 }
$executor.to_complete { ActiveSupport::CurrentAttributes.reset_all; total += 1; completed += 1 }

stack = middleware(proc { Current.request_id += 1; [200, {}, "response"] })

...  # ã“ã®è¾ºã‚‚ä¸€ç·’

puts "requests_count: #{requests_count}"
puts "total         : #{total}"
puts "ran           : #{ran}"
puts "completed     : #{completed}"
puts "Current.request_id: #{Current.request_id}"
```
æœ¬æ¥`to_complete`ãŒå‘¼ã°ã‚Œã¦ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã»ã—ã„ã‚ã‘ã ãŒã€ã“ã‚“ãªæ„Ÿã˜ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«ãã®ã¾ã¾å€¤ãŒå¼•ãå›ã•ã‚Œã¦ã—ã¾ã†ã€‚
ä»Šå›ã¯æ•°å€¤ã‚’å¢—ã‚„ã—ã¦ã„ã‚‹ã ã‘ã ãŒã€å€¤ã«ã‚ˆã£ã¦ã¯ã¨ã‚“ã§ã‚‚ãªã„ã“ã¨ã«ãªã‚Šãã†ã€‚
```shell
$ bundle exec ruby ./sample.rb
requests_count: 5
total         : 1
ran           : 1
completed     : 0
Current.request_id: 6  <= ã“ã‚Œ
```

# Railsã®ã©ã“ã§å‘¼ã°ã‚Œã¦ã„ã‚‹ã®ã‹è¦‹ã¦ã¿ã‚‹
`Rails`ã‹ã‚‰åˆ‡ã‚Šé›¢ã—ãŸã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§`ActionDispatch::Executor#call`ãŒãŠã‹ã—ãªæŒ™å‹•ã‚’èµ·ã“ã—ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ããŸã®ã§ã€å®Ÿéš›ã®`Rails`ã§ã‚‚ã©ã“ã§å‘¼ã°ã‚Œã¦ã„ã‚‹ã®ã‹è¦‹ã¦ã¿ã‚‹ã€‚
ã‚ã¨ã€ã¡ã‚ƒã‚“ã¨`Rails`ã®ä»•çµ„ã¿ã‚‚å­¦ã°ãªã„ã¨ã„ã‘ãªã„ã®ã§ã€ã©ã†ã„ã†çµŒè·¯ã§å‘¼ã³å‡ºã—ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã®ã‹ã‚‚è¦‹ã¦ãŠãã€‚

## æº–å‚™

### èª¿æŸ»ç”¨ã®`Rails`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„
ã¾ãšã¯èª¿æŸ»ç”¨ã®`Rails`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„ã€‚
```shell
# Rubyã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å‰æ

# ãƒ‘ãƒƒãƒãŒå½“ãŸã£ã¦ã„ãªã„`7.0.2`ã®`Rails`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ gem install rails -v 7.0.2
$ rails _7.0.2_ --version
Rails 7.0.2

# é©å½“ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ (èª¿æŸ»ç”¨ã®ãŸã‚è‰²ã€…ã‚¹ã‚­ãƒƒãƒ—)
$ rails _7.0.2_ new explore_cve-2022-23633 \
> --skip-git \
> --skip-keeps \
> --skip-active-record \
> --skip-bundle

# ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚‚é©å½“ã«ä½œæˆã—ã¦ãŠã (rootã«hoge#indexã‚’è¨­å®šã—ã¦ãŠã)
$ rails g controller hoge index --no-helper

# æº–å‚™ã§ããŸ
$ rails s
$ curl -i http://localhost:3000/
HTTP/1.1 200 OK
X-Frame-Options: SAMEORIGIN
X-XSS-Protection: 0
X-Content-Type-Options: nosniff
...
```

### ãƒ‡ãƒãƒƒã‚¬ã‚’ä»•è¾¼ã‚€
ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰åŒæ§˜ã«ãƒ‡ãƒãƒƒã‚¬ã‚’ä»•è¾¼ã‚€ã€‚
```shell
$ cat app/controllers/hoge_controller.rb
class HogeController < ApplicationController
  def index
    debugger  # ã“ã®è¾ºã«å…¥ã‚Œè¾¼ã‚“ã§ãŠã
  end
end

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚„ã‚‰ãªã‚“ã‚„ã‚‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã„ã‚‹ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã§ãƒ‡ãƒãƒƒã‚¬ãŒèµ·å‹•ã™ã‚‹
$ ./bin/rails s
Started GET "/" for 127.0.0.1 at 2022-mm-dd hh:mm:ss +0900
Processing by HogeController#index as HTML
[1, 5] in path/to/explore_cve-2022-23633/app/controllers/hoge_controller.rb
     1| class HogeController < ApplicationController
     2|   def index
=>   3|     debugger
     4|   end
     5| end
=>#0	HogeController#index at path/to/explore_cve-2022-23633/app/controllers/hoge_controller.rb:3
  #1	ActionController::BasicImplicitRender#send_action(method="index", args=[]) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_controller/metal/basic_implicit_render.rb:6
  # and 68 frames (use `bt' command for all frames)
(rdbg)
```

## ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡ã‹ã‚‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¾ã§
ã¨ã‚Šã‚ãˆãš`bt (backtrace)`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡ã‹ã‚‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«ãŸã©ã‚Šç€ãã¾ã§ã®å‘¼ã³å‡ºã—çµŒè·¯ã‚’è¦‹ã¦ã¿ã‚‹ã€‚(çµæ§‹é•·ã‹ã£ãŸã®ã§ä¸€éƒ¨çœç•¥)

```shell
(rdbg) bt    # backtrace command
=>#0	HogeController#index at path/to/explore_cve-2022-23633/app/controllers/hoge_controller.rb:3
  #1	ActionController::BasicImplicitRender#send_action(method="index", args=[]) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_controller/metal/basic_implicit_render.rb:6
  #2	AbstractController::Base#process_action at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/abstract_controller/base.rb:215
  #3	ActionController::Rendering#process_action at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_controller/metal/rendering.rb:53
        ...
        ğŸ” ç¶™æ‰¿å…ƒã®`ActionController`ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«ä¼æ’­ã•ã›ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #6	AbstractController::Callbacks#process_action at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/abstract_controller/callbacks.rb:233
  #7	ActionController::Rescue#process_action at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_controller/metal/rescue.rb:22
        ...
        ğŸ” ActionDispatchãŒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’æ±ºå®šã—ã¦ç¹‹ã„ã§ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #18	ActionDispatch::Routing::RouteSet::Dispatcher#dispatch(controller=HogeController, action="index", req=#<ActionDispatch::Request GET "http://loc..., res=#<ActionDispatch::Response:0x00007f080159...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/routing/route_set.rb:49
  #19	ActionDispatch::Routing::RouteSet::Dispatcher#serve(req=#<ActionDispatch::Request GET "http://loc...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/routing/route_set.rb:32
        ...
        ğŸ” ActionDispatchãŒã‚¯ãƒƒã‚­ãƒ¼ã‚’å‡¦ç†ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #32	ActionDispatch::Cookies#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/cookies.rb:696
        ...
        ğŸ‘‡ ã“ã“ã§ä¾‹ã®`ActionDisptch::Executor`ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹ ğŸ‘‡
  #36	ActionDispatch::Executor#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/executor.rb:14
  #37	ActionDispatch::ActionableExceptions#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/actionable_exceptions.rb:17
  #38	ActionDispatch::DebugExceptions#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/debug_exceptions.rb:28
        ...
        ğŸ” Rackã«ã‚ˆã‚‹ãƒ­ã‚®ãƒ³ã‚°ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #44	Rails::Rack::Logger#call_app(request=#<ActionDispatch::Request GET "http://loc..., env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/railties-7.0.4/lib/rails/rack/logger.rb:40
        ...
        ğŸ” ã‚¢ã‚¯ã‚»ã‚¹å…ƒã®IPã¨ã‹ã‚’ãªã‚“ã‹ã‚´ãƒ‹ãƒ§ã‚´ãƒ‹ãƒ§ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #51	ActionDispatch::RemoteIp#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/remote_ip.rb:93
  #52	ActionDispatch::RequestId#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/request_id.rb:26
        ...
        ğŸ‘‡ ã“ã“ã‚‚`ActionDispatch::Executor`ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹ ğŸ‘‡
  #59	ActionDispatch::Executor#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/executor.rb:14
        ...
        ğŸ” Railsã«å‡¦ç†ãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #63	Rails::Engine#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/railties-7.0.4/lib/rails/engine.rb:530
        ...
        ğŸ” PumaãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¦ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #67	Puma::Request#handle_request(client=#<Puma::Client:0x2f80 @ready=true>, lines="", requests=1) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/puma-5.6.5/lib/puma/request.rb:76
  #68	Puma::Server#process_client(client=#<Puma::Client:0x2f80 @ready=true>, buffer="") at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/puma-5.6.5/lib/puma/server.rb:443
  #69	block {|spawned=2|} in spawn_thread at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/puma-5.6.5/lib/puma/thread_pool.rb:147
```
ã“ã†ã‚„ã£ã¦è¦‹ã¦ã¿ã‚‹ã¨ã€å®Ÿéš›ã«`Puma`ã‹ã‚‰ç¹‹ãŒã‚ŒãŸå¾Œã„ã‚ã„ã‚ã‚ã£ã¦`ActionDispatch`ã«ã‚ˆã£ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚„ã‚¯ãƒƒã‚­ãƒ¼ãŒå‡¦ç†ã•ã‚Œã¦ã„ãŸã‚Šã™ã‚‹æ§˜å­ãŒã‚ˆãã‚ã‹ã£ã¦æ„Ÿå‹•ã€‚
ã¡ã‚‡ã£ã¨è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ã«ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚’é€†ã•ã¾ã«ã—ã¦ä¸Šã‹ã‚‰é †ç•ªã«ç®‡æ¡æ›¸ãã«ã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã€‚

1. `Puma`ãŒãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå±Šãã€`Puma::Server#process_client`ãŒå‘¼ã°ã‚Œã‚‹
   a. `Puma::Request#handle_request`ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã«ç§»ã‚‹
2. `Puma`ã‹ã‚‰`Rails`ã«å‡¦ç†ãŒç§»ã‚‹(Rackã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«æº–æ‹ ã—ãŸ`Rails::Engine#call`ãŒå‘¼ã°ã‚Œã‚‹)
3. `Rails::Engine`å†…ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’`ActionDispatch::Request`ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã€RackãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«ç¹‹ã (ã“ã“ã‹ã‚‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¾ã§ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®é€£é–)
   a. `ActionDispatch::HostAuthorization#call`ã«ã‚ˆã‚‹DNS-Rebindingæ”»æ’ƒã®æ¤œæŸ»
   b. `ActionDispatch::Static#call`ã«ã‚ˆã‚‹é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢
   c. `ActionDispatch::ServerTiming#call`ã«ã‚ˆã‚‹`Server-Timing`ãƒ˜ãƒƒãƒ€ãƒ¼ã®å‡¦ç†
   d. `ActiveSupport::Cache::Strategy::LocalCache::Middleware#call`ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ“ä½œ
   e. `ActionDispatch::Executor#call` ğŸ‘ˆ `ActionDispatch::Executor`1ç®‡æ‰€ç›®
   f. ãƒ­ã‚®ãƒ³ã‚°
   g. `ActionDispatch::RequestId#call`ã«ã‚ˆã‚‹Request IDã®ç™ºè¡Œ
   h. `ActionDispatch::RemoteIp#call`ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹å…ƒã®IPã®è§£æ±º(ãƒ—ãƒ­ã‚­ã‚·ç’°å¢ƒã®å ´åˆãªã©)
   i. `ActionDispatch::Executor#call` ğŸ‘ˆ `ActionDispatch::Executor`2ç®‡æ‰€ç›®
   j. `ActionDispatch::ContentSecurityPolicy::Middleware#call`ã«ã‚ˆã‚‹`Content-Security-Policy`ã®æ¤œè¨¼
   k. ãªã©ãªã©...
5. `ActionDispatch::Routing::RouteSet#call`â†’`ActionDispatch::Jorney::Router#serve`â†’`ActionDispatch::Routing::RouteSet::Dispatcher#serve`ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãŒè§£æ±ºã•ã‚Œå‡¦ç†ãŒå¼•ãæ¸¡ã•ã‚Œã‚‹
6. ã„ã‚ã„ã‚ã‚ã£ã¦`ActionController::Rendering#process_action`ã¨ã‹çµŒç”±ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¾ã§ãŸã©ã‚Šç€ã
7. ã“ã®å¾Œã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚’æˆ»ã£ã¦ã„ãéç¨‹ã§`ActionView`ã¨ã‹ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ§‹ç¯‰ã€‚
æœ€çµ‚çš„ã«`Rails::Engine#call`ã®å‘¼ã³å‡ºã—å…ƒã«`[staus_code as int, headers as HashMap, responses as Array]`ã¨ã„ã†æ„Ÿã˜ã®é…åˆ—ãŒè¿”ã•ã‚Œã€`Puma`ãŒã‚½ã‚±ãƒƒãƒˆã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒã‚¤ãƒˆåˆ—ã¨ã—ã¦æ›¸ãè¾¼ã‚“ã§çµ‚äº†

**åŠ›å°½ããŸ**
ãƒ‘ãƒƒãƒã®å·®åˆ†ã‚„`Executor`ã®è©³ã—ã„æŒ™å‹•ãªã©ã‚‚ã‚‚ã£ã¨è©³ã—ãè¦‹ã‚ˆã†ã‹ã¨æ€ã£ãŸãŒã€ç™ºç”Ÿæ¡ä»¶ãŒæ€ã£ãŸã‚ˆã‚Šè¤‡é›‘ã§ã“ã‚Œä»¥ä¸Šæ·±å €ã‚Šã™ã‚‹ã¨è¨˜äº‹ãŒçˆ†ç™ºã—ãã†ãªæ°—ãŒã—ãŸã®ã¨ã€å˜ç´”ã«åŠ›å°½ãã¦åˆ¥ã®ãƒ†ãƒ¼ãƒã‚’ã‚„ã‚ŠãŸããªã£ãŸã®ã§ã“ã“ã¾ã§ã«ã—ã¦ãŠãã€‚å€‹äººçš„ã«ã¯`Action Pack`ã®ç´°ã‹ã„éƒ¨åˆ†ãŒè¦‹ã‚ŒãŸã®ã§æº€è¶³ã€‚

# å®Ÿã¯Pumaå´ã«ã‚‚ä¿®æ­£ãŒå…¥ã£ã¦ã„ã‚‹
å®Ÿã¯ã“ã®è„†å¼±æ€§ã®ãƒ‘ãƒƒãƒã¯`Puma`ã«ã‚‚é–¢ä¿‚ã—ã¦ã„ã‚‹ã€‚
ä»Šå›ã¯`Puma`å´ã¾ã§çªã£è¾¼ã¾ãªã„ãŒã€RackãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‹ã‚‰ãŠã‹ã—ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ããŸæ™‚ã€èª­ã¿è¾¼ã¿ã™ãã¦ã„ã‚‹ã®ã‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ2ã¤ãŒè¿”ã£ã¦ãã‚‹ã¨ã„ã†é¢ç™½ã„ãƒã‚°ãŒèµ·ãã¦ã„ãŸã‚‰ã—ã„ã€‚
æ°—ã«ãªã‚‹æ–¹ã¯[GitHubã®PR](https://github.com/puma/puma/pull/2812)ãŒå‡ºã¦ã„ã‚‹ã®ã§ã“ã¡ã‚‰ã‚’å‚ç…§ã€‚

# æœ€å¾Œã«
[OpenCVEã®è¨˜è¼‰](https://www.opencve.io/cve/CVE-2022-23633)ã«ã‚‚ã‚ã‚‹é€šã‚Šã€`Attack Complexity`ãŒ`HIGH`ã«ã•ã‚Œã¦ã„ã‚‹ã ã‘ã‚ã£ã¦å‰²ã¨ç™ºç”Ÿæ¡ä»¶ã‚‚é™å®šçš„ã¨ã„ã†ã®ã‚‚ã‚ã£ã¦ã€æœ€å¾Œã®æ–¹ã¯è‹¥å¹²åŠ›å°½ãã¦ãŸã¨ã“ã‚ã‚‚ã‚ã£ãŸãŒã€`Rails`ã®ä»•çµ„ã¿ã«ã¤ã„ã¦ã¯ã‹ãªã‚Šå‹‰å¼·ã«ãªã£ãŸã®ã§è‰¯ã‹ã£ãŸã€‚
ä»Šå›ã¯`Action Pack`å‘¨ã‚ŠãŒãƒ¡ã‚¤ãƒ³ã ã£ãŸãŒã€`Action View`/`Active Record`è¾ºã‚Šã‚‚è¦‹ã¦ã¿ãŸã„ã¨æ€ã£ãŸã€‚

# Appendix
- [NIST](https://nvd.nist.gov/vuln/detail/CVE-2022-23633)
- ãƒ‘ãƒƒãƒ
  - https://github.com/rails/rails/commit/f9a2ad03943d5c2ba54e1d45f155442b519c75da
  - https://github.com/rails/rails/commit/3c0420c431954d05fef2015a27281069e68cce0c
