---
title: "è„†å¼±æ€§ã‹ã‚‰å­¦ã¶Railsã®ä»•çµ„ã¿(CVE-2022-23633ç·¨)"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ruby", "rails"]
published: false
---

# è„†å¼±æ€§ã‹ã‚‰å­¦ã¶Railsã®ä»•çµ„ã¿(CVE-2022-23633ç·¨)
å°‘ã—å‰ã«ã‚„ã£ãŸ[è„†å¼±æ€§ã‹ã‚‰Rubyã‚’å­¦ã¶ã‚„ã¤](https://zenn.dev/0kate/articles/9872322bb93a58)ã‚’`Rails`ã§ã‚‚ã‚„ã£ã¦ã„ãè¨˜äº‹ã€‚
`Rails`ã‚‚ä»•äº‹ã§ä½¿ã†ã‚ˆã†ã«ãªã£ãŸã®ã§ã€ã“ã‚Œã‚‚è„†å¼±æ€§ã‹ã‚‰ä»•çµ„ã¿ã‚’ã¡ã‚ƒã‚“ã¨å­¦ã‚“ã§ã¿ã‚ˆã†ã¨æ€ã†ã€‚

# å¯¾è±¡ã®èª­è€…
ã“ã®è¨˜äº‹ã®å¯¾è±¡ã¨ãªã‚‹äººã¯ã“ã‚“ãªæ„Ÿã˜ã§æƒ³å®šã€‚
- `Rails`ã‚’ä½¿ã„å§‹ã‚ãŸã°ã‹ã‚Šã§ä»•çµ„ã¿ã‹ã‚‰å­¦ã³ãŸã„äºº
- `Rails`ã¯ã‚ˆãä½¿ã£ã¦ã‚‹ã‘ã©ä»•çµ„ã¿ã¯ã‚ˆãã‚ã‹ã‚‰ãªã„ã‹ã‚‰çŸ¥ã‚ŠãŸã„ã¨ã„ã†äºº

è‡ªåˆ†ã®ã‚ˆã†ãª`Rails`åˆå¿ƒè€…ã®æ–¹ã«ã‚‚å‹‰å¼·ã«ãªã‚‹è¨˜äº‹ã«ã—ãŸã„ãŸã‚ã€ã€Œ`Action Pack`ã£ã¦ï¼Ÿã€ã¿ãŸã„ãªè©±ã‚’è»½ãã™ã‚‹ç®‡æ‰€ã‚‚ã‚ã‚‹ãŸã‚ãã®è¾ºã¯ã”äº†æ‰¿ãã ã•ã„ã€‚

# Ruby on Rails
ã•ã£ãã‹ã‚‰ã€ŒRailsã€ã‚Œã„ã‚‹ãšã€ã¨è¨€ã£ã¦ã„ã‚‹ã‚‚ã®ã€‚
è¨€ã‚ãšã¨ã—ã‚ŒãŸRubyã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®1ã¤ã€‚
ã€Œ`Rails`ï¼Ÿã‚ãƒ¼ã€ãƒ”ã‚¶ã®ã“ã¨ã­ã€‚ã€ã¨ã„ã†æ–¹ã¯[Wikipedia](https://ja.wikipedia.org/wiki/Ruby_on_Rails)ã‚’å‚ç…§ã€‚

# è„†å¼±æ€§
ã“ã‚Œã¯Rubyã®è¨˜äº‹ã§è¨˜è¼‰ã—ãŸã®ã§å‰²æ„›ã€‚
æ°—ã«ãªã‚‹æ–¹ã¯ä»¥ä¸‹ã®è„†å¼±æ€§ã‹ã‚‰Rubyã®ä»•çµ„ã¿ã‚’å­¦ã‚“ã è¨˜äº‹ã‚’å‚ç…§ã€‚
https://zenn.dev/0kate/articles/9872322bb93a58

# CVE-2022-23633
ä»Šå›ã®èª¿æŸ»å¯¾è±¡ã¨ãªã‚‹è„†å¼±æ€§ã€‚
ã“ã®è„†å¼±æ€§ã‚’é¸ã‚“ã ã®ã¯ã€æ¯”è¼ƒçš„æ–°ã—ã‚ã®è„†å¼±æ€§ãªã®ã§èº«è¿‘ã«è¦‹ã‹ã‘ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§ã¯ã¨æ€ã£ãŸã®ã¨ã€å†…å®¹çš„ã«`Action Pack`ã‚ãŸã‚Šã‚’æ˜ã‚Šä¸‹ã’ã‚‹ã“ã¨ã«ãªã‚Šãã†ãªã®ã§ã€`Rails`ã®æ ¹æœ¬çš„ãªéƒ¨åˆ†ã‚’å­¦ã¹ãã†ãªæ°—ãŒã—ãŸã‹ã‚‰ã€‚

[OpenCVEã®è„†å¼±æ€§ã®æ¦‚è¦](https://www.opencve.io/cve/CVE-2022-23633)ã¨ã—ã¦ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚
> Action Pack is a framework for handling and responding to web requests. Under certain circumstances response bodies will not be closed. In the event a response is *not* notified of a `close`, `ActionDispatch::Executor` will not know to reset thread local state for the next request. This can lead to data being leaked to subsequent requests.This has been fixed in Rails 7.0.2.1, 6.1.4.5, 6.0.4.5, and 5.2.6.1. Upgrading is highly recommended, but to work around this problem a middleware described in GHSA-wh98-p28r-vrc9 can be used.

é›‘ã«ç¿»è¨³ã™ã‚‹ã¨ã€ã€Œç‰¹å®šã®æ¡ä»¶ä¸‹ã§ã€`ActionDispatch::Executor`ã«ã‚ˆã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã®çµ‚äº†å‡¦ç†ãŒã†ã¾ãè¡Œã‚ã‚Œãšã€ç›´å¾Œã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚¹ãƒ¬ãƒƒãƒ‰ã®å†…éƒ¨çŠ¶æ…‹ãŒå¼•ãç¶™ãŒã‚Œã¦ã—ã¾ã†ã€ã‚‰ã—ã„ã€‚

[GitHubã«æ›¸ã„ã¦ã‚ã‚‹è„†å¼±æ€§ã®æ¦‚è¦](https://github.com/rails/rails/security/advisories/GHSA-wh98-p28r-vrc9)ã«ã¯è‹¥å¹²é•ã†è¨˜è¼‰ãŒã‚ã£ã¦ã€ã“ã£ã¡ã®ã»ã†ãŒã‚‚ã£ã¨å…·ä½“çš„ã«æ›¸ã„ã¦ã‚ã‚‹ã€‚
> Under certain circumstances response bodies will not be closed, for example a bug in a webserver or a bug in a Rack middleware. In the event a response is not notified of a close, ActionDispatch::Executor will not know to reset thread local state for the next request. This can lead to data being leaked to subsequent requests, especially when interacting with ActiveSupport::CurrentAttributes.

åŸºæœ¬çš„ãªå†…å®¹ã¯åŒã˜ã ãŒã€ã“ã£ã¡ã«æ›´ã«è¿½åŠ ã§æ›¸ã„ã¦ã‚ã‚‹ã®ãŒã€Œ`ActiveSupport::CurrentAttributes`ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ãã¯ç‰¹ã«ãã†ãªã‚‹ã€ã‚‰ã—ã„ã€‚

ã‚‚ã¡ã‚ã‚“æ—¢ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹æƒ…å ±ã®ãŸã‚ãƒ‘ãƒƒãƒã¯å½“ãŸã£ã¦ã„ã¦ã€`5.2.6.1`/`6.0.4.5`/`6.1.4.5`/`7.0.2.1`ä»¥é™ã®`Rails`ã‚’ä½¿ã£ã¦ã„ã‚Œã°å¤§ä¸ˆå¤«ã€‚

# ãƒ‘ãƒƒãƒã‚’è¦‹ã¦ã¿ã‚‹
CVEã®æ¦‚è¦ã¨`Action Pack`ã«ã¤ã„ã¦ã‚ã‹ã£ãŸæ‰€ã§ã€å®Ÿéš›ã«å½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒãƒã‚’è¦‹ã¦ã¿ã‚‹ã€‚
OpenCVEã¨ã‹ã«è²¼ã‚‰ã‚Œã¦ã„ã‚‹ãƒªãƒ³ã‚¯ã‹ã‚‰é£›ã¹ã‚‹GitHubä¸Šã®ãƒ‘ãƒƒãƒã¯ã“ã‚Œã€‚
```diff ruby
$ git diff 761a2e25520566d932c41c740b8a5c513d839de8 f9a2ad03943d5c2ba54e1d45f155442b519c75da
diff --git a/activesupport/lib/active_support/reloader.rb b/activesupport/lib/active_support/reloader.rb
index 2f81cd4f80..e751866a27 100644
--- a/activesupport/lib/active_support/reloader.rb
+++ b/activesupport/lib/active_support/reloader.rb
@@ -58,7 +58,7 @@ def self.reload!
       prepare!
     end

-    def self.run! # :nodoc:
+    def self.run!(reset: false) # :nodoc:
       if check!
         super
       else
```
ã“ã®ãƒ‘ãƒƒãƒã¯`ActiveSupport::Reloader#run!`ã«å½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã€‚
ã€Œãˆã€ã“ã‚Œã ã‘ï¼Ÿã€ã¨æ€ã†ã‹ã‚‚ã—ã‚Œãªã„ãŒã€å®Ÿã¯ã“ã®ã‚³ãƒŸãƒƒãƒˆã¯å‰¯æ¬¡çš„ãªã‚‚ã®ã§ã€ã‚‚ã†å°‘ã—ã ã‘å‰ã®ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°ã‚’è¾¿ã‚‹ã¨ãã£ã¡ã«[æœ¬è³ªçš„ãªä¿®æ­£](https://github.com/rails/rails/commit/3c0420c431954d05fef2015a27281069e68cce0c)ãŒåŠ ãˆã‚‰ã‚Œã¦ã„ã‚‹ã€‚
å…¨éƒ¨ã“ã“ã«è¼‰ã›ã‚‹ã«ã¯å°‘ã—ã ã‘é•·ã„ã®ã§ã€é‡è¦ãã†ãªéƒ¨åˆ†ã ã‘æŠœãå‡ºã™ã€‚

```diff ruby
diff --git a/actionpack/lib/action_dispatch/middleware/executor.rb b/actionpack/lib/action_dispatch/middleware/executor.rb
index 85326e313b..1878d64715 100644
--- a/actionpack/lib/action_dispatch/middleware/executor.rb
+++ b/actionpack/lib/action_dispatch/middleware/executor.rb
@@ -9,7 +9,7 @@ def initialize(app, executor)
     end

     def call(env)
-      state = @executor.run!
+      state = @executor.run!(reset: true)
       begin
         response = @app.call(env)
         returned = response << ::Rack::BodyProxy.new(response.pop) { state.complete! }
```
â¬† ã¾ãšã¯æ¦‚è¦åˆ†ã«ã‚‚æ›¸ã‹ã‚Œã¦ã„ãŸ`ActionDispatch::Executor#call`ã®å¤‰æ›´ã€‚
`reset`å¼•æ•°ã«`true`ã‚’æ¸¡ã—ã„ã‚‹ã€‚å…ˆç¨‹ã®`ActiveSupport::Reloader#run!`ã«åŠ ãˆã‚‰ã‚Œã¦ã„ã‚‹`reset`å¼•æ•°ã¨é–¢ä¿‚ã‚ã‚Šãã†ã€‚

```diff ruby
diff --git a/activesupport/lib/active_support/execution_wrapper.rb b/activesupport/lib/active_support/execution_wrapper.rb
index 87d90839ca..5a4a9b2c60 100644
--- a/activesupport/lib/active_support/execution_wrapper.rb
+++ b/activesupport/lib/active_support/execution_wrapper.rb
@@ -64,18 +64,21 @@ def self.register_hook(hook, outer: false)
     # after the work has been performed.
     #
     # Where possible, prefer +wrap+.
-    def self.run!
-      if active?
-        Null
+    def self.run!(reset: false)
+      if reset
+        lost_instance = IsolatedExecutionState.delete(active_key)
+        lost_instance&.complete!
       else
-        new.tap do |instance|
-          success = nil
-          begin
-            instance.run!
-            success = true
-          ensure
-            instance.complete! unless success
-          end
+        return Null if active?
+      end
+
+      new.tap do |instance|
+        success = nil
+        begin
+          instance.run!
+          success = true
+        ensure
+          instance.complete! unless success
         end
       end
     end
@@ -105,27 +108,20 @@ def self.perform # :nodoc:
       end
     end

-    class << self # :nodoc:
-      attr_accessor :active
-    end
-
     def self.error_reporter
       @error_reporter ||= ActiveSupport::ErrorReporter.new
     end

-    def self.inherited(other) # :nodoc:
-      super
-      other.active = Concurrent::Hash.new
+    def self.active_key # :nodoc:
+      @active_key ||= :"active_execution_wrapper_#{object_id}"
     end

-    self.active = Concurrent::Hash.new
-
     def self.active? # :nodoc:
-      @active[IsolatedExecutionState.unique_id]
+      IsolatedExecutionState.key?(active_key)
     end

     def run! # :nodoc:
-      self.class.active[IsolatedExecutionState.unique_id] = true
+      IsolatedExecutionState[self.class.active_key] = self
       run
     end

@@ -140,7 +136,7 @@ def run # :nodoc:
     def complete!
       complete
     ensure
-      self.class.active.delete(IsolatedExecutionState.unique_id)
+      IsolatedExecutionState.delete(self.class.active_key)
     end

     def complete # :nodoc:
```
â¬† æ¬¡ã¯`ActiveSupport::ExecutionWrapper`ã«åŠ ãˆã‚‰ã‚Œã¦ã„ã‚‹å¤‰æ›´ã€‚
`ActiveSupport::IsolatedExecutionState`ãªã‚‹ã‚‚ã®ãŒå‡ºã¦ãã‚‹ã€‚
ã€Œ`IsolatedExecutionState`ã¨ã‹ã„ã†ã‚¯ãƒ©ã‚¹ã‚’ã€è‡ªåˆ†ã®ã‚¯ãƒ©ã‚¹å¤‰æ•°ã«ä¿å­˜ã€ã‹ã‚‰ã€Œ`IsolatedExecutionState`ã®ã‚¯ãƒ©ã‚¹å¤‰æ•°ã«è‡ªåˆ†è‡ªèº«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜ã€ã«å¤‰ã‚ã£ã¦ã„ã‚‹ï¼Ÿã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚

## Workaround
ã•ã‚‰ã«ã€ã©ã†ã—ã¦ã‚‚ãƒ‘ãƒƒãƒé©ç”¨ç‰ˆã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ããªã„å ´åˆã®ä»£æ›¿ç­–ã‚‚ä¸€å¿œç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€æ¬¡ã®RackãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã§ä¸€å…ˆãšãªã‚“ã¨ã‹ãªã‚‹ã‚‰ã—ã„ã€‚
```ruby
class GuardedExecutor < ActionDispatch::Executor
  def call(env)
    ensure_completed!
    super
  end

  private

    def ensure_completed!
      @executor.new.complete! if @executor.active?
    end
end

# Ensure the guard is inserted before ActionDispatch::Executor
Rails.application.configure do
  config.middleware.swap ActionDispatch::Executor, GuardedExecutor, executor
end
```
`GuardedExecutor#call`ã®ä¸­ã§ã€`ActionDispatch::Executor#call`ã®ç›´å‰ã«`complete!`ã‚’å¿…ãšå‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚

## Pumaã¨ã®é–¢ä¿‚
å®Ÿã¯ã“ã®è„†å¼±æ€§ã€Rubyè£½ã®Webã‚µãƒ¼ãƒãƒ¼`Puma`ã¨ã‚‚å¯†æ¥ã«é–¢ä¿‚ã—ã¦ãŠã‚Šã€[GitHubä¸Šã®PRã®ä¼šè©±](https://github.com/puma/puma/pull/2812)ã¨ã‹ã‚’è¦‹ã¦ã¿ã‚‹ã¨é¢ç™½ã„ãƒã‚°ãŒèµ·ãã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚
ä»Šå›ã¯`Rails`ã®ä»•çµ„ã¿ã«é›†ä¸­ã—ãŸã„ã®ã§`Puma`ã«é–¢ã—ã¦ã¯ãã“ã¾ã§æ·±ãè¸ã¿è¾¼ã¾ãªã„ã€‚

# äº‹å‰çŸ¥è­˜
è„†å¼±æ€§ã®æ¦‚è¦ã‚„ãƒ‘ãƒƒãƒã®ãŒç¢ºèªã§ããŸæ‰€ã§å®Ÿéš›ã«ã‚‚ã†å°‘ã—æ·±ãèª¿ã¹ã¦ã„ããŸã„ãŒã€ã“ã“ã¾ã§ã§`ActionDispatch::Executor`ã‚„ã‚‰`ActiveSupport::ExecutionWrapper`ã‚„ã‚‰`ActiveSupport::IsolatedExecutionState`ã‚„ã‚‰`ActiveSupport::CurrentAttributes`ã‚„ã‚‰è‰²ã€…å‡ºã¦ãã¦`Rails`å…¥é–€ã—ãŸã¦äººé–“ã«ã¯è¾›ã„ã‚‚ã®ãŒã‚ã‚‹ã®ã§ã€å°‘ã—ã ã‘ã“ã®è¾ºã®äº‹å‰çŸ¥è­˜ã«ã¤ã„ã¦èª¿ã¹ã¦æº–å‚™ã—ã¦ãŠãã€‚

### `Action Pack`
ã¾ãšã¯åŸºæœ¬ãŒå¤§äº‹ã¨ã„ã†ã“ã¨ã§`Action Pack`ã‹ã‚‰ã€‚`Action Dispatch`ã‚„ã‚‰ã‚‚ã“ã“ã«é–¢ä¿‚ã—ã¦ã„ã‚‹ã€‚
ğŸ“¢ å…¬å¼ã®è¨˜è¼‰ã‚’å™›ã¿ç •ã„ãŸå†…å®¹ãªã®ã§ã€ã“ã‚“ãªã‚‚ã®å¸¸è­˜ã ã¨ã„ã†æ–¹ã¯ã‚¬ãƒ³ã‚¬ãƒ³ã‚¹ã‚­ãƒƒãƒ—æ¨å¥¨ã€‚

#### [`Action Pack`](https://github.com/rails/rails/blob/main/actionpack/README.rdoc#action-pack--from-request-to-response-) is ä½•?
`Ruby on Rails`ã¯`MVC`ãƒ‘ã‚¿ãƒ¼ãƒ³ã«æº–æ‹ ã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãªã‚ã‘ã ãŒã€`Action Pack`ã¯ãã®[ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¬ã‚¤ãƒ¤ãƒ¼](https://github.com/rails/rails#controller-layer)ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ã§ã€HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«é–¢ã™ã‚‹è²¬å‹™ã‚’æ‹…ã£ã¦ã„ã‚‹éƒ¨åˆ†ã€‚
`Action Dispatch`/`Action Controller`ã¨ã„ã†2ã¤ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã€‚

##### `Action Dispatch`
> Action Dispatch, which parses information about the web request, handles routing as defined by the user, and does advanced processing related to HTTP such as MIME-type negotiation, decoding parameters in POST, PATCH, or PUT bodies, handling HTTP caching logic, cookies and sessions.

é›‘ã«ç¿»è¨³ã™ã‚‹ã¨ã€ã€ŒHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è§£é‡ˆ(ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„ã‚¯ãƒƒã‚­ãƒ¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‡¦ç†ãªã©ã‚‚å«ã‚€)ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®šç¾©ã—ãŸã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«é©åˆ‡ã«å—ã‘æ¸¡ã™ã€ã€‚

##### `Action Controller`
> Action Controller, which provides a base controller class that can be subclassed to implement filters and actions to handle requests. The result of an action is typically content generated from views.

ã“ã¡ã‚‰ã‚‚é›‘ã«ç¿»è¨³ã™ã‚‹ã¨ã€ã€Œ`Action Dispatcher`ã‹ã‚‰å—ã‘æ¸¡ã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿéš›ã«å‡¦ç†ã™ã‚‹éƒ¨åˆ†(å‡¦ç†çµæœã¯ãƒ“ãƒ¥ãƒ¼ã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚ŒãŸã‚‚ã®ãŒä¸€èˆ¬çš„)ã€ã€‚
å®Ÿéš›ã«`Rails`ã‚’ä½¿ã£ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¦ã„ãéš›ã«ã€`app/controllers`ã«ã‚¬ãƒ³ã‚¬ãƒ³æ›¸ã„ã¦ã„ãã‚„ã¤ã€‚

### `Active Support`
ä¸€å¿œ`Active Support`ã‚‚ã€‚
(Active Supportã®èª¬æ˜ã‚’å…¥ã‚Œã‚‹)

### `ActionDispatch::Executor`
`ActionDispatch::Executor`ã®å®Ÿæ…‹ã¯[`rails/actionpack/lib/action_dispatch/middleware/executor.rb:7`](https://github.com/rails/rails/blob/8015c2c2cf5c8718449677570f372ceb01318a32/actionpack/lib/action_dispatch/middleware/executor.rb#L7)ã«ã‚ã‚‹ã€‚
ã€Œã‚³ãƒ¼ãƒ‰èª­ã‚“ã§æŒ™å‹•èª¿ã¹ã‚‹ã‹...ã€ã¨æ€ã£ãŸãŒ[`Rails Guide`](https://guides.rubyonrails.org/threading_and_code_execution.html#executor)ã«æ—¢ã«èª¬æ˜ãŒæ›¸ã„ã¦ã‚ã‚‹ã€‚

ãã‚Œã£ã½ãè¦ç´„ã™ã‚‹ã¨ã€ã€Œ`Rails`ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æ§‹æˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã€ã¨ã€Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰ã€ã‚’åˆ†é›¢ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã‚‰ã—ã„ã€‚
`to_run`ã¨`to_complete`ã¨ã„ã†2ç¨®é¡ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å—ã‘å–ã‚Šã€`to_run` â†’ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰ â†’ `to_complete`ã¨ã„ã†é †ç•ªã§å®Ÿè¡Œã™ã‚‹ã€‚
`Rails`å†…éƒ¨ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä½¿ã„æ–¹ã¯ä»¥ä¸‹ã€‚
- è‡ªå‹•ãƒ­ãƒ¼ãƒ‰ã‚„ãƒªãƒ­ãƒ¼ãƒ‰ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒå®‰å…¨ãªä½ç½®ã§ç¨¼åƒã—ã¦ã„ã‚‹ã‹ã‚’è¿½è·¡ã™ã‚‹
- Active Recordã®ã‚¯ã‚¨ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹/ç„¡åŠ¹ã™ã‚‹
- Active Recordã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã«ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹
- å†…éƒ¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®åˆ¶é™

### `ActiveSupport::ExecutionWrapper`
[`rails/activesuport/lib/active_support/execution_wrapper.rb`](https://github.com/rails/rails/blob/3c0420c431954d05fef2015a27281069e68cce0c/activesupport/lib/active_support/execution_wrapper.rb)ã«ã‚ã‚‹ã€‚
å‰è¿°ã®`Executor`
ã“ã® **äº‹å‰å‡¦ç†** ã«å¾Œè¿°ã®`IsolatedExecutionState`ãŒé–¢ã‚ã£ã¦ãã‚‹ã€‚

### `ActiveSupport::Reloader`

### `ActiveSupport::IsolatedExecutionState`
[`rails/activesupport/lib/active_support/isolated_execution.rb`](https://github.com/rails/rails/blob/3c0420c431954d05fef2015a27281069e68cce0c/activesupport/lib/active_support/isolated_execution_state.rb)ã«ã‚ã‚‹ã€‚
ã“ã‚Œã‚‚åå‰é€šã‚Šã€ã€Œã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã«éš”é›¢ã•ã‚ŒãŸå®Ÿè¡ŒçŠ¶æ…‹ã€ã‚’ç®¡ç†ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
ç¾åœ¨ã®å®Ÿè¡Œå˜ä½(`Thread`ã‚‚ã—ãã¯`Fiber`)ã®`active_support_execution_state`ã‚’é–“æ¥çš„ã«å‚ç…§ã™ã‚‹ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚

### `ActiveSupport::CurrentAttributes`
[`rails/activesupport/lib/active_support/current_attribute.rb`](https://github.com/rails/rails/blob/main/activesupport/lib/active_support/current_attributes.rb)ã«ã‚ã‚‹ã€‚
> Abstract super class that provides a thread-isolated attributes singleton, which resets automatically before and after each request. This allows you to keep all the per-request attributes easily available to the whole system.

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã«ã€çŠ¶æ…‹ã‚’ä¿å­˜ã—ã¦ãŠãç”¨ã®ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚
ä½¿ã„æ–¹ã¯ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ã‚ã‹ã‚Šã‚„ã™ã„ã‚µãƒ³ãƒ—ãƒ«ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’å‚ç…§ã€‚
ã¡ãªã¿ã«ã“ã®[`ActiveSupport::CurrentAttributes#current_instances`](https://github.com/rails/rails/blob/main/activesupport/lib/active_support/current_attributes.rb#L163)ã§ã‚‚å‰è¿°ã®`IsolatedExecutionState`ã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚
```ruby
def current_instances
  IsolatedExecutionState[:current_attributes_instances] ||= {}
end
```

# è©¦ã—ã¦ã¿ã‚‹
ä»Šå›ã‚‚ãƒ‘ãƒƒãƒé©ç”¨å¾Œã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã®ã§ã€ãã‚Œã‚’è¦‹ãªãŒã‚‰å¤‰ãªæŒ™å‹•ã‚’èµ·ã“ã—ãã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã‚‹ã€‚
`Rails`æœ¬ä½“ã‹ã‚‰åˆ‡ã‚Šé›¢ã—ã¦ã‚‚å‹•ãã‚ˆã†ã«åˆ†è§£ã—ã¦é›‘ã«æ›¸ãæ›ãˆã€‚
```ruby
require 'action_dispatch/middleware/executor'
require 'active_support/executor'
require 'active_support/isolated_execution_state'

$executor = Class.new(ActiveSupport::Executor)

def middleware(inner_app)
  ActionDispatch::Executor.new(inner_app, $executor)
end

total = 0
ran = 0
completed = 0

$executor.to_run { total += 1; ran += 1 }
$executor.to_complete { total += 1; completed += 1 }

stack = middleware(proc { [200, {}, "response"] })

requests_count = 5

requests_count.times do
  stack.call({})
end

puts "requests_count: #{requests_count}"
puts "total         : #{total}"
puts "ran           : #{ran}"
puts "completed     : #{completed}"
```
ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®é€šã‚Šãªã‚‰ã€`to_run`â†’`to_complete`ãŒ5å›å‘¼ã°ã‚Œã¦ã“ã‚“ãªå‡ºåŠ›ãŒæœŸå¾…ã•ã‚Œã‚‹ã¯ãšã€‚
```shell
requests_count: 5
total         : 9
ran           : 5
completed     : 4
```

ã¨ã“ã‚ãŒå®Ÿéš›ã®å‡ºåŠ›ã¯ã“ã†ã€‚
```shell
$ bundle exec ruby ./sample.rb
requests_count: 5
total         : 1
ran           : 1
completed     : 0
```
1å›ã—ã‹`to_run`å‘¼ã°ã‚Œã¦ãªã„ã—ã€`to_complete`ã«é–¢ã—ã¦ã¯1åº¦ã‚‚å‘¼ã°ã‚Œã¦ã‚„ãŒã‚‰ãªã„æ¨¡æ§˜ã€‚
ãªã‚“ã§ã“ã†ãªã‚‹ã®ã‹ãƒ‡ãƒãƒƒã‚¬ã§è¦‹ã¦ã¿ã‚‹ã€‚

- 1å‘¨ç›®ã¯ã€`active?`ãŒ`false`ã«ãªã‚‹ã®ã§`to_run`ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚ãã®ã¾ã¾è¿”ã£ã¦ãã¦ã€ç™»éŒ²ã—ãŸãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯`true`ã«ãªã‚‹å€¤ãŒè¿”ã•ã‚Œã‚‹ã®ã§ã€`to_complete`ã‚‚å‘¼ã°ã‚Œãªã„ã€‚
- 2å‘¨ç›®ã‹ã‚‰ã¯ã€ã©ã†ã‚„ã‚‰`to_complete`ãŒå‘¼ã°ã‚Œãªã‹ã£ãŸå½±éŸ¿ã§`active?`ãŒ`true`ã®ã¾ã¾ãªã®ã§`to_run`ãŒå®Ÿè¡Œã•ã‚Œãªã„ã€‚

ã“ã®ã€Œ`to_complete`ãŒå‘¼ã°ã‚Œãªã„ã€ã¨ã„ã†ç¾è±¡ãŒå‰²ã¨é‡ãã€å®Ÿéš›ã®`Rails`ã®ã‚³ãƒ¼ãƒ‰ã§ã¯`to_complete`ã§ã„ã‚ã„ã‚ã¨ã‚¹ãƒ¬ãƒƒãƒ‰ã®å†…éƒ¨çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã„ãŸã‚Šã™ã‚‹ã‚‚ã®ã§ã€ã“ã®ã¾ã¾ã§ã¯ã“ã‚Œã‚‰ã®ã‚³ãƒ¼ãƒ‰ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ãªãæ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã«ä½¿ã„å›ã•ã‚Œã¦ã—ã¾ã†ã¨ã„ã†ã‚ã‘ã€‚
```ruby
...
    initializer "active_support.reset_execution_context" do |app|
      app.reloader.before_class_unload { ActiveSupport::ExecutionContext.clear }
      app.executor.to_run              { ActiveSupport::ExecutionContext.clear }
      app.executor.to_complete         { ActiveSupport::ExecutionContext.clear }
    end

    initializer "active_support.reset_all_current_attributes_instances" do |app|
      executor_around_test_case = app.config.active_support.executor_around_test_case

      app.reloader.before_class_unload { ActiveSupport::CurrentAttributes.clear_all }
      app.executor.to_run              { ActiveSupport::CurrentAttributes.reset_all }
      app.executor.to_complete         { ActiveSupport::CurrentAttributes.reset_all }
...
```

è©¦ã—ã«æ¦‚è¦ã§ã‚‚è§¦ã‚Œã‚‰ã‚Œã¦ã„ãŸ`ActiveSupport::CurrentAttributes`ã¨ã„ã†ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã§å…±æœ‰ã§ãã‚‹ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚’ä½¿ã£ã¦ã¿ã‚‹ã¨ã€
```ruby
require 'action_dispatch/middleware/executor'
require 'active_support/code_generator'
require 'active_support/current_attributes'
require 'active_support/executor'
require 'active_support/isolated_execution_state'
require 'debug'

class Current < ActiveSupport::CurrentAttributes
  attribute :account, :user
  attribute :request_id, :user_agent, :ip_address

  # resets { Time.zone = nil }
  resets {}

  def user=(user)
    super
    self.account = user.account
    Time.zone    = user.time_zone
  end
end

$executor = Class.new(ActiveSupport::Executor)

def middleware(inner_app)
  ActionDispatch::Executor.new(inner_app, $executor)
end

total = 0
ran = 0
completed = 0

$executor.to_run { Current.request_id = 1; total += 1; ran += 1 }
$executor.to_complete { ActiveSupport::CurrentAttributes.reset_all; total += 1; completed += 1 }

stack = middleware(proc { Current.request_id += 1; [200, {}, "response"] })

requests_count = 5

requests_count.times do
  # debugger
  stack.call({})
end

puts "requests_count: #{requests_count}"
puts "total         : #{total}"
puts "ran           : #{ran}"
puts "completed     : #{completed}"
puts "Current.request_id: #{Current.request_id}"
```
æœ¬æ¥`to_complete`ãŒå‘¼ã°ã‚Œã¦ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã»ã—ã„ã‚ã‘ã ãŒã€ã“ã‚“ãªæ„Ÿã˜ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«ãã®ã¾ã¾å€¤ãŒå¼•ãå›ã•ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹ã€‚
```shell
$ bundle exec ruby ./sample.rb
requests_count: 5
total         : 1
ran           : 1
completed     : 0
Current.request_id: 6
```


`ActionDispatch::Executor#call`ã‹ã‚‰ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒå‘¼ã°ã‚Œã‚‹
â¬‡
ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‹ã‚‰å¤‰ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚‹
â¬‡
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ä½•ã‹ã—ã‚‰è¿”ã£ã¦ãã¦ã„ã‚‹ã®ã§ã€`returned`ã¯`true`ã¨ãªã‚Š`state.complete!`ãŒå‘¼ã°ã‚Œãªã„
â¬‡
ã‚¹ãƒ¬ãƒƒãƒ‰ã®å†…éƒ¨çŠ¶æ…‹ãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ã“ã¨ãªãã€å¾Œç¶šã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãã®ã¾ã¾ä½¿ã£ã¦ã—ã¾ã†
â¬‡ (â¬† ã“ã“ã¾ã§ãŒ`Rails`ã®è„†å¼±æ€§)
å¤‰ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒãã®ã¾ã¾`Puma`ã«è¿”ã•ã‚Œã‚‹
â¬‡
`Puma`å´ã®ãƒã‚°ã§æ›´ã«ãªã‚“ã‹èµ·ãã‚‹

## èª¿æŸ»ç”¨ã®`Rails`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
é›‘ã«äº‹å‰çŸ¥è­˜ã‚’å…¥ã‚Œè¾¼ã‚“ã©ã„ãŸæ‰€ã§ã€å‰å›ã®`Ruby`ã®æ™‚åŒæ§˜å‹•çš„ã«ãƒ‡ãƒãƒƒã‚°ã—ã¦ã„ããŸã„ã®ã§ã€ãã‚Œç”¨ã®`Rails`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚‚ç”¨æ„ã—ã¦ãŠãã€‚
```shell
# Rubyã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å‰æ

# ãƒ‘ãƒƒãƒãŒå½“ãŸã£ã¦ã„ãªã„`7.0.2`ã®`Rails`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ gem install rails -v 7.0.2
$ rails _7.0.2_ --version
Rails 7.0.2

# é©å½“ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ (æ¤œè¨¼ç”¨ã®ãŸã‚è‰²ã€…ã‚¹ã‚­ãƒƒãƒ—)
$ rails _7.0.2_ new explore_cve-2022-23633 \
> --skip-git \
> --skip-keeps \
> --skip-active-record \
> --skip-bundle

# æ¤œè¨¼ç”¨ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚‚é©å½“ã«ä½œæˆ (rootã«hoge#indexã‚’è¨­å®šã—ã¦ãŠã)
$ rails g controller hoge index --no-helper

# æº–å‚™ã§ããŸ
$ rails s
$ curl -i http://localhost:3000/
HTTP/1.1 200 OK
X-Frame-Options: SAMEORIGIN
X-XSS-Protection: 0
X-Content-Type-Options: nosniff
...
```

# ãƒ‡ãƒãƒƒã‚°ã—ã¦ã„ã
æ¿€æµ…ãªäº‹å‰çŸ¥è­˜ã‚‚èª¿æŸ»ç”¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚‚æº–å‚™ã§ããŸæ‰€ã§ã€å®Ÿéš›ã«å‹•ã‹ã—ãªãŒã‚‰ãƒ‡ãƒãƒƒã‚°ã—ã¦ã„ãã€‚
ãƒ‡ãƒãƒƒã‚°ã™ã‚‹ã«å½“ãŸã£ã¦ã¯ã€`v7`ç³»ã®`Rails`ãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹[`debug gem`](https://github.com/ruby/debug)ã‚’ä½¿ã£ã¦ã„ãã€‚
èµ·å‹•æ–¹æ³•ã¯ç°¡å˜ã§ã€ãƒ‡ãƒãƒƒã‚°ã‚’é–‹å§‹ã—ãŸã„ä»»æ„ã®å ´æ‰€ã«`debugger`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’åŸ‹ã‚è¾¼ã‚€ã ã‘ã§ã€ãã“ã‚’é€šéã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ‡ãƒãƒƒã‚¬ãŒèµ·å‹•ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
ã‚ã¨ã¯å¥½ããªæ‰€ã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å…¥ã‚ŒãŸã‚Šã™ã‚Œã°ã‚ªãƒƒã‚±ãƒ¼ã€‚
```shell
$ cat app/controllers/hoge_controller.rb
class HogeController < ApplicationController
  def index
    debugger  # ã“ã®è¾ºã«å…¥ã‚Œè¾¼ã‚“ã§ãŠã
  end
end

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚„ã‚‰ãªã‚“ã‚„ã‚‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã„ã‚‹ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã§ãƒ‡ãƒãƒƒã‚¬ãŒèµ·å‹•ã™ã‚‹
$ ./bin/rails s
Started GET "/" for 127.0.0.1 at 2022-mm-dd hh:mm:ss +0900
Processing by HogeController#index as HTML
[1, 5] in path/to/explore_cve-2022-23633/app/controllers/hoge_controller.rb
     1| class HogeController < ApplicationController
     2|   def index
=>   3|     debugger
     4|   end
     5| end
=>#0	HogeController#index at path/to/explore_cve-2022-23633/app/controllers/hoge_controller.rb:3
  #1	ActionController::BasicImplicitRender#send_action(method="index", args=[]) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_controller/metal/basic_implicit_render.rb:6
  # and 68 frames (use `bt' command for all frames)
(rdbg)
```
ãƒ‡ãƒãƒƒã‚¬ãŒèµ·å‹•å¾Œã®ä½¿ã„æ–¹ã¯ä»Šå›ã¯å‰²æ„›ã™ã‚‹ã®ã§ã€æ°—ã«ãªã‚‹æ–¹ã¯ã“ã‚Œã‚‚[å…¬å¼ã®HOW TO USE](https://github.com/ruby/debug#how-to-use)ã‚’å‚ç…§ã€‚
ã‚³ãƒãƒ³ãƒ‰ã‚»ãƒƒãƒˆãªã©ã¯`gdb`ã®ãã‚Œã‚’è¸è¥²ã—ãŸæ„Ÿã˜ãªã®ã§ã€`gdb`ã‚’ä½¿ãˆã‚‹äººãªã‚‰æ„Ÿè¦šçš„ã«ã„ã‘ã‚‹ã¯ãšã€‚

## ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¦ã‹ã‚‰ã©ã‚“ãªå‘¼ã³å‡ºã—ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã®ã‹ï¼Ÿ
æ¦‚è¦æ–‡ã«ã‚‚ã‚ã‚‹é€šã‚Šã€ä»Šå›ã®è„†å¼±æ€§ã¯`ActionDispatch::Executor`ãŒè‚ã«ãªã‚‹ã‚ã‘ã ãŒã€ãã‚‚ãã‚‚ãã‚ŒãŒã©ã†ã„ã†éç¨‹ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã®ã‹ãŒã‚ˆãã‚ã‹ã£ã¦ãªã„ã€‚
ã¾ãŸ`Rails`ã®ä»•çµ„ã¿ã‚’å­¦ã¶ã¨ã„ã†ç›®çš„ã‚‚ã‚ã‚‹ã®ã§ã€ã¾ãšã¯`bt (backtrace)`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«ãŸã©ã‚Šç€ãã¾ã§ã®å‘¼ã³å‡ºã—çµŒè·¯ã‚’èª¿ã¹ã¦ã¿ã‚‹ã€‚(çµæ§‹é•·ã‹ã£ãŸã®ã§ä¸€éƒ¨çœç•¥)
```shell
(rdbg) bt    # backtrace command
=>#0	HogeController#index at path/to/explore_cve-2022-23633/app/controllers/hoge_controller.rb:3
  #1	ActionController::BasicImplicitRender#send_action(method="index", args=[]) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_controller/metal/basic_implicit_render.rb:6
  #2	AbstractController::Base#process_action at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/abstract_controller/base.rb:215
  #3	ActionController::Rendering#process_action at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_controller/metal/rendering.rb:53
        ...
        ğŸ” ç¶™æ‰¿å…ƒã®`ActionController`ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«ä¼æ’­ã•ã›ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #6	AbstractController::Callbacks#process_action at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/abstract_controller/callbacks.rb:233
  #7	ActionController::Rescue#process_action at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_controller/metal/rescue.rb:22
        ...
        ğŸ” ActionDispatchãŒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’æ±ºå®šã—ã¦ç¹‹ã„ã§ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #18	ActionDispatch::Routing::RouteSet::Dispatcher#dispatch(controller=HogeController, action="index", req=#<ActionDispatch::Request GET "http://loc..., res=#<ActionDispatch::Response:0x00007f080159...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/routing/route_set.rb:49
  #19	ActionDispatch::Routing::RouteSet::Dispatcher#serve(req=#<ActionDispatch::Request GET "http://loc...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/routing/route_set.rb:32
        ...
        ğŸ” ActionDispatchãŒã‚¯ãƒƒã‚­ãƒ¼ã‚’å‡¦ç†ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #32	ActionDispatch::Cookies#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/cookies.rb:696
        ...
        ğŸ‘‡ ã“ã“ãŒè„†å¼±æ€§ã®æ¦‚è¦ã§è§¦ã‚Œã‚‰ã‚Œã¦ã„ãŸã€ä¾‹ã®`ActionDisptch::Executor` ğŸ‘‡
  #36	ActionDispatch::Executor#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/executor.rb:14
  #37	ActionDispatch::ActionableExceptions#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/actionable_exceptions.rb:17
  #38	ActionDispatch::DebugExceptions#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/debug_exceptions.rb:28
        ...
        ğŸ” Rackã«ã‚ˆã‚‹ãƒ­ã‚®ãƒ³ã‚°ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #44	Rails::Rack::Logger#call_app(request=#<ActionDispatch::Request GET "http://loc..., env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/railties-7.0.4/lib/rails/rack/logger.rb:40
        ...
        ğŸ” ã‚¢ã‚¯ã‚»ã‚¹å…ƒã®IPã¨ã‹ã‚’ãªã‚“ã‹ã‚´ãƒ‹ãƒ§ã‚´ãƒ‹ãƒ§ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #51	ActionDispatch::RemoteIp#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/remote_ip.rb:93
  #52	ActionDispatch::RequestId#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/request_id.rb:26
        ...
        ğŸ‘‡ ãªã‚“ã‹ã“ã“ã«ã‚‚`ActionDispatch::Executor`ãŒã‚ã‚‹ ğŸ‘‡
  #59	ActionDispatch::Executor#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.4/lib/action_dispatch/middleware/executor.rb:14
        ...
        ğŸ” Railsã«å‡¦ç†ãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #63	Rails::Engine#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/railties-7.0.4/lib/rails/engine.rb:530
        ...
        ğŸ” PumaãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¦ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹
  #67	Puma::Request#handle_request(client=#<Puma::Client:0x2f80 @ready=true>, lines="", requests=1) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/puma-5.6.5/lib/puma/request.rb:76
  #68	Puma::Server#process_client(client=#<Puma::Client:0x2f80 @ready=true>, buffer="") at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/puma-5.6.5/lib/puma/server.rb:443
  #69	block {|spawned=2|} in spawn_thread at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/puma-5.6.5/lib/puma/thread_pool.rb:147
```
ã“ã†ã‚„ã£ã¦è¦‹ã¦ã¿ã‚‹ã¨ã€å®Ÿéš›ã«`Puma`ã‹ã‚‰ç¹‹ãŒã‚ŒãŸå¾Œã„ã‚ã„ã‚ã‚ã£ã¦`ActionDispatch`ã«ã‚ˆã£ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚„ã‚¯ãƒƒã‚­ãƒ¼ãŒå‡¦ç†ã•ã‚Œã¦ã„ãŸã‚Šã™ã‚‹æ§˜å­ãŒã‚ˆãã‚ã‹ã£ã¦æ„Ÿå‹•ã€‚
ã¡ã‚‡ã£ã¨è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ã«ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚’é€†ã•ã¾ã«ã—ã¦ä¸Šã‹ã‚‰é †ç•ªã«ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã«ã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã€‚


1. `Puma`ãŒãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå±Šãã€`Puma::Server#process_client`ãŒå‘¼ã°ã‚Œã‚‹
   a. `Puma::Request#handle_request`ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã«ç§»ã‚‹
2. `Puma`ã‹ã‚‰`Rails`ã«å‡¦ç†ãŒç§»ã‚‹(Rackã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«æº–æ‹ ã—ãŸ`Rails::Engine#call`ãŒå‘¼ã°ã‚Œã‚‹)
3. `Rails::Engine`å†…ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’`ActionDispatch::Request`ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã€RackãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«ç¹‹ã (ã“ã“ã‹ã‚‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¾ã§ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®é€£é–)
   a. `ActionDispatch::HostAuthorization#call`ã«ã‚ˆã‚‹DNS-Rebindingæ”»æ’ƒã®æ¤œæŸ»
   b. `ActionDispatch::Static#call`ã«ã‚ˆã‚‹é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢
   c. `ActionDispatch::ServerTiming#call`ã«ã‚ˆã‚‹`Server-Timing`ãƒ˜ãƒƒãƒ€ãƒ¼ã®å‡¦ç†
   d. `ActiveSupport::Cache::Strategy::LocalCache::Middleware#call`ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ“ä½œ
   e. `ActionDispatch::Executor#call` ğŸ‘ˆ
   f. ãƒ­ã‚®ãƒ³ã‚°
   g. `ActionDispatch::RequestId#call`ã«ã‚ˆã‚‹Request IDã®ç™ºè¡Œ
   h. `ActionDispatch::RemoteIp#call`ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹å…ƒã®IPã®è§£æ±º(ãƒ—ãƒ­ã‚­ã‚·ç’°å¢ƒã®å ´åˆãªã©)
   i. `ActionDispatch::Executor#call` ğŸ‘ˆ
   j. `ActionDispatch::ContentSecurityPolicy::Middleware#call`ã«ã‚ˆã‚‹`Content-Security-Policy`ã®æ¤œè¨¼
   k. ãªã©ãªã©...
5. `ActionDispatch::Routing::RouteSet#call`â†’`ActionDispatch::Jorney::Router#serve`â†’`ActionDispatch::Routing::RouteSet::Dispatcher#serve`ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãŒè§£æ±ºã•ã‚Œå‡¦ç†ãŒå¼•ãæ¸¡ã•ã‚Œã‚‹
6. ã„ã‚ã„ã‚ã‚ã£ã¦`ActionController::Rendering#process_action`ã¨ã‹çµŒç”±ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¾ã§ãŸã©ã‚Šç€ã
7. ã“ã®å¾Œã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚’æˆ»ã£ã¦ã„ãéç¨‹ã§`ActionView`ã¨ã‹ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ§‹ç¯‰ã€‚
æœ€çµ‚çš„ã«`Rails::Engine#call`ã®å‘¼ã³å‡ºã—å…ƒã«`[staus_code as int, headers as HashMap, responses as Array]`ã¨ã„ã†æ„Ÿã˜ã®é…åˆ—ãŒè¿”ã•ã‚Œã€`Puma`ãŒã‚½ã‚±ãƒƒãƒˆã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒã‚¤ãƒˆåˆ—ã¨ã—ã¦æ›¸ãè¾¼ã‚“ã§çµ‚äº†

## `ActionDispatch::Executor#call`ã¯å†…éƒ¨ã§ä½•ã‚’ã—ã¦ã„ã‚‹ï¼Ÿ
å‘¼ã³å‡ºã—ã®ãƒãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦`ActionDispatch::Executor`ã®å‘¼ã³å‡ºã—å ´æ‰€ãŒã‚ã‹ã£ãŸæ‰€ã§ã€å®Ÿéš›ã«ä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹ã‚‚ã†å°‘ã—è¦‹ã¦ã„ãã€‚
`ActionDispatch::Executor#call`ãŒå‘¼ã°ã‚Œã‚‹å ´æ‰€ã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ç½®ã„ã¦å®Ÿè¡Œã‚’æ­¢ã‚ã¦ã¿ã‚‹ã€‚

```shell
(rdbg) b ActionDispatch::Executor#call

... # ä¸€åº¦å‡¦ç†ã‚’æœ€å¾Œã¾ã§èµ°ã‚‰ã›ã¦ã€å†åº¦http://localhost:3000/ã«ã‚¢ã‚¯ã‚»ã‚¹

[7, 16] in path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.2/lib/action_dispatch/middleware/executor.rb
     7|     def initialize(app, executor)
     8|       @app, @executor = app, executor
     9|     end
    10|
    11|     def call(env)
=>  12|       state = @executor.run!
    13|       begin
    14|         response = @app.call(env)
    15|         returned = response << ::Rack::BodyProxy.new(response.pop) { state.complete! }
    16|       rescue => error
=>#0	ActionDispatch::Executor#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.2/lib/action_dispatch/middleware/executor.rb:12
  #1	ActionDispatch::Static#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at path/to/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.2/lib/action_dispatch/middleware/static.rb:23
  # and 9 frames (use `bt' command for all frames)

Stop by #0  BP - Method  ActionDispatch::Executor#call at /home/kate/.asdf/installs/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.2/lib/action_dispatch/middleware/executor.rb:11
(rdbg)
```
æ­¢ã¾ã£ãŸã€‚ç¾åœ¨ã®å¤‰æ•°ãªã©ã‚’è¡¨ç¤ºã•ã›ã¦ã¿ã‚‹ã€‚

```shell
(rdbg) i    # info command
%self = #<ActionDispatch::Executor:0x00007fd66e2f2c58 @app=#<ActionDispatch::ServerTiming:0x00007fd66e2f2cf8 @app=#<ActiveSupport::Cache::Strategy::LocalCache::Middleware:0x00007fd66ed8e338 @name="ActiveSupp...>
env = {"rack.version"=>[1, 6], "rack.errors"=>#<IO:<STDERR>>, "rack.multithread"=>true, "rack.multiprocess"=>false, "rack.run_once"=>false, "rack.url_scheme"=>"http", "SCRIPT_NAME"=>"", "QUERY_STRING"=>"", "S...
state = nil
response = nil
returned = nil
error = nil
@app = #<ActionDispatch::ServerTiming:0x00007fd66e2f2cf8 @app=#<ActiveSupport::Cache::Strategy::LocalCache::Middleware:0x00007fd66ed8e338 @name="ActiveSupport::Cache::Strategy::LocalCache", @local_cache_key=...>
@executor = #<Class:0x00007fd66ede22f8>
```
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã®`@app`ã«ã¯`ActionDispatch::ServerTiming`ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€æ¬¡ã«é€£é–ã•ã›ã‚‹ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒå…¥ã£ã¦ã„ã‚‹ã¨æ€ã‚ã‚Œã‚‹ã€‚
è‚å¿ƒã®`@executor`ã¯ã“ã®ã¾ã¾ã§ã¯`Class`ã¨ã—ã‹è¡¨ç¤ºã•ã‚Œãªã‹ã£ãŸã®ã§ã€ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œã§å…¥ã‚Šè¾¼ã‚“ã§è¦‹ã‚‹ã€‚

```shell
(rdbg) s    # step command
[63, 72] in ~/.asdf/installs/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/activesupport-7.0.2/lib/active_support/execution_wrapper.rb
    63|     # Returns an instance, whose +complete!+ method *must* be invoked
    64|     # after the work has been performed.
    65|     #
    66|     # Where possible, prefer +wrap+.
    67|     def self.run!
=>  68|       if active?
    69|         Null
    70|       else
    71|         new.tap do |instance|
    72|           success = nil
=>#0	#<Class:ActiveSupport::ExecutionWrapper>#run! at ~/.asdf/installs/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/activesupport-7.0.2/lib/active_support/execution_wrapper.rb:68
  #1	ActionDispatch::Executor#call(env={"rack.version"=>[1, 6], "rack.errors"=>...) at ~/.asdf/installs/ruby/3.1.2/lib/ruby/gems/3.1.0/gems/actionpack-7.0.2/lib/action_dispatch/middleware/executor.rb:12
  # and 10 frames (use `bt' command for all frames)
```
`ActiveSupport::ExecutionWrapper`ãŒå‡ºã¦ããŸã€‚
ã“ã“ã®`active?`ãƒ¡ã‚½ãƒƒãƒ‰ã§ç¾åœ¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰ä¸­ã§å®Ÿè¡Œä¸­ã§ã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã€å®Ÿè¡Œä¸­ã§ã‚ã‚Œã°ä½•ã‚‚ã›ãš`Null`ã‚’è¿”ã—ã€ãã†ã§ãªã‘ã‚Œã°è‡ªåˆ†è‡ªèº«ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¦`run!`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã€‚
ã‚‚ã¡ã‚ã‚“åˆå›å®Ÿè¡Œæ™‚ã¯`active?`ã¯`false`ã‚’è¿”ã™ã€‚

## ãƒ‘ãƒƒãƒé©ç”¨å‰å¾Œã®é•ã„
ä»Šå›ã®ãƒ‘ãƒƒãƒã§å¤§ããå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã®ãŒç‰¹ã«ã“ã®`ActiveSupport::ExecutionWrapper#run!`ã®éƒ¨åˆ†ãªã®ã ãŒã€ä½•ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨ã€

`ActiveSupport::ExecutionWrapper`å†…ã§`ActiveSupport::IsolatedExecutionState.unique_id`ã‚’ç®¡ç†ã—ã¦ã„ãŸ
  (`ExecutionWrapper.active`ã¨ã„ã†HashMapå†…ã§ã€`IsolatedExecutionState.unique_id`ã‚’ã‚­ãƒ¼ã«booleanã‚’å€¤ã«ã—ã¦ç®¡ç†ã—ã¦ã„ã‚‹)p
â¬‡ (ä¾å­˜ã®å‘ãå…ˆãŒé€†ã«ãªã£ãŸ)
`ActiveSupport::IsolatedExecutionState`å†…ã§`ActiveSupport::ExecutionWrapper.active_key`ã‚’ç®¡ç†ã™ã‚‹ã‚ˆã†ã«ã—ãŸ
  (`Isolatedexecutionstate.current`ã‹ã‚‰å–ã‚Œã‚‹ã€`Thread.current.active_support_execution_state`ã¨ã„ã†`HashMap`ã«`active_execution_wrapper_{ExecutionState.object_id}`ã¨ãªã‚‹ã‚­ãƒ¼ã€`ExecutionWrapper`ã¸ã®å‚ç…§ã‚’å€¤ã¨ã—ã¦ç®¡ç†ã—ã¦ã„ã‚‹)

### æŒ™å‹•ã®å¤‰åŒ–
`ExecutionWrapper`ãŒ`active?`ã§ã‚ã‚Œã°`Null`ã‚’è¿”ã™ã€ãã†ã§ãªã‘ã‚Œã°`run_callbacks`ã‚’å‘¼ã³å‡ºã™ã€‚
â¬‡
`ExecutionWrapper`ã®`run!`ã«æ¸¡ã•ã‚ŒãŸ`reset`ãŒ`true`ã§ã‚ã‚Œã°`IsolatedExecutionState`ã‹ã‚‰è‡ªåˆ†ã‚’å‰Šé™¤ã—`run_callbacks`ã‚’å‘¼ã³å‡ºã™ã€ãã†ã§ãªã`active?`ã§ã‚ã‚Œã°`Null`ã‚’è¿”ã™ã€‚

### `active?`ã§ã‚ã‚‹ã¨ã¯ï¼Ÿ
`ExecutionWrapper`ã«`IsolatedExecutionState`ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã€‚
```ruby
def self.active? # :nodoc:
  @active[IsolatedExecutionState.unique_id]
end
```
â¬‡
`ExecutionWrapper`ãŒ`IsolatedExecutionState`ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã€‚
```ruby
def self.active? # :nodoc:
  IsolatedExecutionState.key?(active_key)
end
```



---




ã•ã‚‰ã«ã“ã®è„†å¼±æ€§ã®ãƒ‘ãƒƒãƒã¯`Puma`ã«ã‚‚é–¢ä¿‚ã—ã¦ãŠã‚Šã€

`Puma`ãŒãƒã‚°ã®ã‚ã‚‹`Rack`ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å¯¾ã—ã¦é©åˆ‡ãªå‡¦ç†ãŒã‹ã‘ã‚Œã¦ã„ãªã„ç‚¹(èª­ã¿è¾¼ã¿ã™ãã‚‹)ã€`Rails`å´ã§`Thread`ã®çŠ¶æ…‹ã‚’é©åˆ‡ã«ã‚¯ãƒªã‚¢ã§ãã¦ã„ãªã„ç‚¹()ã®åˆã‚ã›æŠ€ã§é€£ç¶šã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒæ¼æ´©ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

Aã¨ã„ã†å‡¦ç†ãŒã‚ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã§å‡¦ç†ã•ã‚Œ`IsolatedExecutionState`å†…ã‚’æ¶ˆã›ãšã«å‡¦ç†ã‚’çµ‚äº†ã—ã¦ã—ã¾ã†ã€‚
Bã¨ã„ã†åˆ¥ã®å‡¦ç†ãŒåŒã˜å®Ÿè¡Œã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€

å¤‰ãªæŒ™å‹•ã‚’ã™ã‚‹ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ç”¨æ„ã—ã¦ã€`ActiveSupport::CurrentAttributes`ã‚’ä½¿ã£ã¦ä½•ã‹ã—ã‚‰ã‚’ä½¿ãˆã°å†ç¾ã§ããã†ãªé›°å›²æ°—ãŒå‡ºã¦ã„ã‚‹ã€‚

## ãƒ¡ãƒ¢



### ãã‚‚ãã‚‚`ExecutionWrapper`/`IsolatedExecutionState`ã¯ãªã‚“ãªã®ã‹ï¼Ÿ



### `IsolatedExecutionState.unique_id`ã¯ãªã‚“ãªã®ã‹ï¼Ÿ
ç¾åœ¨ã®å®Ÿè¡Œå˜ä½(`Thread`ã‚‚ã—ãã¯`Fiber`)ã®`active_support_execution_state`ã«å«ã¾ã‚Œã‚‹`__id__`ã‚·ãƒ³ãƒœãƒ«ã®å€¤ã€‚
åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ç©ºã®`Object`ãŒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã•ã‚ŒãŸã‚‚ã®ãŒä»£å…¥ã•ã‚Œã€ãã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä¸€æ„ãªIDã¨ã—ã¦ã®å½¹å‰²ã‚’æŒã¤ã€‚
```ruby
module ActiveSupport
  module IsolatedExecutionState # :nodoc:
      ...
      def unique_id
        self[:__id__] ||= Object.new
      end
```

### `Thread.current.active_support_execution_state`ã¯å…·ä½“çš„ã«ä½•ã‚’ä¿å­˜ã—ãŸã„ã®ã‹
ã€Œ`ExecutionWrapper`ã‚’ä¸€æ„ã«è­˜åˆ¥ã™ã‚‹IDã€ã‚’ä¿å­˜ã—ãŸã„ã€‚
ãŠãã‚‰ãã€ãƒªãƒ­ãƒ¼ãƒ‰å‡¦ç†ã®ã‚ˆã†ãªå‡¦ç†ãŒ1ã¤ã®å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ(Threadã‹Fiber)ã§ä½•åº¦ã‚‚å®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«æ’ä»–å‡¦ç†ãŒã—ãŸã„ï¼Ÿ
ãã‚Œã«ã—ã¦ã‚‚`ExecutionWrapper`ã£ã¦åå‰ã‹ã‚‰ãªã‚“ãªã®ã‹ã‚ã‹ã‚Šã¥ã‚‰ããªã„ã‹...ï¼Ÿ

### ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€ãªã‚“ã®å‡¦ç†ãŒ`ExecutionWrapper`ã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã®ã‹
ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ã—ã¦ã„ã‚‹`ActiveSupport::Callbacks`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®`run_callbacks`ãŒå‘¼ã°ã‚Œã‚‹ã€‚
å†…éƒ¨ã§ã¯ã€`__callbacks`ã¨ã„ã†HashMapã®`:run`ã‚’ã‚­ãƒ¼ã¨ã™ã‚‹`ActiveSupport::Callbacks::CallbackChain`ãŒå‘¼ã°ã‚Œã‚‹ã€‚
ã¾ãšå‘¼ã°ã‚Œã‚‹ã®ã¯ãƒªãƒ­ãƒ¼ãƒ‰å‡¦ç†ã€‚äº‹å‰ã«`ActiveSupport::Reloader#check!`ã§ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¹ãã‹ãƒã‚§ãƒƒã‚¯ã—ãŸå¾Œã€å®Ÿéš›ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹è¦ªã‚¯ãƒ©ã‚¹ã®`ExecutionWrapper#run!`ã«å…¥ã£ã¦ãã‚‹ã€‚

### `ExecutionWrapper`å†…ã§`IsolatedExecutionState`ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ã®ä½•ãŒå•é¡Œã ã£ãŸã®ã‹ï¼Ÿ (ãªãœ`IsolatedExecutionState`ã«`ExecutionWrapper`ã‚’ç®¡ç†ã•ã›ã‚‹æ–¹é‡ã«å¤‰ãˆã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã‹)
ã“ã“ã¾ã§ã®å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ã‚’æ•´ç†ã€‚(ãƒ‘ãƒƒãƒé©ç”¨å‰ã®å‹•ã)
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåˆ°é”ã™ã‚‹
â¬‡
- è‰²ã€…ã‚ã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é€ã‚‰ã‚ŒãŸãƒ‘ã‚¹ã¨ãƒ¡ã‚½ãƒƒãƒ‰ã«è©²å½“ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãŒè§£æ±ºã•ã‚Œã‚‹
â¬‡
- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«ç¹‹ãå‰ã«ã€ãƒªãƒ­ãƒ¼ãƒ‰ã™ã¹ãã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹(ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ãªã©ã‚’ç¢ºèª)
â¬‡
- ãƒªãƒ­ãƒ¼ãƒ‰ã™ã¹ãã¨åˆ¤æ–­ã—ãŸå ´åˆã€ãƒªãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚’è¡Œã†ä¸€é€£ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«å…¥ã‚‹
â¬‡
- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œé–‹å§‹å‰ã«`ExecutionWrapper`ã«`IsolatedExecutionState`ã‚’ç™»éŒ²ã™ã‚‹(ã“ã“ã§ç™»éŒ²ã•ã‚Œã‚‹ã®ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã¯ãªãã‚¯ãƒ©ã‚¹è‡ªä½“ã®ãŸã‚ã©ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚‚åŒã˜é™çš„ãªå€¤)
â¬‡
- ãƒªãƒ­ãƒ¼ãƒ‰å‡¦ç†ãŒè¡Œã‚ã‚Œã‚‹
â¬‡
- äº‹å¾Œå‡¦ç†ã¨ã—ã¦`ExecutionWrapper`ã‹ã‚‰ç™»éŒ²ã—ãŸ`IsolatedExecutionState`ã‚’å‰Šé™¤

ã“ã‚ŒãŒã“ã†ãªã‚‹ã€‚

- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåˆ°é”ã™ã‚‹
â¬‡
- è‰²ã€…ã‚ã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é€ã‚‰ã‚ŒãŸãƒ‘ã‚¹ã¨ãƒ¡ã‚½ãƒƒãƒ‰ã«è©²å½“ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãŒè§£æ±ºã•ã‚Œã‚‹
â¬‡
- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«ç¹‹ãå‰ã«ã€ãƒªãƒ­ãƒ¼ãƒ‰ã™ã¹ãã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹(ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ãªã©ã‚’ç¢ºèª)
â¬‡
- ãƒªãƒ­ãƒ¼ãƒ‰ã™ã¹ãã¨åˆ¤æ–­ã—ãŸå ´åˆã€ãƒªãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚’è¡Œã†ä¸€é€£ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«å…¥ã‚‹
â¬‡
- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œé–‹å§‹å‰ã«`IsolatedExecutionWrapper`ã«`ExecutionWrapper`ã‚’ç™»éŒ²ã™ã‚‹(ã“ã“ã§ç™»éŒ²ã•ã‚Œã‚‹ã®ã¯`ExecutionWrapper`ã‚¯ãƒ©ã‚¹ã®`object_id`ã‚’ä½¿ã£ãŸæ–‡å­—åˆ—ãŒã‚­ãƒ¼ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå€¤)
â¬‡
- ãƒªãƒ­ãƒ¼ãƒ‰å‡¦ç†ãŒè¡Œã‚ã‚Œã‚‹
â¬‡
- äº‹å¾Œå‡¦ç†ã¨ã—ã¦`ExecutionWrapper`ã‹ã‚‰ç™»éŒ²ã—ãŸ`IsolatedExecutionState`ã‚’å‰Šé™¤

`ExecutionWrapper`å†…ã§`IsolatedExecutionState`ã‚’ç®¡ç†ã™ã‚‹å ´æ‰€ã¨ã—ã¦ã‚¯ãƒ©ã‚¹å¤‰æ•°ã®HashMapã‚’ä½¿ç”¨ã—ã¦ã„ãŸã®ã ãŒã€`ExecutionWrapper`è‡ªä½“ã¯ç¶™æ‰¿ã•ã‚Œã¦ä½¿ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€å…¨ç„¶é–¢ä¿‚ãªã„å­ã‚¯ãƒ©ã‚¹ãŸã¡ã®é–“ã§ã‚‚`IsolatedExecutionState`ã‚’ç®¡ç†ã—ã¦ã„ã‚‹çŠ¶æ…‹ãŒå…±æœ‰ã•ã‚Œã¦ã—ã¾ã†ï¼Ÿ
ä¾‹ãˆã°...
`ExecutionWrapper`ã‚’ç¶™æ‰¿ã—ãŸ`A`ã¨`B`ã¨ã„ã†ã‚¯ãƒ©ã‚¹ãŒã‚ã‚‹ã¨ã—ã¦ã€`A`ã‚’å®Ÿè¡Œã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¦ªã‚¯ãƒ©ã‚¹ã®ã‚¯ãƒ©ã‚¹å¤‰æ•°ã«`IsolatedExecutionState`ã‚¯ãƒ©ã‚¹ã®`object_id`ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã€‚
ã“ã‚Œã¯ã‚¯ãƒ©ã‚¹å¤‰æ•°ã§ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€åŒã˜ã`ExecutionWrapper`ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹`B`ã«ã‚‚å½±éŸ¿ã—ã€ã“ã®é–“ã«`B`ã‚‚å®Ÿè¡Œã•ã‚Œã‚‹ã¨`active?`ãŒ`true`ã«ãªã‚‹ã€‚
`B`ã§å®Ÿè¡Œã•ã‚Œã‚‹æƒ³å®šã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œãšã€äºˆæœŸã›ã¬æŒ™å‹•ã‚’èµ·ã“ã™ã€‚

ã“ã‚Œã‚’ã€Œå®Ÿè¡Œä¸­ã®`ExecutionWrapper`ã‚’`IsolatedExecutionState`ã®ã‚¯ãƒ©ã‚¹å¤‰æ•°ã§å˜ä¸€ç®¡ç†ã€ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€`IsolatedExecutionState`ã¯ç¶™æ‰¿ã•ã‚ŒãŸã‚Šã™ã‚‹ã‚‚ã®ã§ã‚‚ãªã„ã®ã§ä¸Šè¨˜ã®ã‚ˆã†ãªæŒ™å‹•ã‚’ã™ã‚‹ã“ã¨ãŒãªããªã‚‹ã€‚

#### ã¤ã¾ã‚Š
ã€Œå®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã§`ExecutionWrapper` **ã«** `IsolatedExecutionState`ã‚’å…¥ã‚Œã¦å®Ÿè¡Œä¸­ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¦ã„ã‚‹ã€ã‹ã€ã€Œ`ExecutionWrapper` **ã‚’** `IsolatedExecutionState`ã«å…¥ã‚Œã¦å®Ÿè¡Œä¸­ã‹ã©ã†ã‹åˆ¤å®šã—ã¦ã„ã‚‹ã€ã‹ã®é•ã„ã€‚
å‰è€…ã¯ã€Œå„å®Ÿè¡Œå¯¾è±¡ã®ã‚¯ãƒ©ã‚¹ã«å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç´ä»˜ã‘ã¦ãŠã„ã¦ã€ã“ã“ã§å®Ÿè¡Œä¸­ã§ã™ã‚ˆã¨ã„ã†å°ã§ã“ã®ã‚¯ãƒ©ã‚¹ãŒactiveã‹åˆ¤å®šã—ã¦ã„ã‚‹ã€ã®ã¨ã€å¾Œè€…ã¯ã€Œå„å®Ÿè¡Œå¯¾è±¡ã®ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ç´ã¥ã‘ã¦ã€ã“ã®å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã¯ã“ã®ã‚¯ãƒ©ã‚¹ãŒå®Ÿè¡Œä¸­ã§ã™ã‚ˆã¨ã„ã†å°ã§activeã‹ã©ã†ã‹åˆ¤å®šã—ã¦ã„ã‚‹ã€ã€‚

ãƒ‘ãƒƒãƒã§ã¯ã€`ActionDispath::Executor#call`ã‹ã‚‰ã¯æ¯å›æ˜ç¤ºçš„ã«`reset = true`ã¨ã—ã¦å‘¼ã³å‡ºã™ã“ã¨ã§ã€å‰å›ã®å®Ÿè¡ŒçŠ¶æ…‹ã‚’ç¢ºå®Ÿã«ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã«é€²ã‚€ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚

`ActionDispatch::Executor#call`ã‹ã‚‰ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒå‘¼ã°ã‚Œã‚‹
â¬‡
ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‹ã‚‰å¤‰ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚‹
â¬‡
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ä½•ã‹ã—ã‚‰è¿”ã£ã¦ãã¦ã„ã‚‹ã®ã§ã€`returned`ã¯`true`ã¨ãªã‚Š`state.complete!`ãŒå‘¼ã°ã‚Œãªã„
â¬‡
ã‚¹ãƒ¬ãƒƒãƒ‰ã®å†…éƒ¨çŠ¶æ…‹ãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ã“ã¨ãªãã€å¾Œç¶šã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãã®ã¾ã¾ä½¿ã£ã¦ã—ã¾ã†
â¬‡ (â¬† ã“ã“ã¾ã§ãŒ`Rails`ã®è„†å¼±æ€§)
å¤‰ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒãã®ã¾ã¾`Puma`ã«è¿”ã•ã‚Œã‚‹
â¬‡
`Puma`å´ã®ãƒã‚°ã§æ›´ã«ãªã‚“ã‹èµ·ãã‚‹



## ã€Œã©ã“ã§ã€ã€Œãªã«ã‚’ã€**ãƒªã‚»ãƒƒãƒˆ**ã—ã¦ã„ã‚‹ã®ã‹ï¼Ÿ
`reset`ã¨ã„ã†å¼•æ•°ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã£ãŸã®ã§ã€ã“ã®å€¤ã«ã‚ˆã£ã¦ä½•ãŒèµ·ãã¦ã„ã‚‹ã®ã‹ã‚‚ã†å°‘ã—æ·±ãè¦‹ã¦ã„ãã€‚

### ActiveSupport::Reloader#run!
ãã‚‚ãã‚‚ã“ã®ãƒ‘ãƒƒãƒãŒå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å ´æ‰€ã ãŒã€[`rails/activesupport/lib/active_support/reloader.rb:61`](https://github.com/rails/rails/blob/f9a2ad03943d5c2ba54e1d45f155442b519c75da/activesupport/lib/active_support/reloader.rb#L61)ã«ã‚ã‚‹ã€‚
```ruby
module ActiveSupport
  ...

  class Reloader < ExecutionWrapper
    ...

    def self.run!(reset: false) # :nodoc:
      if check!
        super
      else
        Null
      end
    end
    ...
```

`ActiveSupport`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã®`Reloader`ã‚¯ãƒ©ã‚¹ã®ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹`run!`ãƒ¡ã‚½ãƒƒãƒ‰ã€‚
ã“ã“ã§`reset`å¼•æ•°ãŒãã®ã¾ã¾`super`ã«æ¸¡ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚‹ã€‚
`Reloader`ã‚¯ãƒ©ã‚¹ã¯`ExecutionWrapper`ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹ãŸã‚ã€`ExecutionWrapper`ã‚’è¦‹ã¦ã¿ã‚‹ã€‚

ã¡ãªã¿ã«ã€`ActiveSupport`ã¯`Rails`å†…ã§ä½¿ã‚ã‚Œã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ç³»ã®ã‚¯ãƒ©ã‚¹ã‚„æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ‹¡å¼µã‚’æä¾›ã™ã‚‹ã‚³ãƒ¼ãƒ‰éƒ¡ã ãŒã€ä»Šå›ã¯ç´°ã‹ã„èª¬æ˜ã¯å‰²æ„›ã™ã‚‹ã€‚
æ°—ã«ãªã‚‹æ–¹ã¯[å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/rails/rails/blob/main/activesupport/README.rdoc)ã‚’å‚ç…§ã€‚

### ActiveSupport::ExecutionWrapper
`ExecutionWrapper`ã®æœ¬ä½“ã¯[`rails/activesupport/lib/active_support/execution_wrapper.rb:8`](https://github.com/rails/rails/blob/f9a2ad03943d5c2ba54e1d45f155442b519c75da/activesupport/lib/active_support/execution_wrapper.rb:8)ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€‚
`run!`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã€‚
```ruby
module ActiveSupport
  class ExecutionWrapper
    ...
    # Run this execution.
    #
    # Returns an instance, whose +complete!+ method *must* be invoked
    # after the work has been performed.
    #
    # Where possible, prefer +wrap+.
    def self.run!(reset: false)
      if reset
        lost_instance = IsolatedExecutionState.delete(active_key)
        lost_instance&.complete!
      else
        return Null if active?
      end

      new.tap do |instance|
        success = nil
        begin
          instance.run!
          success = true
        ensure
          instance.complete! unless success
        end
      end
    end
    ...
```

`reset`ãŒçœŸã®æ™‚ã€`IsolatedExecutionState`ã‚’`delete`ã—ã¦ã„ã‚‹ã€‚
ãã®å¾Œè‡ªåˆ†è‡ªèº«ã‚’[`new`](https://docs.ruby-lang.org/ja/latest/class/Class.html#I_NEW)ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã€[`tap`](https://docs.ruby-lang.org/ja/latest/class/Object.html#I_TAP)ã§æ¸¡ã—ãŸãƒ–ãƒ­ãƒƒã‚¯ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®`run!`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã€‚

`ExecutionnWrapper`ã®`run!`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã“ã‚Œã€‚
```ruby
def run! # :nodoc:
  IsolatedExecutionState[self.class.active_key] = self
  run
end
```

`IsollatedExecutionState`ã®`active_key`ãªã‚‹ã‚‚ã®ã«è‡ªåˆ†è‡ªèº«ã‚’è¨­å®šã—ãŸå¾Œã€`run`ãƒ¡ã‚½ãƒƒãƒ‰ã«ç¹‹ã„ã§ã„ã‚‹ã€‚ã„ãšã‚Œã«ã—ã¦ã‚‚`IsolatedExecutionState`ã‚¯ãƒ©ã‚¹ã‚’è¦‹ã¦ã„ãã“ã¨ã«ãªã‚‹ã€‚

### `ActiveSupport::IsolatedExecutionState`
`IsolatedExecutionState`ã®æœ¬ä½“ã¯[`rails/activesupport/lib/active_support/isolated_execution_state.rb:#L6`](https://github.com/rails/rails/blob/f9a2ad03943d5c2ba54e1d45f155442b519c75da/activesupport/lib/active_support/isolated_execution_state.rb#L6)ã«ã‚ã‚‹ã€‚
```ruby
module ActiveSupport
  module IsolatedExecutionState # :nodoc:
    ...
    class << self
      ...

      def []=(key, value)
        state[key] = value
      end

      ...

      def delete(key)
        state.delete(key)
      end

      ...

      def context
        scope.current
      end

      private
        def state
          context.active_support_execution_state ||= {}
        end
    end

    ...
  end
end
```

è¦‹ãŸæ‰€ã€
