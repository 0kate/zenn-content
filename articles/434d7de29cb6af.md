---
title: "wasi-vfsã§ãƒ‘ãƒƒã‚¯ã—ãŸãƒã‚¤ãƒŠãƒª(CRuby)ã‚’çœºã‚ã¦ã¿ãŸ"
emoji: "ğŸ“¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ruby", "webassembly", "wasi", "vfs"]
published: false
---

# wasi-vfsã§ãƒ‘ãƒƒã‚¯ã—ãŸãƒã‚¤ãƒŠãƒª(CRuby)ã‚’çœºã‚ã¦ã¿ãŸ
Ruby 3.2.0ã§WASIãƒ™ãƒ¼ã‚¹ã®Wasmã¸ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒã‚µãƒãƒ¼ãƒˆã•ã‚ŒãŸã€‚
https://www.ruby-lang.org/ja/news/2022/12/25/ruby-3-2-0-released/

ãã®ä¸­ã§ã‚‚å€‹äººçš„ã«æ°—ã«ãªã£ãŸã®ã¯ã“ã®è¨˜è¼‰ã€‚
> ã•ã‚‰ã«ã€WASIã®ä¸Šã«VFSã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Rubyã‚¢ãƒ—ãƒªã‚’å˜ä¸€ã®.wasmãƒ•ã‚¡ã‚¤ãƒ«ã«å®¹æ˜“ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã§ãã¾ã™ã€‚Rubyã‚¢ãƒ—ãƒªã®é…å¸ƒãŒå°‘ã—ç°¡å˜ã«ãªã‚Šã¾ã™ã€‚

ã©ã†ã„ã†ãƒã‚¤ãƒŠãƒªã«ãªã£ã¦ã„ã‚‹ã®ã‹ãªã©ã€æ°—ã«ãªã£ãŸã®ã§èª¿ã¹ã¦ã¿ãŸã„ã¨æ€ã†ã€‚

# WASIã®ä¸Šã«VFSã¨ã¯ï¼Ÿ
`VFS`ã¨ã„ã†ã¨çœŸã£å…ˆã«æ€ã„æµ®ã‹ã‚“ã ã®ãŒã€Unixç³»ã®ã‚·ã‚¹ãƒ†ãƒ ã§èã[ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ (Virtual File System)](https://ja.wikipedia.org/wiki/%E4%BB%AE%E6%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0)ã€‚
ãŠãã‚‰ãã“ã‚Œã¨åŒç­‰ã®æ¦‚å¿µã§ã‚ã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿æ›¸ãã™ã‚‹å…±é€šã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã‚ˆã£ã¦å¤šæ…‹æ€§ã‚’å®Ÿç¾ã—ã¦ã„ã‚‹ã‚‚ã®ã€‚
ã“ã‚Œã«ã‚ˆã£ã¦ã€Wasmã‚’ãƒ›ã‚¹ãƒˆä¸Šã§å®Ÿè¡Œã™ã‚‹ã‹ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å®Ÿè¡Œã™ã‚‹ã‹ã«é–¢ã‚ã‚‰ãšã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®èª­ã¿æ›¸ãåŒæ§˜ã®å‹•ããŒå¯èƒ½ã«ãªã‚‹ã€‚
å…·ä½“çš„ã«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã‚‚ **ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‹ã‚‰ã€è©²å½“ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿å‡ºã™** ã¨ã„ã£ãŸã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

## ãªãœVFSãŒå¿…è¦ã ã£ãŸã®ã‹
VFSãŒå¿…è¦ã«ãªã£ãŸèƒŒæ™¯ã¯ã€[RubyKaigi2022ã® **Ruby meets WebAssembly**](https://rubykaigi.org/2022/presentations/kateinoigakukun.html) ã®ãƒ‘ãƒ¼ãƒˆ(`23:00`è¾ºã‚Š)ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã€‚

è¶…é›‘ã«è¦ç´„ã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã€‚(å‹æ‰‹ãªæƒ³åƒã‚‚ç››ã‚Šç››ã‚Šé…åˆã•ã‚Œã¦ã„ã¾ã™)
ğŸ¤© `CRuby`ãŒ`Wasm`ã§å‹•ãã‚ˆã†ã«ãªã£ãŸãï¼ï¼
â¬‡
ğŸ˜® ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã ã‹ã‚‰ã€å‡¦ç†ç³»ã ã‘ã˜ã‚ƒãªãã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«(`.rb`ãƒ•ã‚¡ã‚¤ãƒ«)ã‚‚ä¸€ç·’ã«é…å¸ƒã—ãªã„ã¨ã„ã‘ãªããªã„ï¼ï¼Ÿ
â¬‡
ğŸ¤” ãƒ›ã‚¹ãƒˆä¸Šã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆé…ç½®ã—ã¦å®Ÿè¡Œã—ã¦ã­ï¼ã¯ã¡ã‚‡ã£ã¨é¢å€’ã˜ã‚ƒãªã„ï¼ï¼Ÿ
â¬‡
ğŸ˜ƒ `Wasm`ã®ãƒã‚¤ãƒŠãƒªã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ä¸€ç·’ã«åŸ‹ã‚è¾¼ã‚“ã˜ã‚ƒãˆã°è‰¯ã„ã®ã§ã¯ï¼ï¼Ÿ
â¬‡
ğŸ¤— ãã‚“ã§ã‚‚ã£ã¦ã€ **`CRuby`ãŒãƒ›ã‚¹ãƒˆä¸Šã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å‡ºã™ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹** ã§åŸ‹ã‚è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚èª­ã¿å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¡ã‚ƒãˆã°è‰¯ã„ã‚“ã˜ã‚ƒãªã„ï¼ï¼Ÿ

ã¤ã¾ã‚Š **å®Ÿè¡Œã—ãŸã„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚åŸ‹ã‚è¾¼ã‚“ã˜ã‚ƒã£ã¦ã€ãƒ¯ãƒ³ãƒã‚¤ãƒŠãƒªã§`Wasm`ã®`CRuby`ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é…å¸ƒ** ã§ãã¦ã—ã¾ã†ã¨ã„ã†ã“ã¨ã€‚
ã¡ãªã¿ã«ã€ä¸Šè¨˜ã®å‹•ç”»å†…ã§ã‚‚èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ãŒã€ã“ã®ä»•çµ„ã¿ã¯`CRuby`ã«é™ã£ãŸè©±ã§ã¯ãªã **Wasmã«å‡¦ç†ã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚åŸ‹ã‚è¾¼ã¿ãŸã„** ã‚±ãƒ¼ã‚¹ã§ã‚ã‚Œã°åŠ¹æœã‚ã‚Šã€‚(å‹•ç”»å†…ã§ã‚‚`CPython`ãŒå‹•ã„ãŸã¨è¨€ã‚ã‚Œã¦ã„ã‚‹)

ã“ã®ä»•çµ„ã¿ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«é–‹ç™ºã•ã‚ŒãŸã®ãŒã€`wasi-vfs`ã¨ã„ã†ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã€‚

# [`wasi-vfs`](https://github.com/kateinoigakukun/wasi-vfs)
`wasi-vfs`ã¯ã€ä»»æ„ã®ãƒ‘ã‚¹ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`Wasm`ãƒã‚¤ãƒŠãƒªã«åŸ‹ã‚è¾¼ã‚“ã§ã€WASIã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‹ã‚‰åŸ‹ã‚è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã‚’å·®ã—è¾¼ã‚“ã§ãã‚Œã‚‹ã€‚

# ä½¿ã£ã¦ã¿ã‚‹
ã¨ã‚Šã‚ãˆãšä½¿ã£ã¦ã¿ã‚‹ã€‚
[å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã®`Getting started with CRuby`](https://github.com/kateinoigakukun/wasi-vfs/wiki/Getting-Started-with-CRuby)ã‚’å‚è€ƒã«ã‚„ã£ã¦ã„ãã€‚

## wasi-vfsã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```shell
# WASI_VFSã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®š
$ export WASI_VFS_VERSION=0.2.0

# ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹
$ curl -LO "https://github.com/kateinoigakukun/wasi-vfs/releases/download/v${WASI_VFS_VERSION}/wasi-vfs-cli-x86_64-unknown-linux-gnu.zip"
$ unzip wasi-vfs-cli-x86_64-unknown-linux-gnu.zip
```

## Wasmãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®CRubyã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹
```shell
# ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®CRuby(Wasm)ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹
$ curl -LO https://github.com/ruby/ruby.wasm/releases/download/2022-03-28-a/ruby-head-wasm32-unknown-wasi-full.tar.gz
$ tar xfz ruby-head-wasm32-unknown-wasi-full.tar.gz

# ruby.wasmã«rename
$ mv head-wasm32-unknown-wasi-full/usr/local/bin/ruby ruby.wasm
```

## Packing
```shell
# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã£ã¦ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”¨æ„
$ mkdir src
$ echo "puts 'Hello, wasi-vfs'" > src/my_app.rb

# CRubyã®ãƒã‚¤ãƒŠãƒªã«åŸ‹ã‚è¾¼ã¿
$ wasi-vfs pack ruby.wasm --mapdir /src::./src --mapdir /usr::./head-wasm32-unknown-wasi-full/usr -o my-ruby-app.wasm

# å¼•æ•°ã«åŸ‹ã‚è¾¼ã‚“ã Rubyã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œ
$ wasmer my-ruby-app.wasm -- /src/my_app.rb
Hello, wasi-vfs
```
ãƒ¯ãƒ³ãƒã‚¤ãƒŠãƒªã§å®Ÿè¡Œã§ãã¦ã„ã‚‹ã€‚SUGOIã€‚

# ãƒã‚¤ãƒŠãƒªã¯ã©ã†ãªã£ã¦ã„ã‚‹ã®ã‹ï¼Ÿ
å®Ÿéš›ã«æ‰‹å…ƒã§å‹•ã‹ã™ã“ã¨ãŒã§ããŸæ‰€ã§ã€ã©ã‚“ãªãƒã‚¤ãƒŠãƒªã«ãªã£ã¦ã„ã‚‹ã®ã‹æ°—ã«ãªã‚‹ã®ã§å°‘ã—æ½œã£ã¦ã¿ã‚‹ã€‚

## ä½•ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã‚‹ï¼Ÿ
ã¾ã™ã¯ä½•ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã‚‹ã®ã‹æ°—ã«ãªã‚‹ã€‚
ãƒã‚¤ãƒŠãƒªã‚’ç›´æ¥èª­ã‚€ã®ã¯ãƒœãƒªãƒ¥ãƒ¼ãƒ çš„ã«ã‚‚ã—ã‚“ã©ã„ã®ã§ã€`WAT`ã«å¤‰æ›ã—ã¦ã‹ã‚‰ä¸­èº«ã‚’è¦‹ã¦ã¿ã‚‹ã€‚
```shell
# WATã«å¤‰æ› (wasm2watã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯å‰²æ„›)
$ ./wasm2wat path/to/my-ruby-app.wasm -o path/to/wat-file
```

åãå‡ºã•ã‚ŒãŸ`WAT`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’çœºã‚ã¦ã¿ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã« **ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰(`puts 'Hello, wasi-vfs'`)** ã‚„ **ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹(`my_app.rb`)** ãŒè¦‹ãˆã‚‹ã€‚
```lisp
  ...
  (data (;10456;) (i32.const 20576048) "S.UTF-8\00\10\10\00\00\22\00\00\00puts 'Hello, wasi-vfs!'\0a./wa\11\00\00\00\88\e59\01\18\c99\00\10\00\00\00\12\00\00\00\00KIN\18\00\00\00@\f79\01\13\00\00\000\e69\01p\f79\01\00\00\00\00\13\00\00\00\80\f79\01\a0\f79\01\00\00\00\00\13\00\00\00my_app.rb\00\00\00\11\10\00\00x\06?\01(\e79\01")
  ...
```

ã©ã†ã‚„ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚„ãƒ‘ã‚¹ãŒä¸¸ã€…åŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‚ˆã†ã ã€‚

ãŸã ã€ **ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‘ã‚¹ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã‚‹ã ã‘** ã§ã¯VFSã®ã‚ˆã†ã«æ©Ÿèƒ½ã—ãªã„ã€‚
ãã®è¾ºã«ã¤ã„ã¦ã¯ã€[`wasi-vfs/crates/wasi-vfs-cli/src/module_link.rs`](https://github.com/kateinoigakukun/wasi-vfs/blob/main/crates/wasi-vfs-cli/src/module_link.rs)ã«ã€ **ä¸Šè¨˜ã®ä»–ã«ã©ã‚“ãªã‚‚ã®ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã‚‹ã®ã‹** ãŒã‚³ãƒ¡ãƒ³ãƒˆã§æ›¸ã„ã¦ã‚ã‚‹ã€‚
ã‚ã¡ã‚ƒãã¡ã‚ƒã–ã£ãã‚Šã¾ã¨ã‚ã‚‹ã¨`wasi-vfs`ã¯ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ã‚³ãƒ¼ãƒ‰ã‚’åŸ‹ã‚è¾¼ã‚“ã§ã„ã¦ã€ã“ã‚Œã«ã‚ˆã£ã¦`fd_read`ã¨ã„ã†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‹ã‚‰æ§˜ã€…ãªæŒ™å‹•ã«ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ã‚³ãƒ¼ãƒ‰ã®æŒ™å‹•ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚
- `wasi-vfs`ã§åŸ‹ã‚è¾¼ã¿å‰
  - `wasi-libc`ã®`fd_read`ãŒå‘¼ã°ã‚ŒãŸæ™‚ã€ãã®ã¾ã¾ãƒ›ã‚¹ãƒˆä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«å¯¾ã—ã¦èª­ã¿è¾¼ã‚€å‡¦ç†ã«ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹
- `wasi-vfs`ã§åŸ‹ã‚è¾¼ã¿å¾Œ
  - `wasi-libc`ã®`fd_read`ãŒå‘¼ã°ã‚ŒãŸæ™‚ã€`wasi_vfs_fd_read`ãŒå‘¼ã°ã‚Œåˆ¥ã®`WASI`å®Ÿè£…(`$wasi_vfs_fd_read.command_export`)ã«ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹

## ã©ã†ã‚„ã£ã¦åŸ‹ã‚è¾¼ã‚“ã§ã„ã‚‹ï¼Ÿ
ãªã«ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã‚‹ã®ã‹ã–ã£ãã‚Šã¨ã‚ã‹ã£ãŸã®ã§ã€å®Ÿéš›ã«ã©ã†ã‚„ã£ã¦åŸ‹ã‚è¾¼ã‚“ã§ã„ã‚‹ã®ã‹`wasi-vfs`ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒãƒ©è¦‹ã—ã¦ã¿ã‚‹ã€‚

`wasi-vfs pack`ãŒå®Ÿè¡Œã•ã‚ŒãŸã¨ãã«å‘¼ã°ã‚Œã‚‹ã®ã¯ã€[`wasi-vfs/crates/wasi-vfs-cli/src/lib.rs:49`](https://github.com/kateinoigakukun/wasi-vfs/blob/main/crates/wasi-vfs-cli/src/lib.rs#L49)ã®éƒ¨åˆ†ã€‚
```rust
            ...
            App::Pack {
                input,
                map_dirs,
                output,
            } => {
                ...
                for (guest_dir, host_dir) in map_dirs {
                    wizer.map_dir(guest_dir, host_dir);
                }
                let wasm_bytes = std::fs::read(&input)?;
                let output_bytes = wizer.run(&wasm_bytes)?;
                std::fs::write(output, output_bytes)?;
            }
            ...
```

è¦‹ãŸæ„Ÿã˜ã€åŸ‹ã‚è¾¼ã‚€å‡¦ç†ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã¯`wizer`ã¨ã„ã†ã‚¯ãƒ¬ãƒ¼ãƒˆã‚‰ã—ã„ã€‚
`map_dir`ã« **åŸ‹ã‚è¾¼ã¿å…ƒã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª** ã¨ **åŸ‹ã‚è¾¼ã¿å…ˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª** ã®ãƒ‘ã‚¹ã‚’æ¸¡ã—ã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã‚‹ã€‚

### [`Wizer`](https://github.com/bytecodealliance/wizer)
`map_dir`ã®ç´°ã‹ã„å‡¦ç†ã«ã¤ã„ã¦è¦‹ã¦ã„ãå‰ã«ã€`Wizer`ã«ã¤ã„ã¦è»½ãè¦‹ã¦ã¿ã‚‹ã€‚

> The WebAssembly Pre-Initializer!
`Wizer`ã¯`Wasm`ã®`Pre-Initializer`ã¨ã„ã†ã‚‚ã®ã§ã€`Wasm`ã®ãƒ­ãƒ¼ãƒ‰æ™‚ã«è¡Œã‚ã‚Œã‚‹åˆæœŸåŒ–å‡¦ç†ã‚’äº‹å‰ã«å®Ÿè¡Œã—ã€åˆæœŸåŒ–æ¸ˆã¿ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’`Wasm`ã«æ›¸ãå‡ºã™ã‚‰ã—ã„ã€‚
ã“ã‚Œã«ã‚ˆã£ã¦ã€ãƒ­ãƒ¼ãƒ‰æ™‚é–“ãŒçŸ­ç¸®ã•ã‚Œãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå‘ä¸Šã™ã‚‹ã¨ã®ã“ã¨ã€‚
ã“ã®åˆæœŸåŒ–ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€é–¢æ•°ã‚’renameã—ãŸã‚Šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒã‚¤ãƒŠãƒªã«ãƒãƒƒãƒ—ã™ã‚‹ãªã©ã®å‡¦ç†ã‚’çµ„ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã‚‹ã€‚

### Wizer::map_dir
å®Ÿéš›ã«`wasi-vfs`ã‹ã‚‰å‘¼ã°ã‚Œã¦ã„ã‚‹`map_dir`ãƒ¡ã‚½ãƒƒãƒ‰ã¯[`wizer/src/lib.rs:413`](https://github.com/bytecodealliance/wizer/blob/main/src/lib.rs#L413)ã«ã‚ã‚‹ã€‚
```rust
    ...
    /// When using WASI during initialization, which guest directories should be
    /// mapped to a host directory?
    ///
    /// The `map_dir` method differs from `dir` in that it allows giving a custom
    /// guest name to the directory that is different from its name in the host.
    ///
    /// None are mapped by default.
    pub fn map_dir(
        &mut self,
        guest_dir: impl Into<PathBuf>,
        host_dir: impl Into<PathBuf>,
    ) -> &mut Self {
        self.map_dirs.push((guest_dir.into(), host_dir.into()));
        self
    }
    ...
```
ã‚„ã£ã¦ã„ã‚‹äº‹è‡ªä½“ã¯ã€ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹å¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é…åˆ—ã«è¿½åŠ ã—ã¦ã„ã‚‹ã ã‘ã€‚
ã“ã“ã§è¿½åŠ ã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯å®Ÿéš›ã«åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‚ç…§ã•ã‚Œã‚‹ã€‚

### Wizer::run
`run`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã¯ã€[`wizer/src/lib.rs:460`](https://github.com/bytecodealliance/wizer/blob/main/src/lib.rs#L460)ã€‚
ã“ã“ã¯`map_dir`ã‚‚å«ã‚è«¸ã€…è¨­å®šã•ã‚ŒãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”¨ã„ã¦ã€å®Ÿéš›ã«åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹æ‰€ã€‚
```rust
    ...
    /// Initialize the given Wasm, snapshot it, and return the serialized
    /// snapshot as a new, pre-initialized Wasm module.
    pub fn run(&self, wasm: &[u8]) -> anyhow::Result<Vec<u8>> {
        // Parse rename spec.
        let renames = FuncRenames::parse(&self.func_renames)?;

        ...

        if cfg!(debug_assertions) {
            ...
        }

        let config = self.wasmtime_config()?;
        let engine = wasmtime::Engine::new(&config)?;
        let wasi_ctx = self.wasi_context()?;  // wasi_contextã®å–å¾—
        ...
```
`wasi_context`ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã„ã†ã®ã‚’å‘¼ã³å‡ºã—ã¦ã€WASIå‘ã‘ã®ãƒã‚¤ãƒŠãƒªã‚’åˆæœŸåŒ–ã™ã‚‹ãŸã‚ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
å…ˆç¨‹ãƒãƒƒãƒ”ãƒ³ã‚°å¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¿½åŠ ã—ãŸ`map_dirs`ãŒå‡¦ç†ã•ã‚Œã‚‹ã®ã‚‚ã€ã“ã®`wasi_context`ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸­ã€‚

### Wizer::wasi_context
`wasi_context`ã®å®Ÿæ…‹ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã¯ã€[`wizer/src/lib.rs:673`](https://github.com/bytecodealliance/wizer/blob/main/src/lib.rs#L673)ã€‚
`allow_wasi`ã§WASIã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã‚ˆã†è¨­å®šã•ã‚Œã¦ã„ã‚Œã°`WasiCtxBuilder`ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¦ãƒ“ãƒ«ãƒ€ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹å‡¦ç†ã«ç¶šã„ã¦ã„ã¦ã€ãã†ã§ãªã‘ã‚Œã°`None`ã‚’è¿”ã™ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
```rust
    fn wasi_context(&self) -> anyhow::Result<Option<WasiCtx>> {
        if !self.allow_wasi {
            return Ok(None);
        }

        let mut ctx = wasi_cap_std_sync::WasiCtxBuilder::new();
        ...
        for (guest_dir, host_dir) in &self.map_dirs {
            log::debug!(
                "Preopening directory: {}::{}",
                guest_dir.display(),
                host_dir.display()
            );
            let preopened = wasmtime_wasi::sync::Dir::open_ambient_dir(
                host_dir,
                wasmtime_wasi::sync::ambient_authority(),
            )
            .with_context(|| format!("failed to open directory: {}", host_dir.display()))?;
            ctx = ctx.preopened_dir(preopened, guest_dir)?;
        }
        ...
```
ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹å‡¦ç†ãŒæ›¸ã„ã¦ã‚ã‚‹ã®ã¯[`wizer/blob/main/src/lib.rs:694`](https://github.com/bytecodealliance/wizer/blob/main/src/lib.rs#L694)ã€‚

ã“ã“ã§å‘¼ã°ã‚Œã¦ã„ã‚‹`wasmtime_wasi::sync::Dir::open_ambient_dir`ã¯`cap-std`ã‚¯ãƒ¬ãƒ¼ãƒˆã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã§ã€[`bytecodealliance/cap-std`ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/bytecodealliance/cap-std#how-do-i-obtain-a-dir)ã‚’è¦‹ã¦ã¿ã‚‹ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é–‹ããŸã‚é–¢æ•°ã®ã£ã½ã„ã€‚(ä»Šå›ã¯è©³ç´°ã¯å‰²æ„›)
> Use Dir::open_ambient_dir to open a plain path. This function is not sandboxed, and may open any file the host process has access to.
ãŠãã‚‰ãã€ã“ã®é–¢æ•°ã§å–å¾—ã—ãŸ`Dir`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ€ãƒ¼ã«è©°ã‚è¾¼ã‚“ã§ã€å®Ÿéš›ã«`WasiCtx`ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹éš›ã«ä½¿ã†ã‚“ã ã‚ã†ã€‚

ã¨æ€ã£ã¦ã€[`WasiCtxBuilder.preopened_dir`](https://github.com/bytecodealliance/preview2-prototyping/blob/106d19ae4f76fe2ef05764fafc969fea31c1d583/wasi-common/cap-std-sync/src/lib.rs#L88)ã®å®Ÿè£…ã‚’ãƒãƒ©è¦‹ã—ã¦ã¿ãŸã‚‰ãã‚“ãªé›°å›²æ°—ã€‚
```rust
impl WasiCtxBuilder {
    ...
    pub fn preopened_dir(mut self, fd: u32, dir: Dir) -> Self {
        let dir = Box::new(crate::dir::Dir::from_cap_std(dir));
        self.0.insert_dir(fd, dir);
        self
    }
    ...
```
â¬‡ `preopened_dir`ã‹ã‚‰æ›´ã«å‘¼ã°ã‚Œã¦ã„ã‚‹`insert_dir`ã€‚
```rust
impl WasiCtx {
    ...
    pub fn insert_dir(&mut self, fd: u32, dir: Box<dyn WasiDir>) {
        self.table_mut().insert_at(fd, Box::new(dir))
    }

    ...

    pub fn table(&self) -> &Table {
        &self.table
    }

    pub fn table_mut(&mut self) -> &mut Table {
        &mut self.table
    }
    ...
```
â¬‡ æ›´ã«å‘¼ã°ã‚Œã¦ã„ã‚‹`Table.insert_at`ã€‚
```rust
impl Table {
    ...

    /// Insert a resource at a certain index.
    pub fn insert_at(&mut self, key: u32, a: Box<dyn Any + Send + Sync>) {
        self.map.insert(key, a);
    }
    ...
```
`HashMap`ã«çªã£è¾¼ã‚“ã§ã„ã‚‹ã¿ãŸã„ãªã®ã§ã€å®Ÿéš›ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’èª­ã‚€ã®ã¯`wizer`ã®åˆæœŸåŒ–å‡¦ç†ã§ãƒã‚¤ãƒŠãƒªã‚’å±•é–‹ã™ã‚‹ã¨ãï¼Ÿ

ã“ã†ã‚„ã£ã¦åŸ‹ã‚è¾¼ã¾ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã€æœ€çµ‚çš„ã«[`wasi-vfs/src/trampoline_generated.rs`](https://github.com/kateinoigakukun/wasi-vfs/blob/main/src/trampoline_generated.rs)ãªã©ã®ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ã‚³ãƒ¼ãƒ‰ãŒ`libwasi_vfs.a`ã®å½¢ã§ãƒªãƒ³ã‚¯ã•ã‚ŒãŸãƒã‚¤ãƒŠãƒª(ä»Šå›ã®å ´åˆã¯`CRuby`ã®ãƒã‚¤ãƒŠãƒª)ã‹ã‚‰è¦‹ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦ãªã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ãªã©ã§ã‚‚ãƒ¯ãƒ³ãƒã‚¤ãƒŠãƒªã§é…å¸ƒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¿ãŸã„ã€‚

# æœ€å¾Œã«
å®Ÿéš›ã«æ‰‹å…ƒã§å‹•ã‹ã—ã¦ã¿ã¦ã€ãƒ¯ãƒ³ãƒã‚¤ãƒŠãƒªã§Rubyã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‹•ãã“ã¨ã«ã¯æ„Ÿå‹•ã€‚
[CNCFã®Landscape](https://landscape.cncf.io/?selected=wasm-edge-runtime)çš„ã«ã¯`WasmEdge`ãŒContainer Runtimeã®ã‚«ãƒ†ã‚´ãƒªã«ãƒãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ãŒã€ã“ã®`wasi-vfs`ã‚‚ç›¸ã¾ã£ã¦ç›Šã€…Wasmã‚‚ã‚³ãƒ³ãƒ†ãƒŠæŠ€è¡“ã«è¿‘ã„å°è±¡ã‚’å—ã‘ãŸã€‚
(ã¨ã„ã†ã‹éš”é›¢ã•ã‚ŒãŸãƒ—ãƒ­ã‚»ã‚¹ç©ºé–“ã«ã€ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’åŸ‹ã‚è¾¼ã‚ã‚‹æ¦‚å¿µçš„ã«ã¯ã‚‚ã¯ã‚„ã‚½ãƒ¬ã˜ã‚ƒãªã„ã‹ï¼Ÿ)
åŸ‹ã‚è¾¼ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã«æ¯”ä¾‹ã—ã¦ãƒã‚¤ãƒŠãƒªã‚‚è‚¥å¤§åŒ–ã™ã‚‹ã®ã¯ãã†ãªã®ã ãŒã€ã“ã®è¾ºã®ã‚µã‚¤ã‚ºã¯å‰Šæ¸›ã™ã‚‹æ–¹æ³•ãªã©ã‚ã‚‹ã®ã‹ï¼Ÿ(dockerã¨ã‹ã¯å®Ÿéš›ã«ãƒ“ãƒ«ãƒ‰æ™‚ã«COPYã¨ã‹ã™ã‚‹ã¨ã©ã†ãªã£ã¦ã‚‹ã‚“ã ã‚)
è‰²ã€…æ°—ã«ãªã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ã€ä»Šå¾Œã‚‚èª¿ã¹ã¦Watchã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã—ãŸã€‚

# Appendix
- [`wasi-vfs`ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/kateinoigakukun/wasi-vfs)
- [`wizer`ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/bytecodealliance/wizer)
