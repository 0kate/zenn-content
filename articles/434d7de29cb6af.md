---
title: "wasi-vfsã§ãƒ‘ãƒƒã‚¯ã•ã‚ŒãŸãƒã‚¤ãƒŠãƒª(CRuby)ã‚’çœºã‚ã¦ã¿ãŸ"
emoji: "ğŸ“¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ruby", "webassembly", "wasi", "vfs"]
published: false
---

# wasi-vfsã§ãƒ‘ãƒƒã‚¯ã•ã‚ŒãŸRubyã‚’çœºã‚ã¦ã¿ãŸ
Ruby 3.2.0ã§WASIãƒ™ãƒ¼ã‚¹ã®Wasmãƒã‚¤ãƒŠãƒªã¸ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸã€‚
https://www.ruby-lang.org/ja/news/2022/12/25/ruby-3-2-0-released/

ãã®ä¸­ã§ã‚‚å€‹äººçš„ã«æ°—ã«ãªã£ãŸã®ã¯ã“ã®è¨˜è¼‰ã€‚
> ã•ã‚‰ã«ã€WASIã®ä¸Šã«VFSã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Rubyã‚¢ãƒ—ãƒªã‚’å˜ä¸€ã®.wasmãƒ•ã‚¡ã‚¤ãƒ«ã«å®¹æ˜“ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã§ãã¾ã™ã€‚Rubyã‚¢ãƒ—ãƒªã®é…å¸ƒãŒå°‘ã—ç°¡å˜ã«ãªã‚Šã¾ã™ã€‚

ã©ã†ã„ã†ãƒã‚¤ãƒŠãƒªã«ãªã£ã¦ã„ã‚‹ã®ã‹ãªã©ã€æ°—ã«ãªã£ãŸã®ã§èª¿ã¹ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# WASIã®ä¸Šã«VFSã£ã¦ã©ã†ã„ã†ã“ã¨ï¼Ÿ
`VFS`ã¨ã„ã†ã¨çœŸã£å…ˆã«æ€ã„æµ®ã‹ã‚“ã ã®ãŒã€Unixç³»ã®ã‚·ã‚¹ãƒ†ãƒ ã§èã[ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ (Virtual File System)](https://ja.wikipedia.org/wiki/%E4%BB%AE%E6%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0)ã€‚
èª¿ã¹ã¦ã¿ã‚‹ã¨ã€ãŠãã‚‰ãã“ã‚Œã«è¿‘ã—ã„æ¦‚å¿µã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚

## ãªãœVFSãŒå¿…è¦ã ã£ãŸã®ã‹
ä»Šå›ã®`Ruby 3.2.0`ã§ã€CRubyã‚’WASIå¯¾å¿œã®Wasmãƒã‚¤ãƒŠãƒªã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã‚ã‘ã ãŒã€Rubyã®ã‚ˆã†ãªã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿è¨€èªã®å ´åˆã€è¨€èªå‡¦ç†ç³»ã«åŠ ãˆå‡¦ç†å¯¾è±¡ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚å¿…è¦ã«ãªã‚‹ã€‚
`wasmtime`ã‚„`wasmer`ã¨ã„ã£ãŸãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ä½¿ã£ã¦ã€ç›´æ¥ãƒ›ã‚¹ãƒˆä¸Šã§å®Ÿè¡Œã™ã‚‹ãªã‚‰OSä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å‡ºã›ã‚‹ã‚‚ã®ã®ã€ã“ã‚ŒãŒãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å®Ÿè¡Œã™ã‚‹ã¨ãªã‚‹ã¨è©±ãŒå¤‰ã‚ã£ã¦ãã‚‹ã€‚
ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã‹ã‚‰ç›´æ¥ãƒ›ã‚¹ãƒˆä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ãŸã‚ã€ä»»æ„ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿å‡ºã™ã“ã¨ãŒã§ããªã„ã®ã ã€‚
ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€VFSã¨ã„ã†å½¢ã§ä»®æƒ³çš„ãªãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å‡ºã—ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã‚’æŠ½è±¡åŒ–ã—ãŸã¨ã„ã†ã“ã¨ã ã€‚
VFSã®ãã®å…ˆã®èª­ã¿å‡ºã—ã¯ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã”ã¨ã«å¤šæ§˜æ€§ã‚’æŒãŸã›ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ç’°å¢ƒã§ã‚‚ã€ã©ã“ã‹ã—ã‚‰ã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ç›¸å½“ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒèª­ã¿å‡ºã›ã‚Œã°å•é¡Œãªã„ã¨ã„ã†ã“ã¨ã«ãªã‚‹ã€‚
ã¤ã¾ã‚Šã€ã“ã®VFSãŒã‚ã‚‹ã“ã¨ã§ã€WASIãƒ™ãƒ¼ã‚¹ã®Wasmã§ã‚ã‚Œã°ã©ã“ã§ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒæ‰±ãˆã‚‹ã¨ã„ã†ã“ã¨ã ã€‚

## wasi-vfs
ãªãœWasmã«VFSã¨ã„ã†æ¦‚å¿µãŒå¿…è¦ã ã£ãŸã‹ãŒã‚ã‹ã£ãŸã¨ã“ã‚ã§ã€å®Ÿéš›ã«å®Ÿç¾ã™ã‚‹ã«ã¯`wasi-vfs`ãŒã‚„ã£ã¦ãã‚Œã‚‹ã€‚
ã©ã†ã‚„ã‚‰ã€ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚¤ãƒŠãƒªã«å…¥ã‚Œè¾¼ã‚“ã§ã€ä»»æ„ã®ãƒ‘ã‚¹ã‹ã‚‰èª­ã¿å‡ºã›ã‚‹ã‚ˆã†ã«VFSã®ã‚³ãƒ¼ãƒ‰ã‚’å·®ã—è¾¼ã‚“ã§ãã‚Œã‚‹ã‚‰ã—ã„ã€‚

# ä½¿ã£ã¦ã¿ã‚‹
æ¦‚è¦ãŒã‚ã‹ã£ãŸã®ã§ã¨ã‚Šã‚ãˆãšä½¿ã£ã¦ã¿ã‚‹ã€‚
[å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã®`Getting started with CRuby`](https://github.com/kateinoigakukun/wasi-vfs/wiki/Getting-Started-with-CRuby)ã‚’å‚è€ƒã«ã‚„ã£ã¦ã„ãã€‚

## wasi-vfsã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```shell
# WASI_VFSã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®š
$ export WASI_VFS_VERSION=0.2.0

# ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹
$ curl -LO "https://github.com/kateinoigakukun/wasi-vfs/releases/download/v${WASI_VFS_VERSION}/wasi-vfs-cli-x86_64-unknown-linux-gnu.zip"
$ unzip wasi-vfs-cli-x86_64-unknown-linux-gnu.zip
```

## Wasmãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®CRubyã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹
```shell
# ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®CRuby(Wasm)ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹
$ curl -LO https://github.com/ruby/ruby.wasm/releases/download/2022-03-28-a/ruby-head-wasm32-unknown-wasi-full.tar.gz
$ tar xfz ruby-head-wasm32-unknown-wasi-full.tar.gz

# ruby.wasmã«rename
$ mv head-wasm32-unknown-wasi-full/usr/local/bin/ruby ruby.wasm
```

## Packing
```shell
# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã£ã¦ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”¨æ„
$ mkdir src
$ echo "puts 'Hello, wasi-vfs'" > src/my_app.rb

# CRubyã®ãƒã‚¤ãƒŠãƒªã«åŸ‹ã‚è¾¼ã¿
$ wasi-vfs pack ruby.wasm --mapdir /src::./src --mapdir /usr::./head-wasm32-unknown-wasi-full/usr -o my-ruby-app.wasm

# å¼•æ•°ã«åŸ‹ã‚è¾¼ã‚“ã Rubyã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œ
$ wasmer my-ruby-app.wasm -- /src/my_app.rb
Hello, wasi-vfs
```
å®Ÿè¡Œã§ãã¦ã‚‹ã€‚

# ãƒã‚¤ãƒŠãƒªã¯ã©ã†ãªã£ã¦ã„ã‚‹ã®ã‹ï¼Ÿ

## ä½•ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã‚‹ï¼Ÿ

ãƒã‚¤ãƒŠãƒªã‚’ç›´æ¥èª­ã‚€ã®ã¯ãƒœãƒªãƒ¥ãƒ¼ãƒ çš„ã«ã‚‚ã—ã‚“ã©ã„ã®ã§ã€WATã«å¤‰æ›ã—ã¦ã‹ã‚‰ä¸­èº«ã‚’è¦‹ã¦ã¿ã‚‹ã€‚
```shell
$ ./wasm2wat path/to/my-ruby-app.wasm -o path/to/wat-file
```

ãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰(`puts 'Hello, wasi-vfs'`)ã‚„ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹(`my_app.rb`)ãŒè¦‹ãˆã‚‹ã€‚
```lisp
  ...
  (data (;10469;) (i32.const 20569523) "\05\00\00\00\03\00\00\00local")
  (data (;10470;) (i32.const 20573560) "\10\10\00\00\22\00\00\00puts 'Hello, wasi-vfs'\0a")
  (data (;10471;) (i32.const 20573596) "\11\00\00\00\c8\db9\01\18\c99\00\10\00\00\00\12")
  (data (;10472;) (i32.const 20573620) "\17\00\00\00\80\ed9\01\13\00\00\00p\dc9\01\b0\ed9\01\00\00\00\00\13\00\00\00\c0\ed9\01\e0\ed9\01\00\00\00\00\13\00\00\00my_app.rb\00\00\00Q \00\00\e8\ed9\01\e8\ed9\01")
  (data (;10473;) (i32.const 20573696) "8\ca9\00\0a\00\00\00.\02")
  ...
```

ã©ã†ã‚„ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚„ãƒ‘ã‚¹ã‚’ä¸¸ã€…åŸ‹ã‚è¾¼ã‚“ã§ã„ã‚‹ã‚ˆã†ã ã€‚

## ã©ã†ã‚„ã£ã¦åŸ‹ã‚è¾¼ã‚“ã§ã„ã‚‹ï¼Ÿ
å®Ÿéš›ã«ã©ã†ã‚„ã£ã¦åŸ‹ã‚è¾¼ã‚“ã§ã„ã‚‹ã®ã‹è¦‹ã¦ã¿ã‚‹ãŸã‚ã«ã€`wasi-vfs`ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒãƒ©è¦‹ã—ã¦ã¿ã‚‹ã€‚

`wasi-vfs pack`ã‚’å®Ÿè¡Œã•ã‚ŒãŸã¨ãã«å‘¼ã°ã‚Œã‚‹ã®ã¯ã€[`wasi-vfs/crates/wasi-vfs-cli/src/lib.rs:49`](https://github.com/kateinoigakukun/wasi-vfs/blob/main/crates/wasi-vfs-cli/src/lib.rs#L49)ã®éƒ¨åˆ†ã€‚
```rust
            ...
            App::Pack {
                input,
                map_dirs,
                output,
            } => {
                ...
                for (guest_dir, host_dir) in map_dirs {
                    wizer.map_dir(guest_dir, host_dir);
                }
                let wasm_bytes = std::fs::read(&input)?;
                let output_bytes = wizer.run(&wasm_bytes)?;
                std::fs::write(output, output_bytes)?;
            }
            ...
```

å®Ÿéš›ã«åŸ‹ã‚è¾¼ã‚€å‡¦ç†ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã¯`wizer`ã¨ã„ã†ã‚¯ãƒ¬ãƒ¼ãƒˆã‚‰ã—ã„ã€‚
`map_dir`ã« **åŸ‹ã‚è¾¼ã¿å…ƒã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª** ã¨ **åŸ‹ã‚è¾¼ã¿å…ˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª** ã®ãƒ‘ã‚¹ã‚’æ¸¡ã—ã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã‚‹ã€‚

### Wizer::map_dir
å®Ÿéš›ã«`map_dir`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã¯ã€[`wizer/src/lib.rs:413`](https://github.com/bytecodealliance/wizer/blob/main/src/lib.rs#L413)ã€‚
```rust
    ...
    /// When using WASI during initialization, which guest directories should be
    /// mapped to a host directory?
    ///
    /// The `map_dir` method differs from `dir` in that it allows giving a custom
    /// guest name to the directory that is different from its name in the host.
    ///
    /// None are mapped by default.
    pub fn map_dir(
        &mut self,
        guest_dir: impl Into<PathBuf>,
        host_dir: impl Into<PathBuf>,
    ) -> &mut Self {
        self.map_dirs.push((guest_dir.into(), host_dir.into()));
        self
    }
    ...
```

### Wizer::run


# æœ€å¾Œã«