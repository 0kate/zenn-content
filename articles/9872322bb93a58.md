---
title: "è„†å¼±æ€§ã‹ã‚‰å­¦ã¶Rubyã®ä»•çµ„ã¿(CVE-2022-28739ç·¨)"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ruby", "c"]
published: true
---

# è„†å¼±æ€§ã‹ã‚‰å­¦ã¶Rubyã®ä»•çµ„ã¿(CVE-2022-28739ç·¨)
æœ€è¿‘æ¥­å‹™ã§Rubyã‚’ä½¿ã†ã‚ˆã†ã«ãªã£ãŸã®ã ãŒã€ã“ã‚Œã¾ã§æ¥­å‹™ã§ä½¿ã£ãŸã“ã¨ã®ãªã„è¨€èªã ã£ãŸã®ã§æ—¥ã€…è¨€èªä»•æ§˜ãªã©ã‚’å‹‰å¼·ã—ã¦ã„ã‚‹ã€‚
åŠ ãˆã¦ã€æ¥­å‹™ä¸Šã®åˆ¥ä»¶ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘¨ã‚Šã‚‚å‹‰å¼·ã—ã¦ãŠããŸãã€è‰¯ã„æ©Ÿä¼šãªã®ã§ã€Œ**è„†å¼±æ€§ã®å´é¢ã‹ã‚‰Rubyã®ä»•çµ„ã¿ã«ã¤ã„ã¦å­¦ã¶**ã€ã¨ã„ã†æš´æŒ™ã«å‡ºã¦ã¿ã‚ˆã†ã¨æ€ã†ã€‚

# Ruby
è¨€ã‚ãšã¨ã—ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã®ä¸€ç¨®ã€‚æ—¥æœ¬ç™ºã®è¨€èªã€‚
ã€Œ`Ruby`ã£ã¦ãªã‚“ãã€‚çŸ³ã‹ï¼Ÿã€ã¨ã„ã†æ–¹ã¯[Wikipedia](https://ja.wikipedia.org/wiki/Ruby)å‚ç…§ã€‚

# è„†å¼±æ€§
ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ä¸Šã®ãƒã‚°ã‚„ä»•æ§˜ã®ä¸å…·åˆã‹ã‚‰ç”Ÿã˜ã‚‹ã€**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ¬ é™¥**ã®ç·ç§°ã€‚
äºˆæœŸã›ã¬æŒ™å‹•ã®ã†ã¡ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«ã‚ˆã‚ã—ããªã„æŒ™å‹•ã‚’èµ·ã“ã™ã‚‚ã®ã¨ã‚‚è¨€ãˆã‚‹ï¼Ÿ
ã„ã‚ã‚“ãªæ›¸ç±ã‚„Webã‚µã‚¤ãƒˆã§ã„ã‚ã‚“ãªèª¬æ˜ãŒã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æŠ½è±¡çš„ãªãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã¯ãªã‚“ã¨ãªãã‚ã‹ã‚‹ã‚ˆã†ãªæ°—ãŒã™ã‚‹ãŒã€ã©ã®ã‚ˆã†ã«è¨€èªåŒ–ã™ã‚Œã°ã‚ˆã‚Šæ­£ç¢ºãªèª¬æ˜ã«ãªã‚‹ã®ã‹æœªã ã«ã‚ã‹ã‚‰ãªã„ã€‚
[Wikipedia](https://ja.wikipedia.org/wiki/%E8%84%86%E5%BC%B1%E6%80%A7)ã¯ã“ã¡ã‚‰ã€‚

# CVE-2022-28739
ä»Šå›ã€èª¿æŸ»å¯¾è±¡ã¨ã™ã‚‹è„†å¼±æ€§ã€‚
[å…¬å¼ã®è¨˜è¼‰](https://www.ruby-lang.org/ja/news/2022/04/12/buffer-overrun-in-string-to-float-cve-2022-28739/)ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚
> String ã‚’ Float ã«å¤‰æ›ã™ã‚‹å†…éƒ¨é–¢æ•°ã®ãƒã‚°ã«ã‚ˆã‚Šã€`Kernel#Float`ã‚„`String#to_f`ãªã©ã®ä¸€éƒ¨ã®å¤‰æ›ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒãƒƒãƒ•ã‚¡ã®ã‚ªãƒ¼ãƒãƒ¼ãƒªãƒ¼ãƒ‰ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ å…¸å‹çš„ãªçµæœã¯ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚©ãƒ¼ãƒ«ãƒˆã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ã§ã™ãŒã€é™ã‚‰ã‚ŒãŸçŠ¶æ³ä¸‹ã§ã¯ã€ä¸æ­£ãªãƒ¡ãƒ¢ãƒªèª­ã¿å‡ºã—ã«æ‚ªç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã–ã£ãã‚Šè¨€ã†ã¨ã€**String â†’ Float ã«å¤‰æ›ã™ã‚‹ã¨ããƒ¡ãƒ¢ãƒªã®ã‚ªãƒ¼ãƒãƒ¼ãƒªãƒ¼ãƒ‰**ãŒç™ºç”Ÿã—ã†ã‚‹è„†å¼±æ€§ã€‚(ãã®ã¾ã¾)
[NISTã®è¨˜è¼‰](https://nvd.nist.gov/vuln/detail/CVE-2022-28739)ã‹ã‚‰è¦‹ã‚‹ã«ã€`CVSS`ã®ã‚¹ã‚³ã‚¢ã¯`7.5`ã¨æ¯”è¼ƒçš„é«˜ã‚ï¼Ÿ(`10`ãŒMaxã®ã‚ˆã†ãªã®ã§ã¾ã‚ã¾ã‚é«˜ãã†)
æ™®é€šã«ã‚»ã‚°ãƒ•ã‚©ã§çµ‚ã‚ã‚‹ã‚±ãƒ¼ã‚¹ãŒå¤šã„ã¨ã®ã“ã¨ã ãŒã€ä¸€éƒ¨ãƒ¡ãƒ¢ãƒªèª­ã¿å‡ºã—ãŒã§ãã¦ã—ã¾ã†ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã‚‰ã—ã„ã€‚(ã‚ã¡ã‚ƒãã¡ã‚ƒæ°—ã«ãªã‚‹)

æ—¢ã«[ãƒ‘ãƒƒãƒ](https://github.com/ruby/ruby/commit/69f9992ed41920389d4185141a14f02f89a4d306)ã¯å½“ã¦ã‚‰ã‚Œã¦ã„ã¦ã€`2.6.10`/`2.7.6`/`3.0.4`/`3.1.2`ä»¥é™ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã„ã‚Œã°å¤§ä¸ˆå¤«ã€‚
é€†ã«ã€ã“ã‚Œã‚‰ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³(`2.7.5`ã¨ã‹`3.1.1`ã¨ã‹)ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯ã“ã®è„†å¼±æ€§ã‚’å«ã‚“ã§ã„ã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚‹ã€‚

## ãƒ‘ãƒƒãƒã‚’è¦—ã„ã¦ã¿ã‚‹
å®Ÿéš›ã«å½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒãƒã®å†…å®¹ã‚’è¦‹ã¦ã¿ã‚‹ã€‚
å¤§ããåˆ†ã‘ã‚‹ã¨ã€æœ¬ä½“ã®ã‚³ãƒ¼ãƒ‰ã«ã¯åŠ ãˆã‚‰ã‚Œã¦ã„ã‚‹ä¿®æ­£ã¯2ã¤ã€‚

ä¸€ã¤ç›®ã®å¤‰æ›´ã€‚ãƒã‚¤ãƒ³ã‚¿ã®æŒ‡ã™å…ˆãŒç„¡åŠ¹ãªå€¤ã®å ´åˆã€å¾Œå‡¦ç†ã«ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹åˆ†å²ã‚’è¿½åŠ ã€‚
```c
            if (!*++s || !(s1 = strchr(hexdigit, *s))) goto ret0;
            if (*s == '0') {
                while (*++s == '0');
+               if (!*s) goto ret;
                s1 = strchr(hexdigit, *s);
            }
            if (s1 != NULL) {
```

ï¼’ã¤ç›®ã®å¤‰æ›´ã€‚ãƒã‚¤ãƒ³ã‚¿ãŒæœ‰åŠ¹ã§ã‚ã‚‹å ´åˆã€ç¹°ã‚Šè¿”ã—ã‚’ç¶šã‘ã‚‹æ¡ä»¶ã‚’è¿½åŠ ã€‚
```c
                for (; *s && (s1 = strchr(hexdigit, *s)); ++s) {
                    adj += aadj * ((s1 - hexdigit) & 15);
                    if ((aadj /= 16) == 0.0) {
-                       while (strchr(hexdigit, *++s));
+                       while (*++s && strchr(hexdigit, *s));
                        break;
                    }
                }
```

è„†å¼±æ€§ã«ã¯ã¾ã ãã“ã¾ã§è©³ã—ããªã„ãŒã€å…¥åŠ›å€¤ã«ã‚ˆã£ã¦ã¯ä½•ã‹ãŒèµ·ããã†ãªé¦™ã‚Šã€‚

# è©¦ã—ã¦ã¿ã‚‹
ã¨ã‚Šã‚ãˆãšã‚„ã£ã¦ã¿ãŸã»ã†ãŒæ—©ã„ã®ã§è©¦ã—ã¦ã¿ã‚‹ã€‚

## äº‹å‰æº–å‚™
ã¾ãšã¯ã€è©¦ã—ã¦ã¿ã‚‹ãŸã‚ã®ç’°å¢ƒã‚’ç”¨æ„ã™ã‚‹ã€‚
```shell
# CRubyã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ãã‚‹
$ git clone https://github.com/ruby/ruby.git

# ãƒ‘ãƒƒãƒãŒé©ç”¨ã•ã‚Œã¦ã„ãªã„3.1.1ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
$ git checkout tags/v3_1_1

### ğŸ‘‡ã“ã“ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ã(ä¾å­˜é–¢ä¿‚ã¯ç”¨æ„ã•ã‚Œã¦ã„ã‚‹å‰æ) ###

# configureã‚’ç”Ÿæˆ
$ ./autogen.sh

# ãƒ“ãƒ«ãƒ‰ç”¨ & ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
$ mkdir build && mkdir rubies

# ãƒ“ãƒ«ãƒ‰ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã‚’æŒ‡å®šã—ã¦configureã‚’å®Ÿè¡Œ
$ cd build
$ ../configure --prefix=path/to/ruby/rubies/v3_1_1

# ä½œæˆã•ã‚ŒãŸMakefileã‚’ä½¿ã£ã¦ãƒ“ãƒ«ãƒ‰
$ make install

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«è‰²ã€…ä½œã‚‰ã‚Œã¦ã‚‹ (ä¾‹ãˆã°bin)
$ cd ../rubies/v3_1_1/bin/
$ ls
bundle  bundler  erb  gem  irb  racc  rake  rbs  rdbg  rdoc  ri  ruby  typeprof

# CRuby 3.1.1 ã®ã§ãã‚ãŒã‚Š
$ ./ruby --version
ruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [x86_64-linux]
```
å…¨ç„¶é–¢ä¿‚ãªã„ãŒ`miniruby`ã£ã¦ã„ã†ã®ã‚‚åãå‡ºã•ã‚Œã¦ã¦ã€Œãã‚“ãªã®ã‚‚ã‚ã‚‹ã®ã‹ãƒ»ãƒ»ãƒ»ã€ã¨æ€ã£ãŸã€‚

## å®Ÿè¡Œã—ã¦ã¿ã‚‹
ãƒ‘ãƒƒãƒã«å«ã¾ã‚Œã¦ã„ã‚‹[ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰](https://github.com/ruby/ruby/blob/8d142ecff9af7d60728b8cfa9138e8623985c428/test/ruby/test_float.rb#L175)ã‚’è¦‹ãªãŒã‚‰ã€è©¦ã—ã«æ€ªã—ã„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã€‚

é©å½“ã«`/tmp`ã¨ã‹ã«ã“ã‚“ãªæ„Ÿã˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œã£ã¦ã€
```ruby
2000.times do
  f = Float('0x' + ('0' * 30))
end
```

ãƒ“ãƒ«ãƒ‰ã—ãŸ`3.1.1`ã§å®Ÿè¡Œã€‚
```shell
$ ./ruby --version
ruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [x86_64-linux]

$ ./ruby /tmp/test.rb
<internal:kernel>:173:in `Float': invalid value for Float(): "0x000000000000000000000000000000" (ArgumentError)
	from /tmp/test.rb:9:in `block in invalid_value'
	from /tmp/test.rb:8:in `times'
	from /tmp/test.rb:8:in `invalid_value'
	from /tmp/test.rb:17:in `<main>'
```
ãŸã—ã‹ã«ãªã‚“ã‹è½ã¡ãŸã€‚
ãƒ‘ãƒƒãƒé©ç”¨æ¸ˆã¿ã®`3.1.2`ã§å®Ÿè¡Œã—ã¦ã¿ã¦ã‚‚å•é¡Œãªãå‹•ãã®ãŒã‚ã‹ã‚‹ã€‚
```shell
$ ruby --version
ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]

$ ruby /tmp/test.rb
```

2000å›ãƒ«ãƒ¼ãƒ—ã—ã¦ã‚‹ã¨ã“ã‚ã ãŒã€è©¦ã—ã«å˜ç™ºã§è©¦ã—ã¦ã¿ã‚‹ã¨ä½•äº‹ã‚‚èµ·ããšã«æ­£å¸¸çµ‚äº†ã™ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã¿ãŸã„ã§ã€2000å›ãã‚‰ã„ãƒ«ãƒ¼ãƒ—ã™ã‚Œã°ç¢ºå®Ÿã«ç•°å¸¸ã‚±ãƒ¼ã‚¹è¸ã‚€ã¿ãŸã„ã€‚

# ãƒ‡ãƒãƒƒã‚°ã—ã¦ã¿ã‚‹
å®Ÿéš›ã«ä½•ã‹ãŒèµ·ãã‚‹ã“ã¨ãŒç¢ºèªã§ããŸã¨ã“ã‚ã§ã€ãƒ‘ãƒƒãƒãŒã‚ãŸã£ã¦ã„ã‚‹å‡¦ç†ã‚’ã‚’ã‚‚ã†å°‘ã—æ·±ãè¦‹ã¦ã¿ã‚‹ã€‚

è©²å½“ã®ãƒ‘ãƒƒãƒãŒã‚ãŸã£ã¦ã„ã‚‹ã®ã¯`strtod`ã¨ã„ã†é–¢æ•°ã€‚
```c
double
strtod(const char *s00, char **se)
{
    ...
        switch (*s) {
          ...  // ç¬¦å·ã‚’åˆ¤å®šã—ãŸã‚Šã€ã‚¹ãƒšãƒ¼ã‚¹ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã„ã‚‹ã¨ã“ã‚ãªã®ã§çœç•¥
          default:
            goto break2;
        }
break2:
    if (*s == '0') {
        if (s[1] == 'x' || s[1] == 'X') {
            ...

            if (!*++s || !(s1 = strchr(hexdigit, *s))) goto ret0;
            if (*s == '0') {
                while (*++s == '0');
                if (!*s) goto ret;  // ã“ã“ãŒãƒ‘ãƒƒãƒã®ã¨ã“ã‚â‘ 
                s1 = strchr(hexdigit, *s);
            }
    ...
```
å‰åŠéƒ¨ã§ã€Œç¬¦å·ã®æœ‰ã‚Šç„¡ã—ã‚’åˆ¤å®šã€ã—ãŸã‚Šã€Œã‚¹ãƒšãƒ¼ã‚¹ã‚„ã‚‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã€ã—ãŸã‚Šã—ã¦ã„ã‚‹ã€‚
ãã®å¾Œã€`0x`ã‹`0X`ã§å§‹ã¾ã‚‹å ´åˆã€å¯¾è±¡ã®ãƒ‘ãƒƒãƒãŒã‚ãŸã£ã¦ã„ã‚‹ç®‡æ‰€ã«å…¥ã£ã¦ã„ãã€‚
`0x`ã‹`0X`ã®ç›´å¾Œã‹ã‚‰`'0'(0x30)`ãŒç¶šãé–“ãƒã‚¤ãƒ³ã‚¿ã‚’é€²ã‚ã¦ã€ãã‚Œä»¥å¤–ã®æ–‡å­—ä»¥å¤–ã«åˆ°é”ã—ãŸã‚‰16é€²æ•°æ–‡å­—ã‚’`strchr`ã§æ¢ã—ã¦ã„ã‚‹ã€‚

ã‚‚ã†ä¸€ç®‡æ‰€ã¯å°æ•°ç‚¹ã‚’å«ã‚€å ´åˆã€‚
```c
    ...
        if (*s == '0') {
            while (*++s == '0');
            if (!*s) goto ret;  // ã“ã“ãŒãƒ‘ãƒƒãƒã®ã¨ã“ã‚â‘ 
            s1 = strchr(hexdigit, *s);
        }

        ...

        if (*s == '.') {
            dsign = 1;
            if (!*++s || !(s1 = strchr(hexdigit, *s))) goto ret0;
            if (nd0 < 0) {
                while (*s == '0') {
                    s++;
                    nd0 -= 4;
                }
            }
            for (; *s && (s1 = strchr(hexdigit, *s)); ++s) {
                adj += aadj * ((s1 - hexdigit) & 15);
                if ((aadj /= 16) == 0.0) {
                    while (*++s && strchr(hexdigit, *s));  // ã“ã“ãŒãƒ‘ãƒƒãƒã®ã¨ã“ã‚â‘¡
                    break;
                }
    ...
```

ãªã‚“ã‹è‰²ã€…ã‚„ã£ã¦ã„ã‚‹ã¿ãŸã„ã ãŒã€å®Ÿéš›ã«å‹•ã‹ã—ãªãŒã‚‰è¦‹ãŸã»ã†ãŒã‚ã‹ã‚Šã‚„ã™ãã†ã€‚
ãªã®ã§ã€`gdb`ã¿ãŸã„ãªã®ã‚’ä½¿ã£ã¦å‹•ã‹ã—ãªãŒã‚‰ãƒ‡ãƒãƒƒã‚°ã—ã¦ã¿ã‚‹ã€‚
(ã¤ã„ã§ã«Rubyã®ä»•çµ„ã¿ã«ã¤ã„ã¦ã‚‚å‹‰å¼·ã«ãªã‚‰ãªã„ã¨ä¼ç”»å€’ã‚Œã«ãªã£ã¦ã—ã¾ã†)

## gdbã§ã‚„ã£ã¦ã„ã
ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒ“ãƒ«ãƒ‰ã—ã¦ã€ã•ã£ãã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã€‚
```shell
# ãƒ“ãƒ«ãƒ‰ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
$ cd path/to/ruby/build

# ãƒ‡ãƒãƒƒã‚°ç”¨ã«configure
$ ../configure optflags="-O0" --prefix="path/to/ruby/rubies/v3_1_1"

# ãƒ“ãƒ«ãƒ‰
$ make install
```

ã‚„ã£ã¦ã„ãã€‚
```shell
$ gdb -q --args ./ruby /tmp/test.rb
Reading symbols from ./ruby...

# ã¨ã‚Šã‚ãˆãšæ€ªã—ãã†ãªã¨ã“ã‚(`missing/dtoa.c`ã®`1553`è¡Œç›®)ã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ãŠã„ã¦ã¿ã‚‹
(gdb) break missing/dtoa.c:1553
Breakpoint 1 at 0x2024ba: file ../missing/dtoa.c, line 1553.

# ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã¾ã§é€²ã‚ã‚‹ (ruby_strtodã§æ­¢ã¾ã£ã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚‹)
(gdb) run
Starting program: /home/kate/src/ruby/rubies/v3_1_1/bin/ruby /tmp/test.rb
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".

Breakpoint 1, ruby_strtod (s00=0x7ffff3717038 "0x000000", se=0x7fffffffd3c8) at ../missing/dtoa.c:1553
1553		    if (!*++s || !(s1 = strchr(hexdigit, *s))) goto ret0;

# backtraceã§ã“ã“ã¾ã§ã®é“ã®ã‚Šã‚’å‡ºåŠ›ã—ã¦ã¿ã‚‹
(gdb) backtrace
#0  ruby_strtod (s00=0x7ffff3717038 "0x000000", se=0x7fffffffd3c8) at ../missing/dtoa.c:1553
... (ãŸãã•ã‚“å‡ºã¦ãã‚‹)
#25 0x000055555558399f in main (argc=<optimized out>, argv=<optimized out>) at ../main.c:47
```

`backtrace`ã®å‡ºåŠ›ã‚’è¾¿ã£ã¦ã¿ã‚‹ã¨ã€ã“ã‚“ãªæ„Ÿã˜ã§é¥ã€…ã‚„ã£ã¦ãã¦ã„ã‚‹ã‚‰ã—ã„ã€‚
- **main**  (<= Rubyãƒ—ãƒ­ã‚»ã‚¹ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ)
- ruby_run_node
- rb_ec_exec_node
- rb_vm_exec
- ... (ãŸã¶ã‚“`2000.times`ã¨ã‹å‘¼ã‚“ã§ã‚‹ç®‡æ‰€ã§æœ¬ç­‹ã¨ã¯é–¢ä¿‚ãªã„ã®ã§çœç•¥)
- vm_exec_core
- vm_invoke_builtin_delegate
- invoke_bf
- rb_f_float1
- rb_convert_to_float
- rb_str_to_dbl
- rb_str_to_dbl_raise
- rb_cstr_to_dbl_raise
- **ruby_strtod**  (<= ã“ã“ãŒãƒ‘ãƒƒãƒãŒå½“ãŸã£ã¦ã„ã‚‹é–¢æ•°)

### å‘¼ã³å‡ºã—çµŒè·¯ã‚’è»½ãæŠŠæ¡ã™ã‚‹
Rubyã®ä»•çµ„ã¿ã‚’çŸ¥ã‚‹ãŸã‚ã€ã“ã“ã¾ã§å‘¼ã°ã‚Œã¦ã„ã‚‹é–¢æ•°ã‚’è»½ãç†è§£ã—ã¦ã¿ã‚‹ã€‚

#### main
è¨€ã‚ãšã¨ã—ã‚ŒãŸã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã€‚ã‚·ã‚§ãƒ«ä¸Šã§`ruby`ã¨ã‹å®Ÿè¡Œã™ã‚‹ã¨ã€ã¨ã‚Šã‚ãˆãšã“ã“ã‹ã‚‰å®Ÿè¡ŒãŒå§‹ã¾ã‚‹ã€‚
[`ruby/main.c:34`](https://github.com/ruby/ruby/blob/v3_1_1/main.c#L34)ã«ã‚ã‚‹ã€‚(`3.1.1`ã®å ´åˆ)
```c
...

static int
rb_main(int argc, char **argv)
{
    RUBY_INIT_STACK;
    ruby_init();
    return ruby_run_node(ruby_options(argc, argv));  // <= æ¬¡ã¯ã“ã“
}

// Wasmç³»ã®æ›¸ãåˆ†ã‘ãŒã‚ã£ã¦æ°—ã«ãªã‚‹
#if defined(__wasm__) && !defined(__EMSCRIPTEN__)
int rb_wasm_rt_start(int (main)(int argc, char **argv), int argc, char **argv);
#define rb_main(argc, argv) rb_wasm_rt_start(rb_main, argc, argv)
#endif

int
main(int argc, char **argv)
{
#ifdef RUBY_DEBUG_ENV
    ruby_set_debug_option(getenv("RUBY_DEBUG"));
#endif
#ifdef HAVE_LOCALE_H
    setlocale(LC_CTYPE, "");
#endif

    ruby_sysinit(&argc, &argv);
    return rb_main(argc, argv);
}
```

#### ruby_run_node
ã“ã“ã‹ã‚‰ã©ã‚“ã©ã‚“Rubyæœ¬ä½“ã®å‡¦ç†ã«æ½œã£ã¦ã„ãã€‚

[å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã«å«ã¾ã‚Œã‚‹èª¬æ˜](https://github.com/ruby/ruby/blob/4d28553c7d5393e939ecada5c12d837604d3a42d/doc/extension.rdoc#L1848)ã¯ã“ã‚Œã€‚
> Runs the given compiled source and exits this process. It returns EXIT_SUCCESS if successfully runs the source. Otherwise, it returns other value.

`compiled source`ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€æ—¢ã«æ§‹æ–‡æœ¨ã‹ã‚‰ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ã«å¤‰æ›æ¸ˆã¿ã®ã‚‚ã®ï¼Ÿã‚’å®Ÿè¡Œã™ã‚‹ã€‚
é–¢æ•°è‡ªä½“ã¯ã¯å…¨ç„¶è–„ãã¦ã“ã‚“ãªæ„Ÿã˜ã€‚[`ruby/eval.c:312`](https://github.com/ruby/ruby/blob/v3_1_1/eval.c#L312)ã«ã‚ã‚‹ã€‚(`3.1.1`ã®å ´åˆ)
```c
int
ruby_run_node(void *n)
{
    rb_execution_context_t *ec = GET_EC();
    int status;
    if (!ruby_executable_node(n, &status)) {
        rb_ec_cleanup(ec, (NIL_P(ec->errinfo) ? TAG_NONE : TAG_RAISE));
        return status;
    }
    ruby_init_stack((void *)&status);
    return rb_ec_cleanup(ec, rb_ec_exec_node(ec, n));
}
```
å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼Ÿã®å–å¾—ã€ã‚¹ã‚¿ãƒƒã‚¯ã®åˆæœŸåŒ–ã¨ã‹ã‚’ã‚„ã£ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚

#### rb_ec_exec_node
[`ruby/eval.c:271`](https://github.com/ruby/ruby/blob/v3_1_1/eval.c#L271)ã«ã‚ã‚‹ã€‚(`3.1.1`ã®å ´åˆ)
æ¸¡ã•ã‚ŒãŸå‘½ä»¤åˆ—(`iseq`)ã‚’VMã®å®Ÿè¡Œã«å¼•ãæ¸¡ã—ã¦ã„ã‚‹ã€‚ã“ã¡ã‚‰ã‚‚é–¢æ•°çš„ã«å…¨ç„¶å¤§ãããªãã“ã‚“ãªæ„Ÿã˜ã€‚
`iseq`ã¯`Instruction Sequence`ã®ã“ã¨ã€‚
```c
static int
rb_ec_exec_node(rb_execution_context_t *ec, void *n)
{
    volatile int state;
    rb_iseq_t *iseq = (rb_iseq_t *)n;
    if (!n) return 0;

    EC_PUSH_TAG(ec);
    if ((state = EC_EXEC_TAG()) == TAG_NONE) {
        rb_thread_t *const th = rb_ec_thread_ptr(ec);
        SAVE_ROOT_JMPBUF(th, {
            rb_iseq_eval_main(iseq);
        });
    }
    EC_POP_TAG();
    return state;
}
```
`PUSH`ã¨ã‹`EXEC`ã¨ã‹`POP`ã¨ã‹ã—ã¦ã‚‹`TAG`ã£ã¦ãªã‚“ã ã‚ã€‚

#### rb_vm_exec
ã“ã®åå‰ã«ç›´æ¥è©²å½“ã™ã‚‹é–¢æ•°ãŒè¦‹å½“ãŸã‚‰ãªã„ã€‚ãƒã‚¯ãƒ­ã¨ã‹ã§å¤‰æ›ã•ã‚Œã¦ã‚‹ï¼Ÿ(Cè¨€èªåŠ›ãŒè¶³ã‚Šã¦ãªã„ã‹æ¢ã—ãã‚Œã¦ãªã„)

#### vm_exec_core
[`ruby/vm_exec.c:172`](https://github.com/ruby/ruby/blob/v3_1_1/vm_exec.c#L173)ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã€‚(`3.1.1`ã®å ´åˆ)
ã“ã“ã§Rubyã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡ã™ãƒã‚¤ãƒ³ã‚¿ã§ã‚ã‚‹`VALUE`å‹ãŒå‡ºã¦ãã¦ã„ã‚‹ã€‚
ã“ã®è¾ºã‹ã‚‰Rubyãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ã‚‚Rubyã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã£ã¦ã‚‹ï¼Ÿ
```c
static VALUE
vm_exec_core(rb_execution_context_t *ec, VALUE initial)
{
    register rb_control_frame_t *reg_cfp = ec->cfp;
    rb_thread_t *th;

    while (1) {
	reg_cfp = ((rb_insn_func_t) (*GET_PC()))(ec, reg_cfp);

	if (UNLIKELY(reg_cfp == 0)) {
	    break;
	}
    }

    if ((th = rb_ec_thread_ptr(ec))->retval != Qundef) {
	VALUE ret = th->retval;
	th->retval = Qundef;
	return ret;
    }
    else {
	VALUE err = ec->errinfo;
	ec->errinfo = Qnil;
	return err;
    }
}
```

#### vm_invoke_builtin_delegate
[`ruby/vm_insnhelper.c:5920`](https://github.com/ruby/ruby/blob/v3_1_1/vm_insnhelper.c#L5920)ã«ã‚ã‚‹ã€‚(`3.1.1`ã®å ´åˆ)
å¼•æ•°ã®æ•°ã«ã‚ˆã£ã¦çµ„ã¿è¾¼ã¿é–¢æ•°ã‚’å‘¼ã³åˆ†ã‘ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚`rb_builtin_funcntion`å‹ã®ãƒã‚¤ãƒ³ã‚¿ãŒçµ„ã¿è¾¼ã¿é–¢æ•°ã¸ã®é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‹ï¼Ÿ
```c
static VALUE
vm_invoke_builtin_delegate(rb_execution_context_t *ec, rb_control_frame_t *cfp, const struct rb_builtin_function *bf, unsigned int start_index)
{
    if (0) { // debug print
        fputs("vm_invoke_builtin_delegate: passing -> ", stderr);
        for (int i=0; i<bf->argc; i++) {
            ruby_debug_printf(":%s ", rb_id2name(cfp->iseq->body->local_table[i+start_index]));
        }
        ruby_debug_printf("\n" "%s %s(%d):%p\n", RUBY_FUNCTION_NAME_STRING, bf->name, bf->argc, bf->func_ptr);
    }

    if (bf->argc == 0) {
        return invoke_bf(ec, cfp, bf, NULL);
    }
    else {
        const VALUE *argv = cfp->ep - cfp->iseq->body->local_table_size - VM_ENV_DATA_SIZE + 1 + start_index;
        return invoke_bf(ec, cfp, bf, argv);
    }
}
```

#### invoke_bf
[`ruby/vm_insnhelper.c:5904`](https://github.com/ruby/ruby/blob/v3_1_1/vm_insnhelper.c#L5904)ã«ã‚ã‚‹ã€‚(`3.1.1`ã®å ´åˆ)
`lookup_builtin_invoker`ã§çµ„ã¿è¾¼ã¿ã®ä½•ã‹ã—ã‚‰ã‚’æ¤œç´¢ã—ã¦å‘¼ã³å‡ºã—ã¦ã‚‹ã€‚`bf`ã¯`builtin function`ã®ç•¥ã£ã½ã„ã€‚
`SETUP_CANARY`ã¨ã‹`CHECK_CANARY`ã§è‰²ã€…ã‚„ã£ã¦ã„ã‚‹`canary`ã¯ã€[ã‚¹ã‚¿ãƒƒã‚¯ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼å¯¾ç­–](https://en.wikipedia.org/wiki/Buffer_overflow_protection#Canaries)ã®ã‚ˆã†ãªé›°å›²æ°—ã‚ã‚‹ã€‚
```c
static inline VALUE
invoke_bf(rb_execution_context_t *ec, rb_control_frame_t *reg_cfp, const struct rb_builtin_function* bf, const VALUE *argv)
{
    const bool canary_p = ISEQ_BODY(reg_cfp->iseq)->builtin_inline_p; // Verify an assumption of `Primitive.attr! 'inline'`
    SETUP_CANARY(canary_p);
    VALUE ret = (*lookup_builtin_invoker(bf->argc))(ec, reg_cfp->self, argv, (rb_insn_func_t)bf->func_ptr);
    CHECK_CANARY(canary_p, BIN(invokebuiltin));
    return ret;
}
```

#### rb_f_float1
ã“ã®è¾ºã‚Šã‹ã‚‰å¤‰æ›å‡¦ç†ã£ã½ã„é›°å›²æ°—ãŒé†¸ã—å‡ºã•ã‚Œã¦ãã‚‹ã€‚

æœ€åˆã«å‘¼ã°ã‚Œã‚‹`rb_f_float_1`ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚å ´æ‰€ã¯ã€[`ruby/object.c:3534`](https://github.com/ruby/ruby/blob/v3_1_1/object.c#L3534)ã€‚
```c
static VALUE
rb_f_float1(rb_execution_context_t *ec, VALUE obj, VALUE arg)
{
    return rb_convert_to_float(arg, TRUE);
}
```
çµ„ã¿è¾¼ã¿é–¢æ•°ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ã—ã¦ã¾ãšã“ã®é–¢æ•°ãŒå‘¼ã°ã‚Œã€ãã“ã‹ã‚‰å®Ÿéš›ã®å¤‰æ›å‡¦ç†ã«æ¸¡ã—ã¦ã„ã‚‹ã€‚
`VALUE`å‹ã®å¼•æ•°ã«ã¯ã€ãƒ¬ã‚·ãƒ¼ãƒãƒ¼ã¨ãªã‚‹Rubyã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ãƒã‚¤ãƒ³ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹ã¿ãŸã„ã€‚

#### rb_convert_to_float
æ¬¡ã«å‘¼ã°ã‚Œã‚‹`rb_convert_to_float`ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚[`ruby/object.c:3498`](https://github.com/ruby/ruby/blob/v3_1_1/object.c#L3498)ã«ã‚ã‚‹ã€‚
```c
static VALUE
rb_convert_to_float(VALUE val, int raise_exception)
{
    switch (to_float(&val, raise_exception)) {
      case T_FLOAT:
        return val;
      case T_STRING:
        if (!raise_exception) {
            int e = 0;
            double x = rb_str_to_dbl_raise(val, TRUE, raise_exception, &e);
            return e ? Qnil : DBL2NUM(x);
        }
        return DBL2NUM(rb_str_to_dbl(val, TRUE));
      case T_NONE:
        if (SPECIAL_CONST_P(val) && !raise_exception)
            return Qnil;
    }

    if (!raise_exception) {
        int state;
        VALUE result = rb_protect(convert_type_to_float_protected, val, &state);
        if (state) rb_set_errinfo(Qnil);
        return result;
    }

    return rb_convert_type_with_id(val, T_FLOAT, "Float", id_to_f);
}
```
å‘¼ã³å‡ºã—å…ƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚ˆã£ã¦ã€å¤‰æ›å‡¦ç†ã‚’å‘¼ã³åˆ†ã‘ã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚‹ã€‚
- `T_FLOAT`(æµ®å‹•å°æ•°ç‚¹æ•°)ã®å ´åˆ
  â ãã®ã¾ã¾è¿”ã™
- `T_STRING`(æ–‡å­—åˆ—)ã®å ´åˆ
  â `rb_str_to_dbl_raise`ã‚’å‘¼ã³å‡ºã™
- `T_NONE`(nil)ã®å ´åˆ
  â `nil`ã‚’è¿”ã™

ç¬¬1å¼•æ•°ã«å¤‰æ›å¯¾è±¡ã®Rubyã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®å‚ç…§ã€ç¬¬2å¼•æ•°ã«ã¯ä½•ã‹ã‚ã£ãŸã‚‰ä¾‹å¤–ã‚’æŠ•ã’ã‚‹ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã¿ãŸã„ã€‚

#### rb_str_to_dbl_raise
æ›´ã«æ¬¡ã«å‘¼ã°ã‚Œã‚‹ã®ã¯`rb_str_to_dbl_raise`ã€‚[`ruby/object.c:3377`](https://github.com/ruby/ruby/blob/v3_1_1/object.c#L3377)ã«ã‚ã‚‹ã€‚
```c
static double
rb_str_to_dbl_raise(VALUE str, int badcheck, int raise, int *error)
{
    char *s;
    long len;
    double ret;
    VALUE v = 0;

    StringValue(str);
    s = RSTRING_PTR(str);
    len = RSTRING_LEN(str);
    if (s) {
        if (badcheck && memchr(s, '\0', len)) {
            if (raise)
                rb_raise(rb_eArgError, "string for Float contains null byte");
            else {
                if (error) *error = 1;
                return 0.0;
            }
        }
        if (s[len]) {		/* no sentinel somehow */
            char *p = ALLOCV(v, (size_t)len + 1);
            MEMCPY(p, s, char, len);
            p[len] = '\0';
            s = p;
        }
    }
    ret = rb_cstr_to_dbl_raise(s, badcheck, raise, error);
    if (v)
        ALLOCV_END(v);
    return ret;
}
```
åˆ†å²ã«å…¥ã‚‹å‰ã«ã€Rubyã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ–‡å­—åˆ—ã‚’æ‰±ã£ã¦ã„ã‚‹`RString`ã‹ã‚‰ã€Œç”Ÿã®æ–‡å­—åˆ—ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã€ã€Œæ–‡å­—åˆ—ã®é•·ã•ã€ã‚’å–ã‚Šå‡ºã—ã¦ã€æ¬¡ã®`rb_cstr_to_dbl_raise`ã«æ¸¡ã—ã¦ã„ã‚‹ã€‚

#### rb_cstr_to_dbl_raise
ã¾ãŸã•ã‚‰ã«æ¬¡ã«å‘¼ã°ã‚Œã‚‹`rb_cstr_to_dbl_raise`ã€‚ã“ã‚Œã¯ã¡ã‚‡ã£ã¨é•·ã„ã®ã§é‡è¦ãã†ãªéƒ¨åˆ†ã ã‘æŠœç²‹ã€‚å ´æ‰€ã¯[`ruby/object.c:3255`](https://github.com/ruby/ruby/blob/v3_1_1/object.c#L3255)ã€‚
```c
static double
rb_cstr_to_dbl_raise(const char *p, int badcheck, int raise, int *error)
{
    ...

    d = strtod(p, &end);
    ...
    if (*end) {
        ...

        while (p < end && n < e) prev = *n++ = *p++;
        while (*p) {
            if (*p == '_') {
                ...
            }
            prev = *p++;
            if (e == init_e && (prev == 'e' || prev == 'E' || prev == 'p' || prev == 'P')) {
                ...
            }
            else if (ISSPACE(prev)) {
                ...
            }
            else if (prev == '.' ? dot_seen++ : !ISDIGIT(prev)) {
                if (badcheck) goto bad;
                break;
            }
            if (n < e) *n++ = prev;
        }
    ...
  bad:
    if (raise) {
        rb_invalid_str(q, "Float()");
        UNREACHABLE_RETURN(nan(""));
    }
    else {
        if (error) *error = 1;
        return 0.0;
    }
}
```
`bad`ãƒ©ãƒ™ãƒ«ã®ç®‡æ‰€ã‚’è¦‹ã‚‹ã¨ã€ã“ã“ã«æ¥ãŸå ´åˆ`rb_invalid_str`ã¨ã—ã¦ä¾‹å¤–ãŒç™ºç”Ÿã•ã›ã‚‹ã¿ãŸã„ã€‚

#### rb_strtod
å…ˆã®é–¢æ•°ã®ä¸­ã§ã¤ã„ã«å‘¼ã°ã‚Œã‚‹ã®ãŒã€ä»Šå›ãƒ‘ãƒƒãƒãŒå½“ãŸã£ã¦ã„ãŸ`rb_strtod`ã€‚
ã“ã“ã¾ã§ã®å‡¦ç†ã‚’è¦‹ã‚‹ã«ã€Rubyã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å–ã‚Šå‡ºã—ãŸç”Ÿã®æ–‡å­—åˆ—ã‚’`double`å‹ã«å¤‰æ›ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£çš„ãªé–¢æ•°ã¿ãŸã„ã€‚
å®Ÿéš›ã€[`ruby/util.c:613`](https://github.com/ruby/ruby/blob/7400628cb054a9a9651d69411a100fc9d518099f/util.c#L613)ã¨ã„ã†æ˜ã‚‰ã‹ã«ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ã¾ã¨ã‚ãŸã‚ˆã†ãªåå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€`strtod`ã‹ã‚‰`ruby_strtod`ã«ç½®ãæ›ãˆã¦ã„ã‚‹è¨˜è¼‰ãŒè¦‹ã¦å–ã‚Œã‚‹ã€‚

[`missing/dtoa.c:36`](https://github.com/ruby/ruby/blob/d0a822eec524522d81ffc7da2bb1baf906b0318a/missing/dtoa.c#L36)ã«ã“ã‚“ãªè¨˜è¼‰ãŒã‚ã‚‹ã€‚
```c
 * This strtod returns a nearest machine number to the input decimal
 * string (or sets errno to ERANGE).  With IEEE arithmetic, ties are
 * broken by the IEEE round-even rule.  Otherwise ties are broken by
 * biased rounding (add half and chop).
```
ãªã«ã‚„ã‚‰å…¥åŠ›ã•ã‚ŒãŸæ–‡å­—åˆ—ã‹ã‚‰ã€æœ€é©ãªãƒã‚·ãƒ³ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«å¯¾å¿œã™ã‚‹ç•ªå·ã‚’è¿”ã™ã‚‰ã—ã„ã€‚(è„³æ­»)
1ã¤ç›®ã®å¼•æ•°ã§å¯¾è±¡ã®æ–‡å­—åˆ—ã€2ã¤ç›®ã®å¼•æ•°ã«çµ‚ç«¯ã‚’å‘¼ã³å‡ºã—å…ƒã«ä¼ãˆã‚‹ãŸã‚ã®ãƒã‚¤ãƒ³ã‚¿ãŒæ¸¡ã•ã‚Œã‚‹ã€‚
ã“ã®é–¢æ•°ã¯å¾Œã€…é‡è¦ãªéƒ¨åˆ†ã‚’ã‹ã„ã¤ã¾ã‚“ã§ã„ããŸã‚ã€ã‚³ãƒ¼ãƒ‰ã¯å‰²æ„›ã€‚

### ãƒ¡ãƒ¢ãƒªã®ä¸­ã‚’è¦‹ã¦ã¿ã‚‹
ã–ã£ãã‚Šã¨ãƒ‘ãƒƒãƒãŒå½“ãŸã£ã¦ã„ã‚‹é–¢æ•°ã¾ã§ã®é“ã®ã‚Šã«ã¤ã„ã¦æŠŠæ¡ã—ãŸæ‰€ã§ã€å®Ÿéš›ã«ãƒ‡ãƒãƒƒã‚°ã‚’ã‚„ã£ã¦ã„ãã€‚

ã¾ãšã¯ã€`strtod`ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹å‰å¾Œã§æ­¢ã‚ã¦å¼•æ•°ãŒã©ã†ãªã£ã¦ã„ã‚‹ã‹è¦‹ã¦ã¿ã‚‹ã€‚
å‘¼ã³å‡ºã—ã¦ã‚‹ã®ã¯`object.c`ã®ã“ã“ã€‚
```c
3274 |    }
3275 |
3276 |    d = strtod(p, &end);  // <= ã“ã“ã§å‘¼ã³å‡ºã—ã¦ã‚‹
3277 |    if (errno == ERANGE) {
3288 |        OutOfRange();
```

ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¦å‹•ã‹ã—ã¦ã„ãã€‚
```shell
# ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š
(gdb) break object.c:3275
Breakpoint 1 at 0xf4865: file ../object.c, line 3276.
(gdb) break object.c:3277
Breakpoint 2 at 0xf487b: file ../object.c, line 3277.

# ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹• (strtodã‚’å‘¼ã³å‡ºã™ç›´å‰ã§æ­¢ã¾ã‚‹)
(gdb) run
Starting program: path/to/ruby/rubies/v3_1_1/bin/ruby /tmp/test.rb
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".

Breakpoint 1, rb_cstr_to_dbl_raise (p=p@entry=0x555555bf8470 "0x", '0' <repeats 30 times>, badcheck=badcheck@entry=1, raise=raise@entry=1, error=error@entry=0x0) at ../object.c:3276
3276	    d = strtod(p, &end);

# pã¨endã‚’å‡ºåŠ›
(gdb) p p
$1 = 0x555555bf8470 "0x", '0' <repeats 30 times>
(gdb) p end
$2 = 0x5555556f90da <rb_st_update+570> "\205\300\017\204~"

# strtodã‚’å‘¼ã³å‡ºã—ãŸç›´å¾Œã¾ã§é€²ã‚ã‚‹
(gdb) c
Continuing.

Breakpoint 2, rb_cstr_to_dbl_raise (p=p@entry=0x555555bf8470 "0x", '0' <repeats 30 times>, badcheck=badcheck@entry=1, raise=raise@entry=1, error=error@entry=0x0) at ../object.c:3277
3277	    if (errno == ERANGE) {

# pã¨endã‚’å‡ºåŠ›
(gdb) p p
$3 = 0x555555bf8470 "0x", '0' <repeats 30 times>
(gdb) p end
$4 = 0x555555bf8492 "tion.f!"
```
ã‚“ï¼Ÿ`end`ãŒçŸ¥ã‚‰ãªã„å­ã‚’æŒ‡ã—ã¦ãªã„ã‹...ï¼Ÿæ˜ã‚‰ã‹ã«ãªã‚“ã‹ã®æ–‡å­—åˆ—ã£ã½ã„ã€‚

ã•ã‚‰ã«ã“ã®ã¾ã¾é€²ã‚ã‚‹ã¨ä¾‹å¤–ã§è½ã¡ã‚‹ã€‚(æœ¬æ¥`0.0`ãŒè¿”ã£ã¦ãã¦ã»ã—ã„)
```shell
(gdb) c
Continuing.
<internal:kernel>:173:in `Float': invalid value for Float(): "0x000000000000000000000000000000" (ArgumentError)
	from /tmp/test.rb:9:in `block in invalid_value'
	from /tmp/test.rb:8:in `times'
	from /tmp/test.rb:8:in `invalid_value'
	from /tmp/test.rb:15:in `<main>'
[Inferior 1 (process 22960) exited with code 01]
```

`tion.f!`ã£ã¦ãªã‚“ãã€‚
ä»Šã¯30æ–‡å­—ã§å‹•ã‹ã—ã¦ã„ã‚‹ã‘ã©ã€ã‚‚ã—ã‹ã—ãŸã‚‰æ–‡å­—æ•°æ¸›ã‚‰ã™ã¨ã‚‚ã£ã¨å‰ã®æ–‡å­—ã‚‚è¦‹ãˆã‚‹ã‹ã‚‚ï¼Ÿã¨æ€ã£ã¦ã‚„ã£ã¦ã¿ãŸã‚‰è¦‹ãˆãŸã€‚(22æ–‡å­—ã«æ¸›ã‚‰ã—ãŸ)
```shell
(gdb) p end
$160 = 0x555555c3e13b "ification.fin!"
```

ã¡ãªã¿ã«20æ–‡å­—ã«ã™ã‚‹ã¨ç©ºæ–‡å­—ãŒå…¥ã£ã¦ã„ãŸã€‚
21æ–‡å­—ã«ã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã§ã‚ˆãã‚ã‹ã‚‰ã‚“ã®ãŒå…¥ã£ã¦ã„ã‚‹ã€‚
```shell
(gdb) p end
$161 = 0x7ffff3716e70 "\005@U"
```

ã•ã‚‰ã«ã€ä½•å›ã‹ã«ä¸€å›ä¸€ç™ºã§è½ã¡ãªã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ™‚ã‚‚ã‚ã‚‹ã€‚
```shell
# 1å›ç›®ã®ãƒ«ãƒ¼ãƒ—
(gdb) p end
$51 = 0x555555c34161 ""

# 2å›ç›®
(gdb) p end
$52 = 0x555555b81ce1 "\r"

# 3å›ç›®
(gdb) p end
$53 = 0x555555c7c491 ""

# 4å›ç›® (å¤‰ãªã¨ã“ã‚æŒ‡ã—ã¦ã‚‹)
(gdb) p end
$54 = 0x555555c655d1 "\250\307UUU"

# è½ã¡ã‚‹
(gdb) c
Continuing.
<internal:kernel>:173:in `Float': invalid value for Float(): "0x000000000000000000000000000000" (ArgumentError)
	from /tmp/test.rb:9:in `block in invalid_value'
	from /tmp/test.rb:8:in `times'
	from /tmp/test.rb:8:in `invalid_value'
	from /tmp/test.rb:15:in `<main>'
[Inferior 1 (process 23274) exited with code 01]
```

æŒ‡ã—ã¦ã„ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã¤ã„ã¦ã¯ã€ãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ—ã‚’è¦‹ã¦ã¿ã‚‹ã¨é–“é•ã„ãªãRubyãƒ—ãƒ­ã‚»ã‚¹ã®ãƒ’ãƒ¼ãƒ—ä¸Šã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚
(Linuxã§ä½œæ¥­ã—ã¦ã„ã‚‹ã®ã§ã€`/proc/{PID}/maps`ã‚’è¦‹ã‚‹)
```shell
...
55555599f000-555555ca2000 rw-p 00000000 00:00 0                          [heap]
...
```

#### å‰ä½ã‚“ã§ãŸä½äººã®åæ®‹...ï¼Ÿ
ãªã‚“ã ã“ã‚Œ...ã¨æ€ã£ã¦ãŸã‚‰ã€`"\250\307UUU"`æœ«å°¾ã®`UUU`ã®éƒ¨åˆ†ãŒã¡ã‚‡ã£ã¨è¦‹ãŸã“ã¨ã‚ã‚‹æ°—ãŒã—ã¦ããŸã€‚

ç­†è€…`Emacs`ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã ãŒã€`Emacs`ã®ãƒ¢ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ³ã®å·¦ç«¯ã«æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ã™è¨˜å·ã¨ã—ã¦`UUU`ã¨ã‹è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚
ã‚‚ã—ã‹ã—ã¦ã€ãã®ãƒ¢ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ³ã®å·¦ç«¯ã«è¡¨ç¤ºã•ã‚Œã‚‹æ–‡å­—åˆ—ãŒã“ã“ã«æ›¸ãè¾¼ã¾ã‚Œã¦ãŸåæ®‹...ï¼Ÿ
`ification.fin!`ã‚‚ã©ã“ã‹ã§ä½¿ã‚ã‚Œã¦ãŸæ–‡å­—åˆ—ã®ä¸€éƒ¨ã‹ã‚‚...

## ä½•ãŒèµ·ãã¦ã„ã‚‹ã®ã‹
ã—ã°ã‚‰ãçœºã‚ã¦ã„ãŸã‚‰ã€ãªã‚“ã¨ãªãä½•ãŒèµ·ãã¦ã„ã‚‹ã®ã‹ã‚ã‹ã£ã¦ããŸã€‚
ãƒã‚¤ãƒ³ã‚¿ãŒæ„å›³ã›ã¬å ´æ‰€ã‚’æŒ‡ã—ã¦ã„ã‚‹èƒŒæ™¯ã¨ã—ã¦ã¯ã“ã‚“ãªæ„Ÿã˜ã¿ãŸã„ã€‚

**â‘  ãƒã‚¤ãƒ³ã‚¿ãŒæ–‡å­—åˆ—ã®çµ‚ç«¯ã¾ã§åˆ°é”ã™ã‚‹**
ã¾ãšã¯ã€æ–‡å­—`'0'(0x30)`ãŒç¶šã„ã¦ã„ã‚‹é–“ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã„ã‚‹ã¨ã“ã‚ã€‚
`'0'(0x30)`ã—ã‹å«ã¾ã‚Œãªã„å ´åˆã€çµ‚ç«¯ã®NULLæ–‡å­—(`0x00`)ã¾ã§ãƒã‚¤ãƒ³ã‚¿`*s`ãŒé€²ã‚“ã§æ­¢ã¾ã‚‹ã€‚
ã“ã®ç›´å¾Œã§ã€16é€²æ•°ã®æ–‡å­—ãŒåˆ—æŒ™ã•ã‚Œã¦ã„ã‚‹æ–‡å­—åˆ—`hexdigit`ã‹ã‚‰`*s`ã‚’æ¢ç´¢ã—ãŸæ™‚ã«ã€çµ‚ç«¯ã®NULLæ–‡å­—ã«å¼•ã£ã‹ã‹ã‚Š`s1`ã«ã¯`hexdigit`ã®çµ‚ç«¯ã‚’æŒ‡ã™ãƒã‚¤ãƒ³ã‚¿ãŒä»£å…¥ã•ã‚Œã¦ã„ã‚‹ã¿ãŸã„ã€‚
```c
    if (*s == '0') {
		while (*++s == '0');  // ã“ã“ã§'0(0x30)'ã®é–“é€²ã‚€
		s1 = strchr(hexdigit, *s);
    }
```

ã“ã®æ™‚ç‚¹ã§å¤‰æ•°`s`ãƒ»`s1`ã®çŠ¶æ³ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚
```shell
s  => å¤‰æ›å¯¾è±¡ã®æ–‡å­—åˆ—ã®çµ‚ç«¯ã‚’æŒ‡ã™ãƒã‚¤ãƒ³ã‚¿
s1 => `hexdigit`ã®çµ‚ç«¯ã‚’æŒ‡ã™ãƒã‚¤ãƒ³ã‚¿
```

**â‘¡ å¤‰æ›å¯¾è±¡ã®æ–‡å­—åˆ—ã‚’æŒ‡ã™`s`ã®çµ‚ç«¯ã‹ã‚‰å…ˆã«ãƒã‚¤ãƒ³ã‚¿ãŒé€²ã‚€**
ãã®å¾Œä»¥ä¸‹ã®ã‚ˆã†ãªå‡¦ç†ãŒæ¥ã‚‹ãŒã€`s1`ã«ã¯`hexdigit`ã®çµ‚ç«¯ã‚’æŒ‡ã™ãƒã‚¤ãƒ³ã‚¿ãŒä»£å…¥ã•ã‚Œã¦ã„ã‚‹ã®ã§`NULL`ã¨ãªã‚‰ãšãƒ«ãƒ¼ãƒ—ã«çªå…¥ã€‚
`do-while`ã«ã‚ˆã£ã¦`s`ãŒçµ‚ç«¯ã‚ˆã‚Šã‚‚ã•ã‚‰ã«å…ˆã¾ã§é€²ã‚ã‚‰ã‚Œã‚‹ã€‚(`hexdigit`ã«ãƒãƒƒãƒã™ã‚‹é–“é€²ã¿ç¶šã‘ã‚‹)
```c
    if (s1 != NULL) {
		do {
		    adj += aadj * ((s1 - hexdigit) & 15);
		    nd0 += 4;
		    aadj /= 16;
		} while (*++s && (s1 = strchr(hexdigit, *s)));  // ã“ã“ã§ã©ã‚“ã©ã‚“é€²ã‚€
    }
```

ã“ã®æ™‚ç‚¹ã®å¤‰æ•°`s`ãƒ»`s1`ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚
```shell
s  => å¤‰æ›å¯¾è±¡ã®æ–‡å­—åˆ—ã«éš£æ¥ã™ã‚‹ãƒ¡ãƒ¢ãƒªé ˜åŸŸã®ã©ã“ã‹
s1 => `hexdigits`ã®ã©ã“ã‹ (éš£æ¥ã™ã‚‹ãƒ¡ãƒ¢ãƒªé ˜åŸŸã®ä¸­ã§16é€²æ•°ã®æ–‡å­—ã«ãŸã¾ãŸã¾ãƒãƒƒãƒã—ãŸã¨ã“ã‚)
```

**â‘¢ äºˆæœŸã›ã¬ãƒã‚¤ãƒ³ã‚¿ãŒã€å‘¼ã³å‡ºã—å…ƒã«è¿”ã•ã‚Œã‚‹**
ãã®å¾Œã®å‡¦ç†ã¯ã„ã‚ã„ã‚ã‚ã£ã¦ã€`ret`ãƒ©ãƒ™ãƒ«ã«ã‚¸ãƒ£ãƒ³ãƒ—ã€‚(s, s1ã¯å¤‰æ›´ã•ã‚Œãªã„)
`se`ã¯å‘¼ã³å‡ºã—å…ƒã‹ã‚‰æ¸¡ã•ã‚Œã¦ã„ã‚‹ãƒã‚¤ãƒ³ã‚¿ã§ã€ã“ã“ã«ç¾æ™‚ç‚¹ã®`s`ã‚’ä»£å…¥ã—ã¦å‘¼ã³å‡ºã—å…ƒ(`rb_csr_to_dbl_raise`)ã«æˆ»ã‚‹ã€‚
```c
ret:
    if (se)
        *se = (char *)s;
    return sign ? -dval(rv) : dval(rv);
```

**â‘£ å‘¼ã³å‡ºã—å…ƒã§ä¾‹å¤–ãŒé€å‡ºã•ã‚Œã‚‹**
å‘¼ã³å‡ºã—å…ƒã«æˆ»ã£ã¦ããŸå¾Œã¯ä»¥ä¸‹ã®é€šã‚Šã€‚
```c
static double
rb_cstr_to_dbl_raise(const char *p, int badcheck, int raise, int *error)
{
    ...

    // p   => å¤‰æ›å¯¾è±¡ã®æ–‡å­—
    // end => 16é€²æ•°æ–‡å­—åˆ—ã®çµ‚ç«¯ã‚’ä»£å…¥ã—ã¦ã‚‚ã‚‰ã†ãƒã‚¤ãƒ³ã‚¿
    d = strtod(p, &end);  // ã“ã“ã§endã«ãŠã‹ã—ãªãƒã‚¤ãƒ³ã‚¿ãŒå…¥ã£ã¦ãã‚‹
    ...

    if (*end) {  // é‹æ‚ªã16é€²æ•°æ–‡å­—åˆ—ã®å¤–å´ã®ãªã«ã‹ã‚’æŒ‡ã—ã¦ã„ã‚‹å ´åˆã“ã®åˆ†å²ã«å…¥ã‚‹
        ...

        if (*p == '0') {  // pã®å…ˆé ­ã¯'0x'ãªã®ã§'x'ã¾ã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹
            prev = *n++ = '0';
            while (*++p == '0');
        }
        while (p < end && n < e) prev = *n++ = *p++;  // prevãŒ16é€²æ•°æ–‡å­—åˆ—ã®å¤–å´ã¾ã§é€²ã‚€
        while (*p) {
            ...
            else if (prev == '.' ? dot_seen++ : !ISDIGIT(prev)) {
                // prevãŒãƒ‰ãƒƒãƒˆã§ã‚‚ãªãã€æ•°å­—ã§ã‚‚ãªã„ã®ã§ã“ã“ã«å…¥ã‚‹
                if (badcheck) goto bad;  // badãƒ©ãƒ™ãƒ«ã«ã‚¸ãƒ£ãƒ³ãƒ—
                break;
            }
    ...
  bad:
    if (raise) {
        // ä¾‹å¤–ãŒé€å‡ºã•ã‚Œã‚‹
        rb_invalid_str(q, "Float()");
        UNREACHABLE_RETURN(nan(""));
    }
    else {
        if (error) *error = 1;
        return 0.0;
    }
}
```

ã“ã‚“ãªæ„Ÿã˜ã§ã€Rubyãƒ—ãƒ­ã‚»ã‚¹è‡ªä½“ã¯ä¾‹å¤–ã§è½ã¡ã‚‹ã‚‚ã®ã®ã€ãƒ¡ãƒ¢ãƒªä¸Šã®èª­ã‚ãªã„æ–¹ãŒè‰¯ã•ãã†ãªé ˜åŸŸã¾ã§èª­ã‚ã¦ã—ã¾ã£ã¦ã„ã‚‹ã¿ãŸã„ã€‚

### ã¡ã‚‡ã£ã¨æ°—ã«ãªã£ãŸã“ã¨
ä»Šå›ã¯å˜ç™ºã®ãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œã§éƒ¨åˆ†çš„ã«ã‚ªãƒ¼ãƒãƒ¼ãƒªãƒ¼ãƒ‰ã—ã¦ã„ã‚‹ãŒã€ã“ã‚“ãªã“ã¨ã‚‚ã§ããŸã‚Šã—ãªã„ã‹ã¡ã‚‡ã£ã¨æ°—ã«ãªã£ãŸã€‚(åˆ¥é€”å®Ÿé¨“ã—ã¦ã¿ã¦ã‚‚é¢ç™½ãã†)

- ã‚ã‚‹æ¡ä»¶ä¸‹ã§ä½•ç™¾å›ã‚‚ãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œ
â¬‡
- ãƒ—ãƒ­ã‚»ã‚¹ãŒé…ç½®ã•ã‚Œã‚‹ãƒ¡ãƒ¢ãƒªé ˜åŸŸãŒã¡ã‚‡ãã¡ã‚‡ãå¤‰ã‚ã‚‹ (æ„å›³çš„ã«å¤‰ãˆã‚Œã‚‹ã®ã‹ã¯ã‚ã‹ã‚‰ãªã„)
â¬‡
- ãƒãƒ§ã‚³ãƒãƒ§ã‚³ã¨ã„ã‚ã‚“ãªé ˜åŸŸã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒªãƒ¼ãƒ‰ã—ã¦ã€èª­ã¿è¾¼ã‚“ã ãƒ¡ãƒ¢ãƒªã®æ–­ç‰‡ã‚’é›†ã‚ã‚‹
â¬‡
- é›†ã‚ãŸãƒ¡ãƒ¢ãƒªæ–­ç‰‡ã‚’çµ„ã¿åˆã‚ã›ã‚Œã°ã€ã‚ã‚‹æ™‚ç‚¹ã®ãƒ¡ãƒ¢ãƒªã‚’éƒ¨åˆ†çš„ã«å¾©å…ƒã§ããŸã‚Š...ï¼Ÿ

(ãã‚‚ãã‚‚Rubyãƒ—ãƒ­ã‚»ã‚¹è‡ªä½“ãŒä½•åº¦ã‚‚è‰²ã‚“ãªæ‰€ã«é…ç½®ã•ã‚Œã‚‹ãªã‚‰ã€ãã®ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚ˆã£ã¦ãƒ¡ãƒ¢ãƒªãŒä¸Šæ›¸ãã•ã‚Œã¡ã‚ƒã£ã¦ã„ã‚‹å¯èƒ½æ€§ã‚‚ååˆ†ã‚ã‚Šå¾—ã‚‹ã‹ã‚‚ã ãŒ)

ã‚ã¨`2000`å›ãã‚‰ã„ãƒ«ãƒ¼ãƒ—ã•ã›ã‚Œã°ç¢ºå®šã§ç™ºç”Ÿã™ã‚‹ä»¶ã«ã¤ã„ã¦ã€å˜ç´”ã«ãƒ’ãƒ¼ãƒ—ä¸Šã«ç¢ºä¿ã•ã‚Œã‚‹ä½ç½®ãŒæ‚ªãã¦å¶ç„¶ã‚ªãƒ¼ãƒãƒ¼ãƒªãƒ¼ãƒ‰ã—ãªã‹ã£ãŸã ã‘ï¼Ÿ
çŸ­ã„æ–‡å­—åˆ—ã®ã¨ãã¯ç™ºç”Ÿã—ãªã„ä»¶ã«ã¤ã„ã¦ã‚‚ã€RubyãŒæ–‡å­—åˆ—ã‚’ãƒ’ãƒ¼ãƒ—ä¸Šã«ç¢ºä¿ã™ã‚‹éš›ã®å‡¦ç†ãŒé–¢ä¿‚ã—ã¦ãŸã‚Šã™ã‚‹ã®ã‹æ°—ã«ãªã‚‹ã€‚

# æœ€å¾Œã«
è„†å¼±æ€§ã‹ã‚‰Rubyã®ä»•çµ„ã¿ã‚’çŸ¥ã‚‹ã¨ã„ã†æš´æŒ™ã«å‡ºã¦ã¿ã¦ã€è„†å¼±æ€§ã®ç†è«–ã‚’æŠŠæ¡ã—ãªãŒã‚‰ã§ãªã‹ãªã‹è‹¦æˆ¦ã—ãŸéƒ¨åˆ†ã‚‚ã‚ã£ãŸãŒã€å®Ÿéš›å‹•ã‹ã—ãªãŒã‚‰ä»•çµ„ã¿ãŒã‚ã‹ã£ã¦ã„ãæ§˜å­ã¯ã¨ã¦ã‚‚æ¥½ã—ã‚ãŸã€‚
ä»Šå›ã¯`Float`ã¸ã®å¤‰æ›éƒ¨åˆ†ã‚’è¦‹ã¦ã„ã£ãŸãŒã€ä»–ã®è„†å¼±æ€§ã‹ã‚‰ã¾ãŸåˆ¥ã®ç®‡æ‰€ã®ä»•çµ„ã¿ã‚‚è¦‹ã‚Œã‚‹ã¨é¢ç™½ãã†ãªã®ã§ã‚„ã£ã¦ã¿ãŸã„ã€‚
åŒã˜ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§`Rails`ã®ä»•çµ„ã¿ã‚’çŸ¥ã‚‹ã®ã‚‚æ¥½ã—ãã†ã€‚
