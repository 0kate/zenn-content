---
title: "‰∏≤„ÇíÈÄö„Åó„Å¶ÈÅä„Çì„Åß„Åø„Åü(proxychains)"
emoji: "ü™°"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: ["network", "socks", "rust", "proxy", "unix", "proxychains"]
published: false
---

# ‰∏≤„ÇíÈÄö„Åó„Å¶ÈÅä„Çì„Åß„Åø„Åü(proxychains)
ÈÄ±Êú´„Å´‰∏≤„ÇíÈÄö„Åó„Å¶ÈÅä„Å∂„Å®„ÅÑ„ÅÜ„ÄÅÁâπ„Å´Âà©Áõä„ÅåÂá∫„ÇãË®≥„Åß„ÇÇ„Å™„Åè„ÄÅ„Åü„Å†Âçò„Å´ÂÄã‰∫∫ÁöÑ„Å™Áü•ÁöÑÂ•ΩÂ•áÂøÉ„ÇíÊ∫Ä„Åü„Åô„Å†„Åë„ÅÆÊ¥ªÂãï„ÇíÂÆüÊñΩ„Åó„Åü„ÅÆ„ÅßÂÇôÂøòÈå≤„Å®„Åó„Å¶Ë®ò‰∫ã„Å´ÊÆã„Åó„Å¶„Åä„Åè„ÄÇ
‰∏ª„Å´`proxychains`„ÅÆË©±„ÄÇ

# "‰∏≤„ÇíÈÄö„Åô"„Å®„ÅØ
„Åì„ÅÆË®ò‰∫ã„ÅÆ„Çø„Ç§„Éà„É´„ÇíË¶ã„Å¶ÂÜÖÂÆπ„Å´ËààÂë≥„ÇíÊåÅ„Å£„Å¶„Åè„Çå„ÅüÊñπ„ÄÖ„Åß„ÅÇ„Çå„Å∞„ÄÅ„Åä„Åù„Çâ„ÅèË™¨Êòé‰∏çË¶Å„Å†„Å®ÊÄù„Å£„Å¶„ÅÑ„Çã„ÄÇ

# proxychains„Å®„ÅØ
„Åù„ÅÆÂêç„ÅÆÈÄö„Çä„ÄÅ`proxy`„Å´`chains`„Åó„Å¶„Åè„Çå„Çã„ÉÑ„Éº„É´„ÄÇ
UNIXÁ≥ª„ÅÆ„Ç∑„Çπ„ÉÜ„É†‰∏ä„ÅßÂà©Áî®ÂèØËÉΩ„Åß„ÄÅ„Éë„ÉÉ„Ç±„Éº„Ç∏„Éû„Éç„Éº„Ç∏„É£„Éº„Åã„ÇâËêΩ„Å®„Åó„Å¶„Åè„Çã„Å™„Çä„ÄÅ„ÇΩ„Éº„Çπ„Åã„Çâ„Éì„É´„Éâ„Åô„Çã„Å™„Çä„Åô„Çå„Å∞‰Ωø„Åà„Çã„Çà„ÅÜ„Å´„Å™„Çã„ÄÇ
https://github.com/haad/proxychains

ÊúÄ„ÇÇÁ∞°Âçò„Å™‰Ωø„ÅÑÊñπ„Å®„Åó„Å¶„ÅØ„ÄÅ„Åì„Çì„Å™È¢®„Å´`proxychains`„Ç≥„Éû„É≥„Éâ„Å´Á∂ö„Åë„Å¶ÂÆüË°å„Åó„Åü„ÅÑ„Ç≥„Éû„É≥„Éâ„ÇíÊ∏°„Åó„Å¶„ÅÇ„Åí„Çã„Å†„Åë„ÄÇ(curl„ÅÆ‰æã)
```
$ proxychains curl https://www.google.com/
```
„Åì„Çå„Å†„Åë„Åß„ÄÅ‰∫à„ÇÅË®≠ÂÆö„Åó„Åü„Éó„É≠„Ç≠„Ç∑„ÇíÈÄö„Åó„Å¶ÈÄö‰ø°„ÇíË°å„Å£„Å¶„Åè„Çå„Çã„ÄÇ
(Ë®≠ÂÆö„Å´Èñ¢„Åó„Å¶„ÅØÂæåËø∞)

## ÂØæÂøú„Éó„É≠„Éà„Ç≥„É´
`proxychains`„ÅØ„ÄÅ`HTTP`„Éó„É≠„Ç≠„Ç∑„Å®`SOCKS`„Éó„É≠„Ç≠„Ç∑„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Çã„ÄÇ

`HTTP`„ÅÆÊñπ„ÅØ‰∏ÄËà¨ÁöÑ„Å™HTTPÈÄö‰ø°„Çí‰∏≠Á∂ô„Åó„Å¶„Åè„Çå„Çã„Éó„É≠„Ç≠„Ç∑„ÄÇ

`SOCKS`„ÅÆÊñπ„ÅØËÅû„ÅçÊÖ£„Çå„Å™„ÅÑÊñπ„ÇÇ„ÅÑ„Çã„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„ÄÇ
Ë∂ÖÁµ∂„Åñ„Å£„Åè„ÇäË®Ä„ÅÜ„Å®„ÄÅ`TCP/UDP`„É¨„Ç§„É§„ÅÆÈÄö‰ø°„Çí‰∏≠Á∂ô„Åó„Å¶„Åè„Çå„Çã„ÄÇ
`Tor`„Éó„É≠„Ç≠„Ç∑„Å™„Çì„Åã„ÅØ`SOCKS`„ÇíÂà©Áî®„Åó„Å¶Ë§áÊï∞„Éé„Éº„Éâ„Å´Ê∏°„Å£„Å¶ÈÄö‰ø°„Çí‰∏≠Á∂ô„Åó„Å¶„ÅÑ„Çã„ÄÇ
Èù¥‰∏ã„Å®„ÅØ„Å™„Çì„ÅÆÈñ¢‰øÇ„ÇÇ„Å™„ÅÑ„ÄÇ
`4`„Å®„Åã`4a`„Å®„Åã`5`„Å®„Åã„Éê„Éº„Ç∏„Éß„É≥„Åå„ÅÇ„Çã„ÄÇ

## Ë®≠ÂÆö„Éï„Ç°„Ç§„É´
`proxychains`„ÅØ„ÄÅÁí∞Â¢ÉÂ§âÊï∞ or Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„Å´Âü∫„Å•„ÅÑ„Å¶Âà©Áî®„Åô„Çã„Éó„É≠„Ç≠„Ç∑„ÇíÊ±∫ÂÆö„Åô„Çã„ÄÇ
Á¥∞„Åã„ÅÑÈÉ®ÂàÜ„ÅØÂâ≤ÊÑõ„Åô„Çã„Åå„ÄÅ‰∫à„ÇÅÊ±∫„ÇÅ„Çâ„Çå„ÅüÈ†ÜÂ∫è„ÅßË®≠ÂÆöÊÉÖÂ†±„ÇíÊé¢Á¥¢„Åô„Çã„Çà„ÅÜ„Å´„Åß„Åç„Å¶„ÅÑ„Çã„ÄÇ
(ÂÖ∑‰ΩìÁöÑ„Å™È†ÜÂ∫è„ÅåÁü•„Çä„Åü„ÅÑÊñπ„ÅØ„ÄÅ[ÂÖ¨Âºè„ÅÆREADME](https://github.com/haad/proxychains#configuration)„ÇíÂèÇÁÖß)

Áâπ„Å´‰Ωï„ÇÇÊåáÂÆö„Åï„Çå„Å™„Åë„Çå„Å∞„ÄÅ`/etc/proxychains.conf`(„Éê„Éº„Ç∏„Éß„É≥„Å´„Çà„Å£„Å¶„ÅØ`proxychains4.conf`)„ÅåÂèÇÁÖß„Åï„Çå„Çã„ÄÇ
Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅÆ‰∏≠Ë∫´„ÅØ„ÄÅ"Âà©Áî®„Åô„Çã„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„Éº„ÅÆ„É™„Çπ„Éà"„ÄÅ"„Çø„Ç§„É†„Ç¢„Ç¶„Éà„ÅÆÁßíÊï∞"„ÇÑ"DNS„Å´„Çà„ÇãÂêçÂâçËß£Ê±∫„ÇÇ„Éó„É≠„Ç≠„Ç∑„Åï„Åõ„Çã„Åã„Å©„ÅÜ„Åã"„Å™„Å©„ÅÆË®≠ÂÆö„ÅåÂê´„Åæ„Çå„Çã„ÄÇ

‰ª•‰∏ã„ÅØÂà©Áî®„Åô„Çã„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„Éº„ÅÆË®≠ÂÆö„ÄÇ`[ProxyList]`„Å®„Åó„Å¶Ë§áÊï∞Ë®≠ÂÆö„Åß„Åç„Çã„ÄÇ
„Éá„Éï„Ç©„É´„Éà„Åß„É≠„Éº„Ç´„É´„ÅÆTor„Éá„Éº„É¢„É≥(`127.0.0.1:9050`)„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ
```
...
[ProxyList]
# add proxy here ...
# meanwhile
# defaults set to "tor"
socks4 	127.0.0.1 9050
```

‰ªñ„Å´„ÇÇÂÄã‰∫∫ÁöÑ„Å´ËààÂë≥Ê∑±„Åã„Å£„ÅüÁÆáÊâÄ„Åå„ÄÅ`[ProxyList]`„ÅßÂàóÊåô„Åó„Åü„Éó„É≠Ê£ãÂ£´ÈÅî„Çí„Å©„ÅÜÊâ±„ÅÜ„Åã„Å®„ÅÑ„Å£„ÅüË®≠ÂÆö„ÄÇ
`dynamic_chain`, `strict_chain`, `random_chain`„ÅÆ„ÅÑ„Åö„Çå„Åã„ÇíÊåáÂÆö„Åô„Çã„Åì„Å®„Åå„Åß„Åç„ÄÅ„Åù„Çå„Åû„Çå„ÅÆÊåôÂãï„Å®„Åó„Å¶„ÅØ‰ª•‰∏ã„ÅÆÈÄö„Çä„ÄÇ
- `dynamic_chain`
  - Ë®≠ÂÆö„Åó„Åü„Éó„É≠„Ç≠„Ç∑‰∏ÄË¶ß„ÇíÈ†ÜÁï™„Å´Âà©Áî®„Åô„Çã
  - „ÉÄ„Ç¶„É≥„Åó„Å¶„ÅÑ„Çã„Éó„É≠„Ç≠„Ç∑„ÅØ„Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Çã
- `strict_chain`
  - Ë®≠ÂÆö„Åó„Åü„Éó„É≠„Ç≠„Ç∑‰∏ÄË¶ß„ÇíÈ†ÜÁï™„Å´Âà©Áî®„Åô„Çã
  - „Åô„Åπ„Å¶„ÅÆ„Éó„É≠„Ç≠„Ç∑„Åå„Ç™„É≥„É©„Ç§„É≥„Åß„Å™„Åë„Çå„Å∞„Å™„Çâ„Å™„ÅÑ
- `random_chain`
  - Ë®≠ÂÆö„Åó„Åü„Éó„É≠„Ç≠„Ç∑‰∏ÄË¶ß„Åå„É©„É≥„ÉÄ„É†„ÅßÂà©Áî®„Åï„Çå„Çã
  - `this option is good to test your IDS :)`„Å£„Å¶Êõ∏„ÅÑ„Å¶„ÅÇ„Çã

## ÈÅä„Çì„Åß„Åø„Çã
„Åõ„Å£„Åã„Åè„Å™„ÅÆ„Åß(?)„ÄÅ„Ç∞„É≠„Éº„Éê„É´IP„ÇíËøî„Åó„Å¶„Åè„Çå„Çã„Çµ„Éº„Éì„Çπ„ÇÇËá™ÂàÜ„ÅßÁ´ã„Å¶„Å¶Ë©¶„Åó„Å¶„Åø„Çã„ÄÇ
ÈÅ©ÂΩì„Å´Rust„ÅßÊõ∏„ÅÑ„Åü„Ç≥„Éº„Éâ„ÇíCloudflare Workers„Å´„Éá„Éó„É≠„Ç§„Åó„Å¶„Åä„Åè„ÄÇ(Ëâ≤„ÄÖ„Å®Èõë„Åß„Åô„ÅåÊ§úË®ºÁî®„Å®„ÅÑ„ÅÜ„Åì„Å®„Åß„ÅäË®±„Åó„Åè„Å†„Åï„ÅÑ)
```rust
#[event(fetch)]
pub async fn main(req: Request, env: Env, _ctx: worker::Context) -> Result<Response> {
    ...
    router
        ...
        .get("/global-ip", |req, ctx| {
            let connecting_ip = match req.headers().get("CF-Connecting-IP") {
                Ok(value) => {
                    match value {
                        Some(connecting_ip) => connecting_ip,
                        None => "Failed to fetch source IP.".to_string(),
                    }
                },
                Err(_) => "Failed to fetch source IP.".to_string(),
            };

            Response::from_json(&json!({ "globalIP": connecting_ip }))
        })
        .run(req, env)
        .await
}
```
„Éá„Éó„É≠„Ç§„Åó„Å¶Âãï‰ΩúÁ¢∫Ë™ç„ÄÇ
```
$ wrangler publish
$ curl https://~~~.workers.dev/global-ip
{"globalIP":"~~~.~~~.~~~.~~~"}
```

ÈÅ©ÂΩì„Å´`squid`„ÇíÁ´ã„Å¶„Å¶ÈÄö„Åô„Çà„ÅÜ„Å´„Åó„Å¶„Åø„Çã„ÄÇ
```
$ docker run -d --name squid-container -p 3128:3128 ubuntu/squid:latest

# proxychains„ÅÆË®≠ÂÆö„ÇíÂ§âÊõ¥„Åó„Å¶„Åä„Åè
$ cat /etc/proxychains4.conf
[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
# socks4 	127.0.0.1 9050
http		127.0.0.1 3128  # squid„ÅÆ„Éù„Éº„Éà„ÇíËøΩÂä†

$ proxychains curl https://~~~.workers.dev/global-ip
{"globalIP":"~~~.~~~.~~~.~~~"}
```
‚¨áÔ∏è `squid`„ÅÆ„É≠„Ç∞„Å´„ÇÇÂá∫„Å¶„Çã
```
...
1677407264.464    119 ~~~.~~~.~~~.~~~ TCP_TUNNEL/200 5842 CONNECT ~~~.workers.dev:443 - HIER_DIRECT/~~~.~~~.~~~.~~~-
```
„É≠„Éº„Ç´„É´„ÅÆ„Ç≥„É≥„ÉÜ„Éä„ÇíÁµåÁî±„Åï„Åõ„Å¶„ÅÑ„Çã„Å†„Åë„Å™„ÅÆ„Åß„Å™„Çì„ÅÆ‰ª£„Çè„ÇäÊò†„Åà„ÇÇ„Å™„ÅÑ„Åå„ÄÅ„Å®„Çä„ÅÇ„Åà„ÅöËá™ÂàÜ„ÅßÁ´ã„Å¶„Åü„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„Éº„Åß„ÇÇÂãï„ÅÑ„Å¶„ÅÑ„Çã„Åì„Å®„ÅåÁ¢∫Ë™ç„Åß„Åç„Åü„ÄÇ
„ÇÇ„Å°„Çç„Çì„Éá„Éï„Ç©„É´„Éà„ÅÆË®≠ÂÆö„ÅßÁ®ºÂÉç„Åï„Åõ„Çå„Å∞„ÄÅTor„ÅÆExit„Éé„Éº„Éâ„ÅÆIP„ÅåÁ¢∫Ë™ç„Åß„Åç„Çã„ÄÇ

## „Å©„ÅÜ„ÅÑ„ÅÜ‰ªïÁµÑ„ÅøÔºü
ÊØéÂ∫¶‰ªïÁµÑ„Åø„ÅåÊ∞ó„Å´„Å™„Çã„ÅÆ„Åß‰∏≠Ë∫´„ÇíË¶ó„ÅÑ„Å¶„Åø„Çã„ÄÇ

„Åù„ÇÇ„Åù„ÇÇ„ÄÅ‰ΩïÊïÖ`proxychains`„Å®„ÅÑ„ÅÜ„Ç≥„Éû„É≥„Éâ„Å´Á∂ö„Åë„Å¶Êú¨Êù•ÂÆüË°å„Åó„Åü„ÅÑ„Ç≥„Éû„É≥„Éâ„Çí‰∏¶„Åπ„Çã„Å†„Åë„Åß„ÄÅ„Åù„ÅÆ„Ç≥„Éû„É≥„Éâ„Åå„Éó„É≠„Ç≠„Ç∑„ÇíÁµåÁî±„Åô„Çã„Çà„ÅÜ„Å´„Å™„Çã„ÅÆ„Åã„ÄÇ(„Ç≥„Éû„É≥„Éâ„ÇÇÊîπÂ§â„Åï„Çå„Å¶„Å™„ÅÑ„Åó„ÄÅOS„ÅÆË®≠ÂÆö„ÇÇÂ§âÊõ¥„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÅÆ„Å´)
ÁµêË´ñ„Åã„ÇâË®Ä„ÅÜ„Å®„ÄÅ`proxychains`„Å´„Çà„Å£„Å¶`connect`„Ç∑„Çπ„ÉÜ„É†„Ç≥„Éº„É´„ÇÑ`gethostbyname`„Å™„Å©„ÅÆÂëº„Å≥Âá∫„Åó„Åå„Éï„ÉÉ„ÇØ„Åï„Çå„ÄÅÁã¨Ëá™„ÅÆÂá¶ÁêÜ„Å´Â∑Æ„ÅóÊõø„Åà„Çâ„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅ„Å®„ÅÑ„ÅÜ„Åì„Å®„Å´„Å™„Çã„ÄÇ

### `libproxychains.c`
`proxychains`„Ç≥„Éû„É≥„Éâ„ÅÆ„Ç®„É≥„Éà„É™„Éº„Éù„Ç§„É≥„Éà„ÅØ`main.c`„Å´Êõ∏„Åã„Çå„Å¶„ÅÑ„Çã„Çè„Åë„Å†„Åå„ÄÅÂÆü„ÅØ„Åì„Åì„ÇíË¶ã„Å¶„ÇÇ„Ç™„Éó„Ç∑„Éß„É≥„ÅÆÂá¶ÁêÜ„ÇÑ`execvp`„Å´„Çà„Çã„Éó„É≠„Çª„ÇπÂÆüË°å„ÅÆÂá¶ÁêÜ„Åó„Åã„Åã„Åã„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÄÇ
ÂâçËø∞„ÅÆ„Çà„ÅÜ„Å™ÊåôÂãï„ÅÆÊú¨‰Ωì„ÅØ„ÄÅÂÖ±Êúâ„É©„Ç§„Éñ„É©„É™„Å®„Åó„Å¶„Éì„É´„Éâ„Åï„Çå„Çã`libproxychains.c`„Å´Êõ∏„Åã„Çå„Å¶„ÅÑ„Çã„ÄÇ

„Åì„ÅÆ„Éï„Ç°„Ç§„É´„ÅÆ`do_init`Èñ¢Êï∞„ÅåËÇù„Åß„ÄÅ‰∏äÊõ∏„Åç„Åü„ÅÑÂêÑÈñ¢Êï∞„ÅÆ„Ç∑„É≥„Éú„É´„Å´Áã¨Ëá™„ÅÆÂá¶ÁêÜ„ÇíÁ¥ê‰ªò„Åë„ÄÅÂÖÉ„ÄÖ„ÅÆÂá¶ÁêÜ„Çí`true_`„Åã„ÇâÂßã„Åæ„Çã„Ç∑„É≥„Éú„É´„Å´Á¥ê‰ªò„ÅëÁõ¥„Åó„Å¶„ÅÑ„Çã„ÄÇ
`connect`„Ç∑„Çπ„ÉÜ„É†„Ç≥„Éº„É´„Åß„ÅÇ„Çå„Å∞„Åù„ÅÆÂÆüÊÖã„ÅØ`true_connect`„Å´Á¥ê‰ªò„Åë„Çâ„Çå„ÄÅ`connect`„ÅÆÂëº„Å≥Âá∫„Åó„ÅØ`proxychains`Áã¨Ëá™„ÅÆÂá¶ÁêÜ„Å´„Åô„ÅíÊõø„Åà„Çâ„Çå„Çã„ÄÇ
```c
...
// true_„Åã„ÇâÂßã„Åæ„Çã„Ç∑„É≥„Éú„É´„ÅÆÂÆöÁæ©
extern connect_t true_connect;
extern gethostbyname_t true_gethostbyname;
extern getaddrinfo_t true_getaddrinfo;
extern freeaddrinfo_t true_freeaddrinfo;
...
```

```c
...
// X = connect„ÅÆÂ†¥Âêà„ÄÅ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´ÁΩÆÊèõ„Åô„Çã„Éû„ÇØ„É≠
// do { true_connect  = load_sym("connect"); } while(0)
#define SETUP_SYM(X) do { true_ ## X = load_sym( # X, X ); } while(0)

static void do_init(void) {
    ...

    proxychains_write_log(LOG_PREFIX "DLL init\n");
    SETUP_SYM(connect);
    SETUP_SYM(gethostbyname);
    SETUP_SYM(getaddrinfo);
    SETUP_SYM(freeaddrinfo);
    SETUP_SYM(gethostbyaddr);
    SETUP_SYM(getnameinfo);
    ...
}
```

### „Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„Éº„ÅÆÈÅ∏Êäû
„Å°„Å™„Åø„Å´`random_chain`„ÇÑ„Çâ„ÅÆË®≠ÂÆö„Åß„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„Éº„ÇíÈÅ∏Êäû„Åô„ÇãÈÉ®ÂàÜ„ÅØ„ÄÅ`connect`‚Üí`connect_proxy_chain`„Å®Êù•„Å¶„Åï„Çâ„Å´„Ç≥„Éº„É´„Åï„Çå„Çã`select_proxy`„ÅßË°å„Çè„Çå„Å¶„ÅÑ„Çã„ÄÇ
```rust
static proxy_data *select_proxy(select_type how, proxy_data * pd, unsigned int proxy_count, unsigned int *offset) {
    unsigned int i = 0, k = 0;

    if(*offset >= proxy_count)
        return NULL;
    switch (how) {
        case RANDOMLY:
            do {
                k++;
                // „Åì„ÅÆËæ∫„Åß„É©„É≥„ÉÄ„É†„Å´ÈÅ∏„Çì„Å†„Çä„Åó„Å¶„ÅÑ„Çã
                i = 0 + get_rand_int(proxy_count);
            } while(pd[i].ps != PLAY_STATE && k < proxy_count * 100);
            break;
        case FIFOLY:
            for(i = *offset; i < proxy_count; i++) {
                if(pd[i].ps == PLAY_STATE) {
                    *offset = i;
                    break;
                }
            }
        default:
            break;
    }
    if(i >= proxy_count)
        i = 0;
    return (pd[i].ps == PLAY_STATE) ? &pd[i] : NULL;
}
```

## Ëá™‰ΩúSOCKS4„Çµ„Éº„Éê„Éº(Èõë)„ÇíÊõ∏„ÅÑ„Å¶`proxychains`„Åã„ÇâÂè©„Åã„Åõ„Å¶„Åø„Çã
Ëá™‰ΩúSOCKS4„Çµ„Éº„Éê„Éº„ÇíÈõë„Å´Êõ∏„ÅÑ„Å¶„Åø„Å¶`proxychains`„Åã„ÇâÂè©„Åã„Åõ„Å¶„Åø„Çã„ÄÇ
SOCKS4„ÅÆRFC„ÅåË¶ãÂΩì„Åü„Çâ„Å™„Åã„Å£„Åü„ÅÆ„Åß„ÄÅ[Wikipedia](https://en.wikipedia.org/wiki/SOCKS#SOCKS4)„ÅÆ„Éó„É≠„Éà„Ç≥„É´Ë™¨Êòé„ÇíË™≠„Åø„Å™„Åå„ÇâÊõ∏„Åè„ÄÇ

„Åæ„Åö„ÅØ„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Åã„Çâ„ÅÆÊúÄÂàù„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„ÇíÂèó„Åë„Çã„Å®„Åì„Çç„ÄÇ(Á¥∞„Åã„ÅÑ„Å®„Åì„Çç„ÅØÂâ≤ÊÑõ)
```rust
fn handle_client(mut stream: TcpStream) -> std::io::Result<()> {
    let mut buf = [0; 8];
    stream.read(&mut buf)?;

    let req = Request::new(
        buf[0],
        buf[1],
        ((buf[2] as u16) << 8) + buf[3] as u16,
        ((buf[4] as u32) << 24) + ((buf[5] as u32) << 16) + ((buf[6] as u32) << 8) + buf[7] as u32,
    );
    println!("received: {:02x?}", buf);
    println!("req: {:?}", req);
    ...
```
‰ª•‰∏ã„ÅÆÊßãÈÄ†„ÅßÈÄÅ„Çâ„Çå„Åü„Éê„Ç§„ÉàÂàó„Çí„Éë„Éº„Çπ„Åô„Çã„Å†„Åë„ÄÇ
- „Éó„É≠„Éà„Ç≥„É´„Éê„Éº„Ç∏„Éß„É≥ (1 byte)
- „Ç≥„Éû„É≥„Éâ„Ç≥„Éº„Éâ (1 byte)
- Ëª¢ÈÄÅÂÖà„Éù„Éº„ÉàÁï™Âè∑ (2 bytes)
- Ëª¢ÈÄÅÂÖàIP„Ç¢„Éâ„É¨„Çπ (4 bytes)

Ê¨°„Å´„Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆ„É¨„Çπ„Éù„É≥„Çπ„ÇíËøî„Åô„Å®„Åì„Çç„ÄÇ(Á¥∞„Åã„ÅÑ„Å®„Åì„Çç„ÅØÂâ≤ÊÑõ)
```rust
    ...
    let res = Response::new(
        0x00,
        0x5a,
        0x00,
        req.dst_addr.into(),
    );
    let res_bytes = res.to_bytes();

    println!("transmit: {:02x?}", res_bytes);
    println!("res: {:?}", res);
    stream.write(&res_bytes)?;
    ...
```
„Åì„Çå„ÇÇ‰ª•‰∏ã„ÅÆÊßãÈÄ†„ÅßÊßãÊàê„Åó„Åü„Éê„Ç§„ÉàÂàó„ÇíÊµÅ„Åô„Å†„Åë„ÄÇ
- Null 0x00 (1 byte)
- „É™„Éó„É©„Ç§„Ç≥„Éº„Éâ (1 byte)
  - `0x5a`„Åß„É™„ÇØ„Ç®„Çπ„ÉàÊâøË´æ
  - `0x5b`, `0x5c`, `0x5d`„Åß„Ç®„É©„Éº
- Ëª¢ÈÄÅÂÖà„Éù„Éº„ÉàÁï™Âè∑ (2 bytes)
  - SOCKS4„Åß„ÅØ„Åì„Åì„ÅØ„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅßÁÑ°Ë¶ñ„Åï„Çå„Çã„Çâ„Åó„ÅÑ„ÅÆ„Åß„Å∂„Å£„Å°„ÇÉ„ÅëÂÄ§„ÅØ‰Ωï„Åß„ÇÇËâØ„ÅÑ
- Ëª¢ÈÄÅÂÖàIP„Ç¢„Éâ„É¨„Çπ (4 bytes)
  - „Åì„Åì„ÇÇÁÑ°Ë¶ñ„Åï„Çå„Çã

„Åì„Åì„Åæ„Åß„Åè„Çå„Å∞„ÄÅ„Åì„ÅÆÂÖà„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Åã„ÇâÈÄÅ„Çâ„Çå„Å¶„Åç„Åü„Éá„Éº„Çø„ÅØËª¢ÈÄÅÂÖà„ÅÆ„Çµ„Éº„Éê„Éº„Å´Ê®™ÊµÅ„Åó„Å´„Åô„Çã„Éï„Çß„Éº„Ç∫„Å´ÂÖ•„Çã„ÄÇ
„Å®„Çä„ÅÇ„Åà„ÅöÁ∞°Âçò„Å™HTTPÈÄö‰ø°„Çí„Éó„É≠„Ç≠„Ç∑„Åó„Å§„Å§„ÄÅÂ∞ë„Åó„Å†„Åë‰∏≠Á∂ôÂÖà„Åã„Çâ„ÅÆ„É¨„Çπ„Éù„É≥„Çπ„ÇíÊîπÂ§â„Åó„Å¶Ëøî„Åô„Å™„Å©„Åó„Å¶ÈÅä„Çì„Åß„Åø„Çã„ÄÇ
```rust
fn handle_http_request(stream: TcpStream, socks_req: Request) -> std::io::Result<()> {
    let mut http_req = String::new();
    let mut http_reader = BufReader::new(&stream);
    http_reader.read_line(&mut http_req)?;
    println!("HTTP Req: {:?}", http_req);

    let (_method, path, _version) = parse_http_headline(&http_req);
    let proxy_res = match proxy_request(format!("http://{}:{}{}", socks_req.dst_addr.to_string(), socks_req.dst_port, path)) {
        Ok(res) => res,
        Err(e) => e.to_string(),
    };
    println!("Proxy res: {:?}", proxy_res);

    let http_res = format!("HTTP/1.1 200 OK\n\n>>> Proxy response\n{}\nHello from my socks server!\n<<<\n", proxy_res);
    let mut http_writer = BufWriter::new(&stream);
    http_writer.write(http_res.as_bytes())?;

    Ok(())
}
```
„ÇÅ„Å°„ÇÉ„Åè„Å°„ÇÉÈõë„Å†„Åå„ÄÅ`Hello from my socks server!`„Åø„Åü„ÅÑ„Å™„É°„ÉÉ„Çª„Éº„Ç∏„Çí„Å≠„ÅòËæº„Çì„Åß„Åø„Çã„ÄÇ

„Åì„Åì„Åæ„Åß„Åß„Åç„Åü„ÇâÂÆüÈöõ„Å´`proxychains`„Åã„ÇâÂè©„Åã„Åõ„Å¶„Åø„Çã„ÄÇ
ÂÖàÁ®ã„Åì„Åó„Çâ„Åà„ÅüWorkers„ÅÆ„É¨„Çπ„Éù„É≥„Çπ„ÇíÂèñ„Å£„Å¶„Åç„Å¶„ÇÇËâØ„ÅÑ„ÅÆ„Å†„Åå„ÄÅÂêçÂâçËß£Ê±∫„Åæ„ÅßÂÆüË£Ö„Åô„Çã„ÅÆ„Åå„ÇÅ„Çì„Å©„Åè„Åï„ÅÑ + Workers„ÅÆ„Çµ„Éº„Éê„Éº„É¨„ÇπÁí∞Â¢É„Å´IP„ÅßÁõ¥„Ç¢„ÇØ„Çª„Çπ„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÅÆ„Åß„ÄÅ„É≠„Éº„Ç´„É´„Å´ÈÅ©ÂΩì„Å´„Çµ„Éº„Éê„Éº„ÇíÁ´ã„Å¶„Å¶„Åù„Åì„Å´Ëª¢ÈÄÅ„Åï„Åõ„Çã„Åì„Å®„Å´„Åô„Çã„ÄÇ
```
# Ëª¢ÈÄÅÂÖà„ÅÆ„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï
$ touch ./proxy-test.html
$ echo 'This is on the super awesome http server.' > ./proxy-test.html
$ python -m http.server 9000

# Ëá™‰ΩúSOCKS„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï
$ cargo run

# proxychains„ÅÆË®≠ÂÆö„ÇíÂ§âÊõ¥„Åó„Å¶„Åä„Åè(ÂêçÂâçËß£Ê±∫„Çí„Éó„É≠„Ç≠„Ç∑„Åï„Åõ„Å™„ÅÑ + „Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„Éº„ÇíËøΩÂä†)
$ cat /etc/proxychains4.conf
...
[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
# socks4 	127.0.0.1 9050
socks4		127.0.0.1 11111  # Ëá™‰ΩúSOCKS4„Çµ„Éº„Éê„Éº

# „Åæ„Åö„ÅØÊôÆÈÄö„Å´Âè©„ÅÑ„Å¶„Åø„Çã („Åï„Å£„Åç‰Ωú„Å£„Åü„ÉÜ„Çπ„ÉàÁî®„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅåËøî„Å£„Å¶„Åè„Çã„Å†„Åë)
$ curl http://127.0.0.1:9000/proxy-test.html
This is on the super awesome http server.

# proxychainsÂÆüË°å
$ proxychains curl http://127.0.0.1:9000/proxy-test.html
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.16
[proxychains] Strict chain  ...  127.0.0.1:11111  ...  127.0.0.1:9000  ...  OK
>>> Proxy response
This is on the super awesome http server.

Hello from my socks server!
<<<
```
Âèñ„Çå„Åü„ÄÇ(„É¨„Çπ„Éù„É≥„Çπ„ÇÇÂ§â„Çè„Å£„Å¶„Çã)

# ÊúÄÂæå„Å´
„Éó„É≠„Ç≠„Ç∑„Åä„ÇÇ„Çç„ÅÑ„ÄÇ„Åì„Çå„Åß‰ºë„Åø„ÅÆÊó•„ÅØSOCKS4„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„Éº„ÇÇ„Å©„Åç„Çí‰Ωú„Å£„Å¶„Åæ„Åó„Åü„Å®„ÅÑ„ÅÜ„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ
