---
title: "ä¸²ã‚’é€šã—ã¦éŠã‚“ã§ã¿ãŸ(proxychains)"
emoji: "ğŸª¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["network", "socks", "rust", "proxy", "unix", "proxychains"]
published: true
---

# ä¸²ã‚’é€šã—ã¦éŠã‚“ã§ã¿ãŸ(proxychains)
é€±æœ«ã«ä¸²ã‚’é€šã—ã¦éŠã¶ã¨ã„ã†ã€ç‰¹ã«åˆ©ç›ŠãŒå‡ºã‚‹è¨³ã§ã‚‚ãªãã€ãŸã å˜ã«å€‹äººçš„ãªçŸ¥çš„å¥½å¥‡å¿ƒã‚’æº€ãŸã™ã ã‘ã®æ´»å‹•ã‚’å®Ÿæ–½ã—ãŸã®ã§å‚™å¿˜éŒ²ã¨ã—ã¦è¨˜äº‹ã«æ®‹ã—ã¦ãŠãã€‚
ä¸»ã«`proxychains`ã®è©±ã€‚

# "ä¸²ã‚’é€šã™"ã¨ã¯
ã“ã®è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¦‹ã¦å†…å®¹ã«èˆˆå‘³ã‚’æŒã£ã¦ãã‚ŒãŸæ–¹ã€…ã§ã‚ã‚Œã°ã€ãŠãã‚‰ãèª¬æ˜ä¸è¦ã ã¨æ€ã£ã¦ã„ã‚‹ã€‚

# proxychainsã¨ã¯
ãã®åã®é€šã‚Šã€`proxy`ã«`chains`ã—ã¦ãã‚Œã‚‹ãƒ„ãƒ¼ãƒ«ã€‚
UNIXç³»ã®ã‚·ã‚¹ãƒ†ãƒ ä¸Šã§åˆ©ç”¨å¯èƒ½ã§ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‹ã‚‰è½ã¨ã—ã¦ãã‚‹ãªã‚Šã€ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãªã‚Šã™ã‚Œã°ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
https://github.com/haad/proxychains

æœ€ã‚‚ç°¡å˜ãªä½¿ã„æ–¹ã¨ã—ã¦ã¯ã€ã“ã‚“ãªé¢¨ã«`proxychains`ã‚³ãƒãƒ³ãƒ‰ã«ç¶šã‘ã¦å®Ÿè¡Œã—ãŸã„ã‚³ãƒãƒ³ãƒ‰ã‚’æ¸¡ã—ã¦ã‚ã’ã‚‹ã ã‘ã€‚(curlã®ä¾‹)
```
$ proxychains curl https://www.google.com/
```
ã“ã‚Œã ã‘ã§ã€äºˆã‚è¨­å®šã—ãŸãƒ—ãƒ­ã‚­ã‚·ã‚’é€šã—ã¦é€šä¿¡ã‚’è¡Œã£ã¦ãã‚Œã‚‹ã€‚
(è¨­å®šã«é–¢ã—ã¦ã¯å¾Œè¿°)

## å¯¾å¿œãƒ—ãƒ­ãƒˆã‚³ãƒ«
`proxychains`ã¯ã€`HTTP`ãƒ—ãƒ­ã‚­ã‚·ã¨`SOCKS`ãƒ—ãƒ­ã‚­ã‚·ã«å¯¾å¿œã—ã¦ã„ã‚‹ã€‚

`HTTP`ã®æ–¹ã¯ä¸€èˆ¬çš„ãªHTTPé€šä¿¡ã‚’ä¸­ç¶™ã—ã¦ãã‚Œã‚‹ãƒ—ãƒ­ã‚­ã‚·ã€‚

`SOCKS`ã®æ–¹ã¯èãæ…£ã‚Œãªã„æ–¹ã‚‚ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚
è¶…çµ¶ã–ã£ãã‚Šè¨€ã†ã¨ã€`TCP/UDP`ãƒ¬ã‚¤ãƒ¤ã®é€šä¿¡ã‚’ä¸­ç¶™ã—ã¦ãã‚Œã‚‹ã€‚
`Tor`ãƒ—ãƒ­ã‚­ã‚·ãªã‚“ã‹ã¯`SOCKS`ã‚’åˆ©ç”¨ã—ã¦è¤‡æ•°ãƒãƒ¼ãƒ‰ã«æ¸¡ã£ã¦é€šä¿¡ã‚’ä¸­ç¶™ã—ã¦ã„ã‚‹ã€‚
é´ä¸‹ã¨ã¯ãªã‚“ã®é–¢ä¿‚ã‚‚ãªã„ã€‚
`4`ã¨ã‹`4a`ã¨ã‹`5`ã¨ã‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚‹ã€‚

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
`proxychains`ã¯ã€ç’°å¢ƒå¤‰æ•° or è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«åŸºã¥ã„ã¦åˆ©ç”¨ã™ã‚‹ãƒ—ãƒ­ã‚­ã‚·ã‚’æ±ºå®šã™ã‚‹ã€‚
ç´°ã‹ã„éƒ¨åˆ†ã¯å‰²æ„›ã™ã‚‹ãŒã€äºˆã‚æ±ºã‚ã‚‰ã‚ŒãŸé †åºã§è¨­å®šæƒ…å ±ã‚’æ¢ç´¢ã™ã‚‹ã‚ˆã†ã«ã§ãã¦ã„ã‚‹ã€‚
(å…·ä½“çš„ãªé †åºãŒçŸ¥ã‚ŠãŸã„æ–¹ã¯ã€[å…¬å¼ã®README](https://github.com/haad/proxychains#configuration)ã‚’å‚ç…§)

ç‰¹ã«ä½•ã‚‚æŒ‡å®šã•ã‚Œãªã‘ã‚Œã°ã€`/etc/proxychains.conf`(ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã£ã¦ã¯`proxychains4.conf`)ãŒå‚ç…§ã•ã‚Œã‚‹ã€‚
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã¯ã€"åˆ©ç”¨ã™ã‚‹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®ãƒªã‚¹ãƒˆ"ã€"ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®ç§’æ•°"ã‚„"DNSã«ã‚ˆã‚‹åå‰è§£æ±ºã‚‚ãƒ—ãƒ­ã‚­ã‚·ã•ã›ã‚‹ã‹ã©ã†ã‹"ãªã©ã®è¨­å®šãŒå«ã¾ã‚Œã‚‹ã€‚

ä»¥ä¸‹ã¯åˆ©ç”¨ã™ã‚‹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šã€‚`[ProxyList]`ã¨ã—ã¦è¤‡æ•°è¨­å®šã§ãã‚‹ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ­ãƒ¼ã‚«ãƒ«ã®Torãƒ‡ãƒ¼ãƒ¢ãƒ³(`127.0.0.1:9050`)ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã€‚
```
...
[ProxyList]
# add proxy here ...
# meanwhile
# defaults set to "tor"
socks4 	127.0.0.1 9050
```

ä»–ã«ã‚‚å€‹äººçš„ã«èˆˆå‘³æ·±ã‹ã£ãŸç®‡æ‰€ãŒã€`[ProxyList]`ã§åˆ—æŒ™ã—ãŸãƒ—ãƒ­æ£‹å£«é”ã‚’ã©ã†æ‰±ã†ã‹ã¨ã„ã£ãŸè¨­å®šã€‚
`dynamic_chain`, `strict_chain`, `random_chain`ã®ã„ãšã‚Œã‹ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã€ãã‚Œãã‚Œã®æŒ™å‹•ã¨ã—ã¦ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚
- `dynamic_chain`
  - è¨­å®šã—ãŸãƒ—ãƒ­ã‚­ã‚·ä¸€è¦§ã‚’é †ç•ªã«åˆ©ç”¨ã™ã‚‹
  - ãƒ€ã‚¦ãƒ³ã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚­ã‚·ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹
- `strict_chain`
  - è¨­å®šã—ãŸãƒ—ãƒ­ã‚­ã‚·ä¸€è¦§ã‚’é †ç•ªã«åˆ©ç”¨ã™ã‚‹
  - ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚­ã‚·ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„
- `random_chain`
  - è¨­å®šã—ãŸãƒ—ãƒ­ã‚­ã‚·ä¸€è¦§ãŒãƒ©ãƒ³ãƒ€ãƒ ã§åˆ©ç”¨ã•ã‚Œã‚‹
  - `this option is good to test your IDS :)`ã£ã¦æ›¸ã„ã¦ã‚ã‚‹

## éŠã‚“ã§ã¿ã‚‹
ã›ã£ã‹ããªã®ã§(?)ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«IPã‚’è¿”ã—ã¦ãã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚‚è‡ªåˆ†ã§ç«‹ã¦ã¦è©¦ã—ã¦ã¿ã‚‹ã€‚
é©å½“ã«Rustã§æ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ã‚’Cloudflare Workersã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãŠãã€‚(è‰²ã€…ã¨é›‘ã§ã™ãŒæ¤œè¨¼ç”¨ã¨ã„ã†ã“ã¨ã§ãŠè¨±ã—ãã ã•ã„)
```rust
#[event(fetch)]
pub async fn main(req: Request, env: Env, _ctx: worker::Context) -> Result<Response> {
    ...
    router
        ...
        .get("/global-ip", |req, ctx| {
            let connecting_ip = match req.headers().get("CF-Connecting-IP") {
                Ok(value) => {
                    match value {
                        Some(connecting_ip) => connecting_ip,
                        None => "Failed to fetch source IP.".to_string(),
                    }
                },
                Err(_) => "Failed to fetch source IP.".to_string(),
            };

            Response::from_json(&json!({ "globalIP": connecting_ip }))
        })
        .run(req, env)
        .await
}
```
ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦å‹•ä½œç¢ºèªã€‚
```
$ wrangler publish
$ curl https://~~~.workers.dev/global-ip
{"globalIP":"~~~.~~~.~~~.~~~"}
```

é©å½“ã«`squid`ã‚’ç«‹ã¦ã¦é€šã™ã‚ˆã†ã«ã—ã¦ã¿ã‚‹ã€‚
```
$ docker run -d --name squid-container -p 3128:3128 ubuntu/squid:latest

# proxychainsã®è¨­å®šã‚’å¤‰æ›´ã—ã¦ãŠã
$ cat /etc/proxychains4.conf
[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
# socks4 	127.0.0.1 9050
http		127.0.0.1 3128  # squidã®ãƒãƒ¼ãƒˆã‚’è¿½åŠ 

$ proxychains curl https://~~~.workers.dev/global-ip
{"globalIP":"~~~.~~~.~~~.~~~"}
```
â¬‡ï¸ `squid`ã®ãƒ­ã‚°ã«ã‚‚å‡ºã¦ã‚‹
```
...
1677407264.464    119 ~~~.~~~.~~~.~~~ TCP_TUNNEL/200 5842 CONNECT ~~~.workers.dev:443 - HIER_DIRECT/~~~.~~~.~~~.~~~-
```
ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’çµŒç”±ã•ã›ã¦ã„ã‚‹ã ã‘ãªã®ã§ãªã‚“ã®ä»£ã‚ã‚Šæ˜ ãˆã‚‚ãªã„ãŒã€ã¨ã‚Šã‚ãˆãšè‡ªåˆ†ã§ç«‹ã¦ãŸãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã§ã‚‚å‹•ã„ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ããŸã€‚
ã‚‚ã¡ã‚ã‚“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã§ç¨¼åƒã•ã›ã‚Œã°ã€Torã®Exitãƒãƒ¼ãƒ‰ã®IPãŒç¢ºèªã§ãã‚‹ã€‚

## ã©ã†ã„ã†ä»•çµ„ã¿ï¼Ÿ
æ¯åº¦ä»•çµ„ã¿ãŒæ°—ã«ãªã‚‹ã®ã§ä¸­èº«ã‚’è¦—ã„ã¦ã¿ã‚‹ã€‚

ãã‚‚ãã‚‚ã€ä½•æ•…`proxychains`ã¨ã„ã†ã‚³ãƒãƒ³ãƒ‰ã«ç¶šã‘ã¦æœ¬æ¥å®Ÿè¡Œã—ãŸã„ã‚³ãƒãƒ³ãƒ‰ã‚’ä¸¦ã¹ã‚‹ã ã‘ã§ã€ãã®ã‚³ãƒãƒ³ãƒ‰ãŒãƒ—ãƒ­ã‚­ã‚·ã‚’çµŒç”±ã™ã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã‹ã€‚(ã‚³ãƒãƒ³ãƒ‰ã‚‚æ”¹å¤‰ã•ã‚Œã¦ãªã„ã—ã€OSã®è¨­å®šã‚‚å¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã®ã«)
çµè«–ã‹ã‚‰è¨€ã†ã¨ã€`proxychains`ã«ã‚ˆã£ã¦`connect`ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚„`gethostbyname`ãªã©ã®å‘¼ã³å‡ºã—ãŒãƒ•ãƒƒã‚¯ã•ã‚Œã€ç‹¬è‡ªã®å‡¦ç†ã«å·®ã—æ›¿ãˆã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã¨ã„ã†ã“ã¨ã«ãªã‚‹ã€‚

### `libproxychains.c`
`proxychains`ã‚³ãƒãƒ³ãƒ‰ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¯`main.c`ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ã‘ã ãŒã€å®Ÿã¯ã“ã“ã‚’è¦‹ã¦ã‚‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å‡¦ç†ã‚„`execvp`ã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œã®å‡¦ç†ã—ã‹ã‹ã‹ã‚Œã¦ã„ãªã„ã€‚
å‰è¿°ã®ã‚ˆã†ãªæŒ™å‹•ã®æœ¬ä½“ã¯ã€å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ãƒ“ãƒ«ãƒ‰ã•ã‚Œã‚‹`libproxychains.c`ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã€‚

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®`do_init`é–¢æ•°ãŒè‚ã§ã€ä¸Šæ›¸ããŸã„å„é–¢æ•°ã®ã‚·ãƒ³ãƒœãƒ«ã«ç‹¬è‡ªã®å‡¦ç†ã‚’ç´ä»˜ã‘ã€å…ƒã€…ã®å‡¦ç†ã‚’`true_`ã‹ã‚‰å§‹ã¾ã‚‹ã‚·ãƒ³ãƒœãƒ«ã«ç´ä»˜ã‘ç›´ã—ã¦ã„ã‚‹ã€‚
`connect`ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã§ã‚ã‚Œã°ãã®å®Ÿæ…‹ã¯`true_connect`ã«ç´ä»˜ã‘ã‚‰ã‚Œã€`connect`ã®å‘¼ã³å‡ºã—ã¯`proxychains`ç‹¬è‡ªã®å‡¦ç†ã«ã™ã’æ›¿ãˆã‚‰ã‚Œã‚‹ã€‚
```c
...
// true_ã‹ã‚‰å§‹ã¾ã‚‹ã‚·ãƒ³ãƒœãƒ«ã®å®šç¾©
extern connect_t true_connect;
extern gethostbyname_t true_gethostbyname;
extern getaddrinfo_t true_getaddrinfo;
extern freeaddrinfo_t true_freeaddrinfo;
...
```

```c
...
// X = connectã®å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç½®æ›ã™ã‚‹ãƒã‚¯ãƒ­
// do { true_connect  = load_sym("connect"); } while(0)
#define SETUP_SYM(X) do { true_ ## X = load_sym( # X, X ); } while(0)

static void do_init(void) {
    ...

    proxychains_write_log(LOG_PREFIX "DLL init\n");
    SETUP_SYM(connect);
    SETUP_SYM(gethostbyname);
    SETUP_SYM(getaddrinfo);
    SETUP_SYM(freeaddrinfo);
    SETUP_SYM(gethostbyaddr);
    SETUP_SYM(getnameinfo);
    ...
}
```

### ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®é¸æŠ
ã¡ãªã¿ã«`random_chain`ã‚„ã‚‰ã®è¨­å®šã§ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’é¸æŠã™ã‚‹éƒ¨åˆ†ã¯ã€`connect`â†’`connect_proxy_chain`ã¨æ¥ã¦ã•ã‚‰ã«ã‚³ãƒ¼ãƒ«ã•ã‚Œã‚‹`select_proxy`ã§è¡Œã‚ã‚Œã¦ã„ã‚‹ã€‚
```rust
static proxy_data *select_proxy(select_type how, proxy_data * pd, unsigned int proxy_count, unsigned int *offset) {
    unsigned int i = 0, k = 0;

    if(*offset >= proxy_count)
        return NULL;
    switch (how) {
        case RANDOMLY:
            do {
                k++;
                // ã“ã®è¾ºã§ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã‚“ã ã‚Šã—ã¦ã„ã‚‹
                i = 0 + get_rand_int(proxy_count);
            } while(pd[i].ps != PLAY_STATE && k < proxy_count * 100);
            break;
        case FIFOLY:
            for(i = *offset; i < proxy_count; i++) {
                if(pd[i].ps == PLAY_STATE) {
                    *offset = i;
                    break;
                }
            }
        default:
            break;
    }
    if(i >= proxy_count)
        i = 0;
    return (pd[i].ps == PLAY_STATE) ? &pd[i] : NULL;
}
```

## è‡ªä½œSOCKS4ã‚µãƒ¼ãƒãƒ¼(é›‘)ã‚’æ›¸ã„ã¦`proxychains`ã‹ã‚‰å©ã‹ã›ã¦ã¿ã‚‹
è‡ªä½œSOCKS4ã‚µãƒ¼ãƒãƒ¼ã‚’é›‘ã«æ›¸ã„ã¦ã¿ã¦`proxychains`ã‹ã‚‰å©ã‹ã›ã¦ã¿ã‚‹ã€‚
SOCKS4ã®RFCãŒè¦‹å½“ãŸã‚‰ãªã‹ã£ãŸã®ã§ã€[Wikipedia](https://en.wikipedia.org/wiki/SOCKS#SOCKS4)ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«èª¬æ˜ã‚’èª­ã¿ãªãŒã‚‰æ›¸ãã€‚

ã¾ãšã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æœ€åˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã‚‹ã¨ã“ã‚ã€‚(ç´°ã‹ã„ã¨ã“ã‚ã¯å‰²æ„›)
```rust
fn handle_client(mut stream: TcpStream) -> std::io::Result<()> {
    let mut buf = [0; 8];
    stream.read(&mut buf)?;

    let mut id = Vec::new();
    loop {
        let mut b = [0; 1];
        stream.read(&mut b)?;
        if b[0] == b'\0' {
            break;
        }
        id.extend_from_slice(&b);
    }

    let req = Request::new(
        buf[0],
        buf[1],
        ((buf[2] as u16) << 8) + buf[3] as u16,
        ((buf[4] as u32) << 24) + ((buf[5] as u32) << 16) + ((buf[6] as u32) << 8) + buf[7] as u32,
        id,
    );
    println!("received: {:02x?}", buf);
    println!("req: {:?}", req);
    ...
```
ä»¥ä¸‹ã®æ§‹é€ ã§é€ã‚‰ã‚ŒãŸãƒã‚¤ãƒˆåˆ—ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã ã‘ã€‚
- ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (1 byte)
- ã‚³ãƒãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ (1 byte)
- è»¢é€å…ˆãƒãƒ¼ãƒˆç•ªå· (2 bytes)
- è»¢é€å…ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ (4 bytes)

æ¬¡ã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã¨ã“ã‚ã€‚(ç´°ã‹ã„ã¨ã“ã‚ã¯å‰²æ„›)
```rust
    ...
    let res = Response::new(
        0x00,
        0x5a,
        0x00,
        req.dst_addr.into(),
    );
    let res_bytes = res.to_bytes();

    println!("transmit: {:02x?}", res_bytes);
    println!("res: {:?}", res);
    stream.write(&res_bytes)?;
    ...
```
ã“ã‚Œã‚‚ä»¥ä¸‹ã®æ§‹é€ ã§æ§‹æˆã—ãŸãƒã‚¤ãƒˆåˆ—ã‚’æµã™ã ã‘ã€‚
- Null 0x00 (1 byte)
- ãƒªãƒ—ãƒ©ã‚¤ã‚³ãƒ¼ãƒ‰ (1 byte)
  - `0x5a`ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿è«¾
  - `0x5b`, `0x5c`, `0x5d`ã§ã‚¨ãƒ©ãƒ¼
- è»¢é€å…ˆãƒãƒ¼ãƒˆç•ªå· (2 bytes)
  - SOCKS4ã§ã¯ã“ã“ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ç„¡è¦–ã•ã‚Œã‚‹ã‚‰ã—ã„ã®ã§ã¶ã£ã¡ã‚ƒã‘å€¤ã¯ä½•ã§ã‚‚è‰¯ã„
- è»¢é€å…ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ (4 bytes)
  - ã“ã“ã‚‚ç„¡è¦–ã•ã‚Œã‚‹

ã“ã“ã¾ã§ãã‚Œã°ã€ã“ã®å…ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸãƒ‡ãƒ¼ã‚¿ã¯è»¢é€å…ˆã®ã‚µãƒ¼ãƒãƒ¼ã«æ¨ªæµã—ã«ã™ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºã«å…¥ã‚‹ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ã‚’ç¹‹ãå¤‰ãˆã¦æµã›ã°ã§ãã‚‹ã®ã‹ã‚‚ã—ã‚Œãªã„ãŒã€ç´°ã‹ã„ã“ã¨ã¯ç½®ã„ã¨ã„ã¦é›‘ã«ã¤ãªãã“ã‚€ã€‚
```rust
    ...
    let mut client = TcpStream::connect(format!("{}:{}", req.dst_addr.to_string(), req.dst_port))?;

    let mut buf = [0; 256];
    stream.read(&mut buf)?;
    client.write(&mut buf)?;

    let mut buf = [0; 256];
    client.read(&mut buf)?;
    stream.write(&mut buf)?;
    ...
```

ã‚ã¨ã¯å®Ÿéš›ã«`proxychains`ã‹ã‚‰å©ã‹ã›ã¦ã¿ã‚‹ã€‚
å…ˆç¨‹ã“ã—ã‚‰ãˆãŸWorkersã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–ã£ã¦ãã¦ã‚‚è‰¯ã„ã®ã ãŒã€åå‰è§£æ±ºã¾ã§å®Ÿè£…ã™ã‚‹ã®ãŒã‚ã‚“ã©ãã•ã„ + Workersã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã«IPã§ç›´ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„ã®ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ã«é©å½“ã«ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã¦ãã“ã«è»¢é€ã•ã›ã‚‹ã“ã¨ã«ã™ã‚‹ã€‚
```
# è»¢é€å…ˆã®ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
$ touch ./proxy-test.html
$ echo 'This is on the super awesome http server.' > ./proxy-test.html
$ python -m http.server 9000

# è‡ªä½œSOCKSã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
$ cargo run

# proxychainsã®è¨­å®šã‚’å¤‰æ›´ã—ã¦ãŠã(åå‰è§£æ±ºã‚’ãƒ—ãƒ­ã‚­ã‚·ã•ã›ãªã„ + ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’è¿½åŠ )
$ cat /etc/proxychains4.conf
...
[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
# socks4 	127.0.0.1 9050
socks4		127.0.0.1 11111  # è‡ªä½œSOCKS4ã‚µãƒ¼ãƒãƒ¼

# ã¾ãšã¯æ™®é€šã«å©ã„ã¦ã¿ã‚‹ (ã•ã£ãä½œã£ãŸãƒ†ã‚¹ãƒˆç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆãŒè¿”ã£ã¦ãã‚‹ã ã‘)
$ curl http://127.0.0.1:9000/proxy-test.html
This is on the super awesome http server.

# proxychainså®Ÿè¡Œ
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.16
[proxychains] Strict chain  ...  127.0.0.1:11111  ...  127.0.0.1:9000  ...  OK
This is on the super http server.
```
é€šã£ãŸã€‚

# æœ€å¾Œã«
ãƒ—ãƒ­ã‚­ã‚·ãŠã‚‚ã‚ã„ã€‚
ã“ã‚Œã§ä¼‘ã¿ã®æ—¥ã¯SOCKS4ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚‚ã©ãã‚’ä½œã£ã¦ã¾ã—ãŸã¨ã„ã†ã“ã¨ãŒã§ãã¾ã™ã€‚
